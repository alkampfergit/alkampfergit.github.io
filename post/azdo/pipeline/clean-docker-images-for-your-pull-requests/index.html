<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='If you automatically creates docker images for Pull Requests, it is quite important that you automate cleanup of these images to avoid filling your docker registry with unused images.'><meta name=theme-color content='#ffcd00'><meta property='og:title' content='Azure DevOps: Cleanup Docker images for your Pull Requests • Codewrecks'><meta property='og:description' content='If you automatically creates docker images for Pull Requests, it is quite important that you automate cleanup of these images to avoid filling your docker registry with unused images.'><meta property='og:url' content='https://www.codewrecks.com/post/azdo/pipeline/clean-docker-images-for-your-pull-requests/'><meta property='og:site_name' content='Codewrecks'><meta property='og:type' content='article'><meta property='article:section' content='post'><meta property='article:tag' content='AzDo'><meta property='article:published_time' content='2024-07-09T07:00:42Z'><meta property='article:modified_time' content='2024-07-09T07:00:42Z'><meta name=twitter:card content='summary'><meta name=generator content="Hugo 0.128.0"><title>Azure DevOps: Cleanup Docker images for your Pull Requests • Codewrecks</title>
<link rel=canonical href=https://www.codewrecks.com/post/azdo/pipeline/clean-docker-images-for-your-pull-requests/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-JNG3CSWEQT"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JNG3CSWEQT")</script></head><body class='page type-post has-sidebar'><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu>Skip to Main Menu</a><div class=container><section class='widget widget-about sep-after'><header><div class=logo><a href=/><img src=/images/logo.png></a></div><h2 class='title site-title'><a href=/>Codewrecks</a></h2><div class=desc>Wrecks of code floating in the sea of internet</div></header></section><section class='widget widget-sidebar_menu sep-after'><nav id=sidebar-menu class='menu sidebar-menu' aria-label='Sidebar Menu'><div class=container><ul><li class=item><a href=/>Home</a></li></ul></div></nav></section><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6590055118491660" crossorigin=anonymous></script><section class='widget widget-taxonomy_cloud sep-after'><header><h4 class='title widget-title'>Tags</h4></header><div class='container list-container'><ul class='list taxonomy-cloud'><li><a href=/tags/actions/ style=font-size:1.0078740157480315em>Actions</a></li><li><a href=/tags/addin/ style=font-size:1.0078740157480315em>Addin</a></li><li><a href=/tags/agile/ style=font-size:1.0236220472440944em>Agile</a></li><li><a href=/tags/ai/ style=font-size:1.015748031496063em>AI</a></li><li><a href=/tags/alm/ style=font-size:1.0629921259842519em>ALM</a></li><li><a href=/tags/aop/ style=font-size:1.0236220472440944em>Aop</a></li><li><a href=/tags/api/ style=font-size:1.1181102362204725em>API</a></li><li><a href=/tags/applicationinsights/ style=font-size:1.0236220472440944em>ApplicationInsights</a></li><li><a href=/tags/architecture/ style=font-size:1.1023622047244095em>Architecture</a></li><li><a href=/tags/architecture-castle/ style=font-size:1.0078740157480315em>Architecture Castle</a></li><li><a href=/tags/aspnet/ style=font-size:1.3700787401574803em>Aspnet</a></li><li><a href=/tags/aspnet-mvc/ style=font-size:1.031496062992126em>AspNet MVC</a></li><li><a href=/tags/automation/ style=font-size:1.0078740157480315em>Automation</a></li><li><a href=/tags/azdo/ style=font-size:1.2283464566929134em>AzDo</a></li><li><a href=/tags/azure/ style=font-size:1.0866141732283465em>Azure</a></li><li><a href=/tags/azure-devops/ style=font-size:1.110236220472441em>Azure Devops</a></li><li><a href=/tags/azure-pipelines/ style=font-size:1.031496062992126em>Azure Pipelines</a></li><li><a href=/tags/azuredevops/ style=font-size:1.1023622047244095em>AzureDevOps</a></li><li><a href=/tags/backup/ style=font-size:1.0078740157480315em>Backup</a></li><li><a href=/tags/blend/ style=font-size:1.0078740157480315em>Blend</a></li><li><a href=/tags/blog/ style=font-size:1.0078740157480315em>Blog</a></li><li><a href=/tags/blogging/ style=font-size:1.0551181102362204em>Blogging</a></li><li><a href=/tags/books/ style=font-size:1.015748031496063em>Books</a></li><li><a href=/tags/branch/ style=font-size:1em>Branch</a></li><li><a href=/tags/build/ style=font-size:1.5984251968503937em>Build</a></li><li><a href=/tags/c/ style=font-size:1.0078740157480315em>C</a></li><li><a href=/tags/castle/ style=font-size:1.236220472440945em>Castle</a></li><li><a href=/tags/chatgpt/ style=font-size:1.0078740157480315em>ChatGPT</a></li><li><a href=/tags/clickonce/ style=font-size:1.0236220472440944em>ClickOnce</a></li><li><a href=/tags/codeanalysis/ style=font-size:1.0078740157480315em>CodeAnalysis</a></li><li><a href=/tags/codespaces/ style=font-size:1.031496062992126em>Codespaces</a></li><li><a href=/tags/continuos-integration/ style=font-size:1.031496062992126em>Continuos Integration</a></li><li><a href=/tags/continuous-deployment/ style=font-size:1.0393700787401574em>Continuous Deployment</a></li><li><a href=/tags/continuous-integration/ style=font-size:1.0866141732283465em>Continuous Integration</a></li><li><a href=/tags/continuousdeployment/ style=font-size:1.0551181102362204em>ContinuousDeployment</a></li><li><a href=/tags/copilot/ style=font-size:1.015748031496063em>Copilot</a></li><li><a href=/tags/cqrs/ style=font-size:1.0078740157480315em>CQRS</a></li><li><a href=/tags/datadude/ style=font-size:1.0393700787401574em>DataDude</a></li><li><a href=/tags/datagrid/ style=font-size:1.0078740157480315em>DataGrid</a></li><li><a href=/tags/ddd/ style=font-size:1.1181102362204725em>DDD</a></li><li><a href=/tags/debugging/ style=font-size:1.0078740157480315em>Debugging</a></li><li><a href=/tags/developing/ style=font-size:1em>Developing</a></li><li><a href=/tags/devops/ style=font-size:1.1181102362204725em>Devops</a></li><li><a href=/tags/docker/ style=font-size:1.0078740157480315em>Docker</a></li><li><a href=/tags/dotnet/ style=font-size:1em>Dotnet</a></li><li><a href=/tags/ef/ style=font-size:1.0078740157480315em>EF</a></li><li><a href=/tags/ef-code-first/ style=font-size:1.031496062992126em>EF Code First</a></li><li><a href=/tags/ef41/ style=font-size:1.0236220472440944em>EF41</a></li><li><a href=/tags/ef5/ style=font-size:1.015748031496063em>EF5</a></li><li><a href=/tags/enterprise-library/ style=font-size:1.0236220472440944em>Enterprise Library</a></li><li><a href=/tags/entity-framework/ style=font-size:1.094488188976378em>Entity Framework</a></li><li><a href=/tags/everydaylife/ style=font-size:1.047244094488189em>EverydayLife</a></li><li><a href=/tags/excel/ style=font-size:1.0078740157480315em>Excel</a></li><li><a href=/tags/experiences/ style=font-size:1.2440944881889764em>Experiences</a></li><li><a href=/tags/frameworks/ style=font-size:1.0629921259842519em>Frameworks</a></li><li><a href=/tags/general/ style=font-size:2em>General</a></li><li><a href=/tags/git/ style=font-size:1.2283464566929134em>Git</a></li><li><a href=/tags/git-tf/ style=font-size:1.0078740157480315em>Git-Tf</a></li><li><a href=/tags/github/ style=font-size:1.236220472440945em>Github</a></li><li><a href=/tags/github-actions/ style=font-size:1.0236220472440944em>GitHub Actions</a></li><li><a href=/tags/gpt4/ style=font-size:1em>GPT4</a></li><li><a href=/tags/hacking/ style=font-size:1em>Hacking</a></li><li><a href=/tags/hardware/ style=font-size:1.031496062992126em>Hardware</a></li><li><a href=/tags/homelab/ style=font-size:1em>HomeLab</a></li><li><a href=/tags/hql/ style=font-size:1.0078740157480315em>HQL</a></li><li><a href=/tags/html/ style=font-size:1.0078740157480315em>Html</a></li><li><a href=/tags/hugo/ style=font-size:1em>Hugo</a></li><li><a href=/tags/icriteria/ style=font-size:1.0078740157480315em>ICriteria</a></li><li><a href=/tags/iis/ style=font-size:1.015748031496063em>IIS</a></li><li><a href=/tags/ioc/ style=font-size:1.015748031496063em>IoC</a></li><li><a href=/tags/javascript/ style=font-size:1.0078740157480315em>Javascript</a></li><li><a href=/tags/jquery/ style=font-size:1.047244094488189em>JQuery</a></li><li><a href=/tags/lab-management/ style=font-size:1.1023622047244095em>Lab Management</a></li><li><a href=/tags/languages/ style=font-size:1.0551181102362204em>Languages</a></li><li><a href=/tags/linq/ style=font-size:1.204724409448819em>LINQ</a></li><li><a href=/tags/linux/ style=font-size:1.0551181102362204em>Linux</a></li><li><a href=/tags/log4net/ style=font-size:1.047244094488189em>Log4net</a></li><li><a href=/tags/lucene/ style=font-size:1.0629921259842519em>Lucene</a></li><li><a href=/tags/macro/ style=font-size:1.0236220472440944em>Macro</a></li><li><a href=/tags/masstransit/ style=font-size:1.015748031496063em>Masstransit</a></li><li><a href=/tags/mef/ style=font-size:1.0236220472440944em>MEF</a></li><li><a href=/tags/metroui/ style=font-size:1.0078740157480315em>MetroUi</a></li><li><a href=/tags/microsoft-test-manager/ style=font-size:1.015748031496063em>Microsoft Test Manager</a></li><li><a href=/tags/mms/ style=font-size:1.015748031496063em>Mms</a></li><li><a href=/tags/mongo/ style=font-size:1.0236220472440944em>Mongo</a></li><li><a href=/tags/mongodb/ style=font-size:1.1574803149606299em>MongoDb</a></li><li><a href=/tags/msbuild/ style=font-size:1.031496062992126em>Msbuild</a></li><li><a href=/tags/mstest/ style=font-size:1.0078740157480315em>MsTest</a></li><li><a href=/tags/mvvm/ style=font-size:1.0708661417322836em>MVVM</a></li><li><a href=/tags/nablasoft/ style=font-size:1.0236220472440944em>Nablasoft</a></li><li><a href=/tags/ndepend/ style=font-size:1.0236220472440944em>NDepend</a></li><li><a href=/tags/net/ style=font-size:1.0236220472440944em>Net</a></li><li><a href=/tags/net-core/ style=font-size:1.0078740157480315em>NET Core</a></li><li><a href=/tags/net-framework/ style=font-size:1.5118110236220472em>NET Framework</a></li><li><a href=/tags/netcore/ style=font-size:1.0236220472440944em>NETCORE</a></li><li><a href=/tags/nhibernate/ style=font-size:1.5039370078740157em>Nhibernate</a></li><li><a href=/tags/nosql/ style=font-size:1.0629921259842519em>NoSql</a></li><li><a href=/tags/nsm/ style=font-size:1em>Nsm</a></li><li><a href=/tags/nuget/ style=font-size:1.0393700787401574em>Nuget</a></li><li><a href=/tags/nunit/ style=font-size:1.0393700787401574em>Nunit</a></li><li><a href=/tags/office/ style=font-size:1.0236220472440944em>Office</a></li><li><a href=/tags/oidc/ style=font-size:1em>OIDC</a></li><li><a href=/tags/oop/ style=font-size:1.0236220472440944em>OOP</a></li><li><a href=/tags/openxml/ style=font-size:1.0078740157480315em>OpenXml</a></li><li><a href=/tags/orm/ style=font-size:1.0236220472440944em>ORM</a></li><li><a href=/tags/performance/ style=font-size:1.0393700787401574em>Performance</a></li><li><a href=/tags/pgp/ style=font-size:1em>PGP</a></li><li><a href=/tags/pills/ style=font-size:1.236220472440945em>Pills</a></li><li><a href=/tags/pipeline/ style=font-size:1.0866141732283465em>Pipeline</a></li><li><a href=/tags/pipelines/ style=font-size:1.015748031496063em>Pipelines</a></li><li><a href=/tags/plugin/ style=font-size:1.031496062992126em>Plugin</a></li><li><a href=/tags/power-tools/ style=font-size:1.0236220472440944em>Power Tools</a></li><li><a href=/tags/powershell/ style=font-size:1.110236220472441em>PowerShell</a></li><li><a href=/tags/process-template/ style=font-size:1.047244094488189em>Process Template</a></li><li><a href=/tags/programming/ style=font-size:1.1496062992125984em>Programming</a></li><li><a href=/tags/pull-requests/ style=font-size:1.015748031496063em>Pull Requests</a></li><li><a href=/tags/pullrequests/ style=font-size:1em>PullRequests</a></li><li><a href=/tags/python/ style=font-size:1.015748031496063em>Python</a></li><li><a href=/tags/ravendb/ style=font-size:1.031496062992126em>RavenDB</a></li><li><a href=/tags/release/ style=font-size:1.047244094488189em>Release</a></li><li><a href=/tags/resharper/ style=font-size:1.0236220472440944em>Resharper</a></li><li><a href=/tags/rest-api/ style=font-size:1em>REST Api</a></li><li><a href=/tags/rest-apis/ style=font-size:1.0236220472440944em>Rest APIs</a></li><li><a href=/tags/rhinomock/ style=font-size:1.0078740157480315em>RhinoMock</a></li><li><a href=/tags/scrum/ style=font-size:1.0078740157480315em>Scrum</a></li><li><a href=/tags/searching/ style=font-size:1.0393700787401574em>Searching</a></li><li><a href=/tags/security/ style=font-size:1.3700787401574803em>Security</a></li><li><a href=/tags/semantickernel/ style=font-size:1em>SemanticKernel</a></li><li><a href=/tags/shim/ style=font-size:1.0078740157480315em>Shim</a></li><li><a href=/tags/silverlight/ style=font-size:1.015748031496063em>Silverlight</a></li><li><a href=/tags/software-architecture/ style=font-size:1.125984251968504em>Software Architecture</a></li><li><a href=/tags/solr/ style=font-size:1.0551181102362204em>Solr</a></li><li><a href=/tags/sonarcloud/ style=font-size:1.0078740157480315em>Sonarcloud</a></li><li><a href=/tags/sonarqube/ style=font-size:1.0551181102362204em>Sonarqube</a></li><li><a href=/tags/source-control/ style=font-size:1em>Source Control</a></li><li><a href=/tags/springnet/ style=font-size:1em>SpringNET</a></li><li><a href=/tags/sql-server/ style=font-size:1.236220472440945em>Sql Server</a></li><li><a href=/tags/ssd/ style=font-size:1.047244094488189em>SSD</a></li><li><a href=/tags/symbols/ style=font-size:1em>Symbols</a></li><li><a href=/tags/team-foundation-server/ style=font-size:1.425196850393701em>Team Foundation Server</a></li><li><a href=/tags/teamfoundationserver/ style=font-size:1.0236220472440944em>TeamFoundationServer</a></li><li><a href=/tags/terraform/ style=font-size:1em>Terraform</a></li><li><a href=/tags/test/ style=font-size:1.0078740157480315em>Test</a></li><li><a href=/tags/testing/ style=font-size:1.5511811023622046em>Testing</a></li><li><a href=/tags/tfs/ style=font-size:1.84251968503937em>Tfs</a></li><li><a href=/tags/tfs-build/ style=font-size:1.236220472440945em>TFS Build</a></li><li><a href=/tags/tfs-power-tools/ style=font-size:1.0078740157480315em>Tfs Power Tools</a></li><li><a href=/tags/tfs-service/ style=font-size:1.0078740157480315em>Tfs Service</a></li><li><a href=/tags/tfs11/ style=font-size:1em>TFS11</a></li><li><a href=/tags/tfsapi/ style=font-size:1.031496062992126em>TfsAPI</a></li><li><a href=/tags/tfsbuild/ style=font-size:1.0629921259842519em>TfsBuild</a></li><li><a href=/tags/tfvc/ style=font-size:1.0078740157480315em>TFVC</a></li><li><a href=/tags/tika/ style=font-size:1.0236220472440944em>Tika</a></li><li><a href=/tags/tls/ style=font-size:1.0078740157480315em>TLS</a></li><li><a href=/tags/tools/ style=font-size:1.0078740157480315em>Tools</a></li><li><a href=/tags/tools-and-library/ style=font-size:1.1338582677165354em>Tools and Library</a></li><li><a href=/tags/tryhackme/ style=font-size:1em>TryHackMe</a></li><li><a href=/tags/uat/ style=font-size:1.015748031496063em>UAT</a></li><li><a href=/tags/ubuntu/ style=font-size:1em>Ubuntu</a></li><li><a href=/tags/unit-testing/ style=font-size:1.047244094488189em>Unit Testing</a></li><li><a href=/tags/unittesting/ style=font-size:1em>UnitTesting</a></li><li><a href=/tags/upgrade/ style=font-size:1em>Upgrade</a></li><li><a href=/tags/vcs/ style=font-size:1.015748031496063em>VCS</a></li><li><a href=/tags/virtual-machine/ style=font-size:1.031496062992126em>Virtual Machine</a></li><li><a href=/tags/visual-studio/ style=font-size:1.3307086614173227em>Visual Studio</a></li><li><a href=/tags/visual-studio-2013/ style=font-size:1.0078740157480315em>Visual Studio 2013</a></li><li><a href=/tags/visual-studio-alm/ style=font-size:1.1732283464566928em>Visual Studio ALM</a></li><li><a href=/tags/visual-studio-database-edition/ style=font-size:1.031496062992126em>Visual Studio Database Edition</a></li><li><a href=/tags/visualstudio/ style=font-size:1.0078740157480315em>VisualStudio</a></li><li><a href=/tags/vnext/ style=font-size:1.0551181102362204em>VNext</a></li><li><a href=/tags/vs11/ style=font-size:1.0236220472440944em>VS11</a></li><li><a href=/tags/vs2010/ style=font-size:1.0078740157480315em>VS2010</a></li><li><a href=/tags/vs2012/ style=font-size:1.031496062992126em>VS2012</a></li><li><a href=/tags/vsalm/ style=font-size:1.015748031496063em>VSAlm</a></li><li><a href=/tags/vso/ style=font-size:1.0708661417322836em>VSO</a></li><li><a href=/tags/vsts/ style=font-size:1.2913385826771653em>VSTS</a></li><li><a href=/tags/vstsdbedition/ style=font-size:1.0078740157480315em>VSTSDBEdition</a></li><li><a href=/tags/wcf/ style=font-size:1.125984251968504em>Wcf</a></li><li><a href=/tags/wcf-iis7/ style=font-size:1.0078740157480315em>WCF IIS7</a></li><li><a href=/tags/web-test/ style=font-size:1.015748031496063em>Web Test</a></li><li><a href=/tags/webbrowser/ style=font-size:1.015748031496063em>WebBrowser</a></li><li><a href=/tags/windows/ style=font-size:1.031496062992126em>Windows</a></li><li><a href=/tags/winforms/ style=font-size:1.0236220472440944em>Winforms</a></li><li><a href=/tags/work-item-tracking/ style=font-size:1em>Work Item Tracking</a></li><li><a href=/tags/workflow/ style=font-size:1.0236220472440944em>Workflow</a></li><li><a href=/tags/wpf/ style=font-size:1.3937007874015748em>WPF</a></li><li><a href=/tags/wsl/ style=font-size:1em>WSL</a></li><li><a href=/tags/wsl2/ style=font-size:1em>Wsl2</a></li><li><a href=/tags/xaml/ style=font-size:1.015748031496063em>XAML</a></li><li><a href=/tags/yaml/ style=font-size:1em>YAML</a></li><li><a href=/tags/zero-trust-security/ style=font-size:1.0078740157480315em>Zero Trust Security</a></li></ul></div></section></div><div class=sidebar-overlay></div></div><div class=main><nav id=main-menu class='menu main-menu' aria-label='Main Menu'><div class=container><a class=screen-reader-text href=#content>Skip to Content</a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text>Toggle Sidebar</span>
<span class=open><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</span><span class=close><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/git-videos/>Git Videos</a></li><li class=item><a href=/privacy/>Privacy</a></li><li class=item><a href=/youtube/>YouTube</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class='widget widget-breadcrumbs sep-after'><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Azure DevOps: Cleanup Docker images for your Pull Requests</span></li></ol></nav></section></div></div><header id=header class='header site-header'><div class='container sep-after'><div class=header-info><p class='site-title title'>Codewrecks</p><p class='desc site-desc'>Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class='header entry-header'><div class='container sep-after'><div class=header-info><h1 class=title>Azure DevOps: Cleanup Docker images for your Pull Requests</h1><p class=desc>If you automatically creates docker images for Pull Requests, it is quite important that you automate cleanup of these images to avoid filling your docker registry with unused images.</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<span class=screen-reader-text>Posted on </span><time class=entry-date datetime=2024-07-09T07:00:42Z>2024, Jul 09</time>
</span><span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>
5 mins read</span></div></div></header><div class='container entry-content'><p>This article is a prosecution of <a href=https://www.codewrecks.com/post/azdo/pipeline/build-and-create-docker-for-your-pr/>the previous one on creating Docker Images for your Pull Requests</a> and deals with cleanup of your Docker Registry.</p><h2 id=authentication-to-azure>Authentication to Azure</h2><p>In Azure DevOps you can use connected services to connect to Azure Accounts or external services, but since I&rsquo;m using mainly PowerShell scripts inside my repository, <strong>I often prefer using a Service Principal</strong>. This is a good practice because you can limit the access of the service principal to only the resources it needs to access, and you can revoke the access at any time.</p><p>To create a service principal you can simply <strong>create an App Registration in your Azure Entra administration portal</strong>. Then you only need to create a secret for the application that will constitute the password of the service principal.</p><p><a target=_blank href=../images/entra-applications.png><img src=../images/entra-applications.png alt="Create an Entra application"></a></p><p><em><strong>Figure 1:</strong></em> <em>Create an Entra application</em></p><p>I like service principals because they starts having <strong>no permission and then you can go to various resources and start adding Roles to the principal based on the resource you want it to access</strong>. In this example I&rsquo;ve created a single service principal that I&rsquo;m using for all my Azure DevOps basic pipeline, but you can create how many you want.</p><blockquote><p>Using a service principal gives me two advantage, granularity of access and being able to manage everything from Azure Portal.</p></blockquote><h2 id=the-script>The script</h2><p>The script to cleanup resources is really simple, it starts authenticating to Azure with Service Principal and then get a reference for <strong>all images inside that container registry</strong>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Connect to Azure</span>
</span></span><span style=display:flex><span>$SecurePassword = ConvertTo-SecureString -String $secret -AsPlainText -Force
</span></span><span style=display:flex><span>$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $ApplicationId, $SecurePassword
</span></span><span style=display:flex><span>Connect-AzAccount -ServicePrincipal -TenantId $TenantId -Credential $Credential
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get all images in the container registry</span>
</span></span><span style=display:flex><span>$images = Get-AzContainerRegistryRepository -RegistryName $registryName</span></span></code></pre></td></tr></table></div></div><p>As you can see I need to pass ApplicationId and TenantId of the Service Principal (the entra application) I&rsquo;ve created and then converting the secret to a secure string to create a credential object. <strong>Then I simply connect to Azure with the service principal</strong>. If everything is ok you will seee a message and then the call to Get-AzContainerRegistryRepository succeeds.</p><p>Now it is time to list all the tag, for all tag that have the form PRxxxx <strong>extract pull request number and then check the status of the pull request on Azure DevOps</strong>. If the pull request is not active, I can safely delete the image.</p><p>First of all I define a function to <strong>get the status of a pull request</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#66d9ef>function</span> Get-PullRequestStatus {
</span></span><span style=display:flex><span>    [CmdletBinding()]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>param</span> (
</span></span><span style=display:flex><span>        [Parameter(<span style=color:#a6e22e>Mandatory</span>=$true)]
</span></span><span style=display:flex><span>        [<span style=color:#66d9ef>string</span>]$PrId
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $url = <span style=color:#e6db74>&#34;</span>$organizationUrl<span style=color:#e6db74>/</span>$project<span style=color:#e6db74>/_apis/git/pullrequests/</span>$($PrId)<span style=color:#e6db74>?api-version=6.0&#34;</span>
</span></span><span style=display:flex><span>    $base64AuthInfo = [<span style=color:#66d9ef>Convert</span>]::ToBase64String([<span style=color:#66d9ef>Text.Encoding</span>]::ASCII.GetBytes(<span style=color:#e6db74>&#34;:</span>$($pat)<span style=color:#e6db74>&#34;</span>))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        $response = Invoke-RestMethod -Uri $url -Headers @{Authorization=(<span style=color:#e6db74>&#34;Basic {0}&#34;</span> <span style=color:#f92672>-f</span> $base64AuthInfo)} -Method Get
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $response.status
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>        Write-Warning <span style=color:#e6db74>&#34;Failed to retrieve PR status for PR </span>$PrId<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $null
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>This function is declared inside the main script, it works <strong>with a Personal Access Token contained in $pat variable and also it uses the organizationUrl and project variables</strong>. This function simply calls the Azure DevOps REST API to get the status of a pull request.</p><p>Given this function the script can enumerate <strong>all the tags and delete those one that are not bound to an Active Pull Request</strong>.</p><blockquote><p>Thanks to a simple RegEx we can identify all Docker Images bound to a Pull Request, and delete them if the correspoinding Pull Requests are not active.</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#66d9ef>foreach</span> ($image <span style=color:#66d9ef>in</span> $images) {
</span></span><span style=display:flex><span>    Write-Host <span style=color:#e6db74>&#34;Checking image </span>$image<span style=color:#e6db74> for PR pattern.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $tags = Get-AzContainerRegistryTag -RegistryName $registryName -RepositoryName $image
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> ($tag <span style=color:#66d9ef>in</span> $tags.Tags) {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Checking tag </span>$($tag.Name)<span style=color:#e6db74> for image </span>$image<span style=color:#e6db74> for presence of PR pattern&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($tag.Name <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#39;^PR(\d+)&#39;</span>) {
</span></span><span style=display:flex><span>            $prId = $matches[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            $prStatus = Get-PullRequestStatus -PrId $prId
</span></span><span style=display:flex><span>            Write-Host <span style=color:#e6db74>&#34;Image tag </span>$($tag.Name)<span style=color:#e6db74> matches Pull Request pattern with PR ID </span>$prId<span style=color:#e6db74> for image </span>$image<span style=color:#e6db74> with status </span>$prStatus<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ($prStatus <span style=color:#f92672>-eq</span> $null) {
</span></span><span style=display:flex><span>                Write-Host <span style=color:#e6db74>&#34;Failed to retrieve PR status for PR </span>$prId<span style=color:#e6db74>. Skipping tag </span>$($tag.Name)<span style=color:#e6db74> for image </span>$image<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                $preservedImages += <span style=color:#e6db74>&#34;</span>$image<span style=color:#e6db74>`:</span>$($tag.Name)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ($prStatus <span style=color:#f92672>-ne</span> <span style=color:#e6db74>&#34;active&#34;</span>) {
</span></span><span style=display:flex><span>                Write-Host <span style=color:#e6db74>&#34;Deleting tag </span>$($tag.Name)<span style=color:#e6db74> for image </span>$image<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># Uncomment the following line to actually delete the tag</span>
</span></span><span style=display:flex><span>                Remove-AzContainerRegistryTag -RegistryName $registryName -RepositoryName $image -Name $tag.Name
</span></span><span style=display:flex><span>                $deletedImages += <span style=color:#e6db74>&#34;</span>$image<span style=color:#e6db74>`:</span>$($tag.Name)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                Write-Host <span style=color:#e6db74>&#34;Keeping tag </span>$($tag.Name)<span style=color:#e6db74> for image </span>$image<span style=color:#e6db74> (PR status: </span>$prStatus<span style=color:#e6db74>)&#34;</span>
</span></span><span style=display:flex><span>                $preservedImages += <span style=color:#e6db74>&#34;</span>$image<span style=color:#e6db74>`:</span>$($tag.Name)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            Write-Host <span style=color:#e6db74>&#34;Tag </span>$($tag.Name)<span style=color:#e6db74> for image </span>$image<span style=color:#e6db74> does not match Pull Request pattern&#34;</span>
</span></span><span style=display:flex><span>            $preservedImages += <span style=color:#e6db74>&#34;</span>$image<span style=color:#e6db74>`:</span>$($tag.Name)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>This allows me to print a nice output like this one.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Summary:
</span></span><span style=display:flex><span>Deleted Images:
</span></span><span style=display:flex><span>  jarvis:PR3571-test
</span></span><span style=display:flex><span>  jarvis:PR3571-test-arm
</span></span><span style=display:flex><span>  jarvis:PR3574-test
</span></span><span style=display:flex><span>  jarvis:PR3574-test-arm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Preserved Images:
</span></span><span style=display:flex><span>  jarvis:5.32.0-develop
</span></span><span style=display:flex><span>  jarvis:5.32.0-develop-arm
</span></span><span style=display:flex><span>  jarvis:PR3561-test
</span></span><span style=display:flex><span>  jarvis:PR3561-test-arm
</span></span><span style=display:flex><span>  jarvis:PR3565-test
</span></span><span style=display:flex><span>  jarvis:PR3565-test-arm
</span></span><span style=display:flex><span>  jarvis:PR3589-test
</span></span><span style=display:flex><span>  jarvis:PR3589-test-arm
</span></span><span style=display:flex><span>  jarvis_base:arm
</span></span><span style=display:flex><span>  jarvis_base:arm-test
</span></span><span style=display:flex><span>  jarvis_base:latest
</span></span><span style=display:flex><span>  jarvis_base:test
</span></span><span style=display:flex><span>  jarvisautomation:arm
</span></span><span style=display:flex><span>  jarvisautomation:latest</span></span></code></pre></td></tr></table></div></div><p>Now you can schedule this script to run every night with a simple Azure DevOps pipeline.</p><blockquote><p>Once you have a PowerShell script that performs some maintenance, the easiest way to schedule it is to create a pipeline that runs the script at a specific time.</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>trigger</span>: <span style=color:#ae81ff>none</span>
</span></span><span style=display:flex><span><span style=color:#f92672>pr</span>: <span style=color:#ae81ff>none </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>schedules</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>cron</span>: <span style=color:#e6db74>&#34;0 23 * * *&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Nightly cleanup</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>always</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>include</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>develop </span> <span style=color:#75715e># or your default branch name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>cleanup_pr_images</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Execute cleanup script&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pool</span>: <span style=color:#ae81ff>fast</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>checkout</span>: <span style=color:#ae81ff>self</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>clean</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>fetchDepth</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Docker@2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerRegistry</span>: <span style=color:#e6db74>&#39;Nebula&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#39;login&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#39;Login to nebula repository&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>PowerShell@2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>filePath</span>: <span style=color:#e6db74>&#39;docker/pr-docker-cleaner.ps1&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>arguments</span>:  -<span style=color:#ae81ff>pat $(System.AccessToken) -applicationId xxxxx -tenantId xxxxx -secret $(appsecret)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#39;Cleanup script&#39;</span></span></span></code></pre></td></tr></table></div></div><p>This pipeline runs on a special repository called <strong>SetupScript</strong> where we stored all setup and build script related to release. As you can see we can simply use the $(System.AccessToken) to access the Azure DevOps REST API with standard pipeline permission. The secret for the Service Principal is stored in a variable called appsecret.</p><p>This allows us to create how many images we need for our Pull Requests without the risk of filling the Docker Registry with unused images.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class='container sep-before'><div class=last-updated><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20 14.66V20a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h5.34"/><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"/></svg>
<span class=screen-reader-text>Last updated: </span><time class=entry-date datetime=2024-07-09T07:00:42Z>2024, Jul 09</time></div><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg>
<span class=screen-reader-text>Categories: </span><a class=category href=/categories/azuredevops/>AzureDevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=screen-reader-text>Tags: </span><a class=tag href=/tags/azdo/>AzDo</a></div></div></footer></article><nav class=entry-nav><div class=container><div class='prev-entry sep-before'>Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class='prev-entry sep-before'><a href=/post/azdo/pipeline/build-and-create-docker-for-your-pr/><span aria-hidden=true>Previous</span>
<span class=screen-reader-text>Previous post: </span>Azure DevOps: Create Docker images for a Pull Request</a></div><div class='next-entry sep-before'><a href=/post/azdo/pills/connect-azdo-to-external-software/><span class=screen-reader-text>Next post: </span>Pills: Connect Azdo to external software<span aria-hidden=true>Next</span></a></div></div></nav></main><footer id=footer class=footer><div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'><ul><li><a href=https://github.com/alkampfergit target=_blank rel='noopener me'><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel='noopener me'><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel='noopener me'><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel='noopener me'><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2025 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law"),$(document).euCookieLawPopup().init({cookiePolicyUrl:"/privacy/",popupPosition:"top",colorStyle:"default",compactStyle:!1,popupTitle:"This website is using cookies",popupText:"By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.",buttonContinueTitle:"Continue",buttonLearnmoreTitle:"Learn more about this site Privacy &amp; Cookies Policy",buttonLearnmoreOpenInNewWindow:!0,agreementExpiresInDays:30,autoAcceptCookiePolicy:!1,htmlMarkup:null})</script></body></html>