<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Terraform is a really nice product that helps you to automate provisioning of Cloud infrastructure, lets have a quick look at it"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Hello terraform • Codewrecks"><meta property="og:description" content="Terraform is a really nice product that helps you to automate provisioning of Cloud infrastructure, lets have a quick look at it"><meta property="og:url" content="https://www.codewrecks.com/post/devops/terraform-hello-world/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Azure"><meta property="article:tag" content="terraform"><meta property="article:published_time" content="2021-04-03T07:00:18+02:00"><meta property="article:modified_time" content="2021-04-03T07:00:18+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Hello terraform • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/devops/terraform-hello-world/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Hello terraform</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Hello terraform</h1><p class=desc>Terraform is a really nice product that helps you to automate provisioning of Cloud infrastructure, lets have a quick look at it</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2021-04-03T07:00:18+02:00>2021, Apr 03</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>10 mins read</span></div></div></header><div class="container entry-content"><p>I&rsquo;m studying <a href=https://www.oreilly.com/library/view/terraform-up/9781492046899/>Terraform Up and Running</a> book, a really good book but all the examples are for AWS. I have nothing against AWS, but I&rsquo;m familiar with Azure, so I&rsquo;d like to <strong>start porting some of the example of the book for Azure</strong>. While I&rsquo;m not sure if I&rsquo;ll keep up with the conversion, if you are curious I&rsquo;ve started the work <a href=https://github.com/AlkampferOpenSource/terraform-up-and-running-code/tree/master/code/terraformAzure>in this repository</a>, feel free to post any correction (remember that I&rsquo;m learning Terraform, I&rsquo;m not an expert :))</p><p>For the first example, I used a script from Microsoft to create a Linux Virtual Machine with a public IP, then I modified it to <strong>install nginx on it and being able to connect to port 80 and see my machine up and running</strong>. Original Microsoft sample <a href=https://docs.microsoft.com/en-gb/azure/developer/terraform/create-linux-virtual-machine-with-infrastructure>is taken from this page</a> and you can find in my repository the final version.</p><p>Since this is the conversion of first example of the book, everything is a <strong>single main.tf terraform file, without any variable or modules</strong>. <strong>ALSO BE WARY THAT, UNLIKE THE ORIGINAL EXAMPLE, I&rsquo;M NOT PAYING ATTENTION TO THE SIZE OF THE MACHINE, YOU NEED TO HAVE AN AZURE SUBSCRIPTION AND PROVISION MACHINE WILL COST YOU MONEY DEPENDING ON YOUR ACTUAL PLAN</strong>.</p><p>This is my final script, with my modifications to being able to retrieve the public dynamic IP and to provision nginx on my VM.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#75715e># taken from here: https://docs.microsoft.com/en-gb/azure/developer/terraform/create-linux-virtual-machine-with-infrastructure
</span><span style=color:#75715e></span>
<span style=color:#a6e22e>terraform</span> {
  <span style=color:#a6e22e>required_version</span> = <span style=color:#e6db74>&#34;&gt;= 0.14&#34;</span>
  <span style=color:#a6e22e>required_providers</span> {
    <span style=color:#a6e22e>azurerm</span> = {
      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;hashicorp/azurerm&#34;</span>
      <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;~&gt;2.0&#34;</span>
    }
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
  <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;~&gt;2.0&#34;</span>
  <span style=color:#a6e22e>features</span> {}
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create a resource group if it doesn&#39;t exist
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34;</span> <span style=color:#e6db74>&#34;myterraformgroup&#34;</span> {
    <span style=color:#a6e22e>name</span>     = <span style=color:#e6db74>&#34;Terraform1&#34;</span>
    <span style=color:#a6e22e>location</span> = <span style=color:#e6db74>&#34;westeurope&#34;</span>

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create virtual network
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_virtual_network&#34;</span> <span style=color:#e6db74>&#34;myterraformnetwork&#34;</span> {
    <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;myVnet&#34;</span>
    <span style=color:#a6e22e>address_space</span>       = [<span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>]
    <span style=color:#a6e22e>location</span>            = <span style=color:#e6db74>&#34;westeurope&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create subnet
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_subnet&#34;</span> <span style=color:#e6db74>&#34;myterraformsubnet&#34;</span> {
    <span style=color:#a6e22e>name</span>                 = <span style=color:#e6db74>&#34;terraformSubnet&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span>  = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>
    <span style=color:#a6e22e>virtual_network_name</span> = <span style=color:#a6e22e>azurerm_virtual_network</span>.<span style=color:#a6e22e>myterraformnetwork</span>.<span style=color:#a6e22e>name</span>
    <span style=color:#a6e22e>address_prefixes</span>       = [<span style=color:#e6db74>&#34;10.0.1.0/24&#34;</span>]
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create public IPs
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_public_ip&#34;</span> <span style=color:#e6db74>&#34;myterraformpublicip&#34;</span> {
    <span style=color:#a6e22e>name</span>                         = <span style=color:#e6db74>&#34;myPublicIP&#34;</span>
    <span style=color:#a6e22e>location</span>                     = <span style=color:#e6db74>&#34;westeurope&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span>          = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>
    <span style=color:#a6e22e>allocation_method</span>            = <span style=color:#e6db74>&#34;Dynamic&#34;</span>

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create Network Security Group and rule
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_security_group&#34;</span> <span style=color:#e6db74>&#34;myterraformnsg&#34;</span> {
    <span style=color:#a6e22e>name</span>                = <span style=color:#e6db74>&#34;myNetworkSecurityGroup&#34;</span>
    <span style=color:#a6e22e>location</span>            = <span style=color:#e6db74>&#34;westeurope&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>

    <span style=color:#a6e22e>security_rule</span> {
        <span style=color:#a6e22e>name</span>                       = <span style=color:#e6db74>&#34;SSH&#34;</span>
        <span style=color:#a6e22e>priority</span>                   = <span style=color:#ae81ff>1001</span>
        <span style=color:#a6e22e>direction</span>                  = <span style=color:#e6db74>&#34;Inbound&#34;</span>
        <span style=color:#a6e22e>access</span>                     = <span style=color:#e6db74>&#34;Allow&#34;</span>
        <span style=color:#a6e22e>protocol</span>                   = <span style=color:#e6db74>&#34;Tcp&#34;</span>
        <span style=color:#a6e22e>source_port_range</span>          = <span style=color:#e6db74>&#34;*&#34;</span>
        <span style=color:#a6e22e>destination_port_range</span>     = <span style=color:#e6db74>&#34;22&#34;</span>
        <span style=color:#a6e22e>source_address_prefix</span>      = <span style=color:#e6db74>&#34;*&#34;</span>
        <span style=color:#a6e22e>destination_address_prefix</span> = <span style=color:#e6db74>&#34;*&#34;</span>
    }

     <span style=color:#a6e22e>security_rule</span> {
        <span style=color:#a6e22e>name</span>                       = <span style=color:#e6db74>&#34;HTTP&#34;</span>
        <span style=color:#a6e22e>priority</span>                   = <span style=color:#ae81ff>1002</span>
        <span style=color:#a6e22e>direction</span>                  = <span style=color:#e6db74>&#34;Inbound&#34;</span>
        <span style=color:#a6e22e>access</span>                     = <span style=color:#e6db74>&#34;Allow&#34;</span>
        <span style=color:#a6e22e>protocol</span>                   = <span style=color:#e6db74>&#34;Tcp&#34;</span>
        <span style=color:#a6e22e>source_port_range</span>          = <span style=color:#e6db74>&#34;*&#34;</span>
        <span style=color:#a6e22e>destination_port_range</span>     = <span style=color:#e6db74>&#34;80&#34;</span>
        <span style=color:#a6e22e>source_address_prefix</span>      = <span style=color:#e6db74>&#34;*&#34;</span>
        <span style=color:#a6e22e>destination_address_prefix</span> = <span style=color:#e6db74>&#34;*&#34;</span>
    }

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create network interface
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34;</span> <span style=color:#e6db74>&#34;myterraformnic&#34;</span> {
    <span style=color:#a6e22e>name</span>                      = <span style=color:#e6db74>&#34;myNIC&#34;</span>
    <span style=color:#a6e22e>location</span>                  = <span style=color:#e6db74>&#34;westeurope&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span>       = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>

    <span style=color:#a6e22e>ip_configuration</span> {
        <span style=color:#a6e22e>name</span>                          = <span style=color:#e6db74>&#34;myNicConfiguration&#34;</span>
        <span style=color:#a6e22e>subnet_id</span>                     = <span style=color:#a6e22e>azurerm_subnet</span>.<span style=color:#a6e22e>myterraformsubnet</span>.<span style=color:#a6e22e>id</span>
        <span style=color:#a6e22e>private_ip_address_allocation</span> = <span style=color:#e6db74>&#34;Dynamic&#34;</span>
        <span style=color:#a6e22e>public_ip_address_id</span>          = <span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>myterraformpublicip</span>.<span style=color:#a6e22e>id</span>
    }

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Connect the security group to the network interface
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34;</span> <span style=color:#e6db74>&#34;example&#34;</span> {
    <span style=color:#a6e22e>network_interface_id</span>      = <span style=color:#a6e22e>azurerm_network_interface</span>.<span style=color:#a6e22e>myterraformnic</span>.<span style=color:#a6e22e>id</span>
    <span style=color:#a6e22e>network_security_group_id</span> = <span style=color:#a6e22e>azurerm_network_security_group</span>.<span style=color:#a6e22e>myterraformnsg</span>.<span style=color:#a6e22e>id</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Generate random text for a unique storage account name
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;random_id&#34;</span> <span style=color:#e6db74>&#34;randomId&#34;</span> {
    <span style=color:#a6e22e>keepers</span> = {<span style=color:#75715e>
</span><span style=color:#75715e>        # Generate a new ID only when a new resource group is defined
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>resource_group</span> = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>
    }

    <span style=color:#a6e22e>byte_length</span> = <span style=color:#ae81ff>8</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create storage account for boot diagnostics
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_storage_account&#34;</span> <span style=color:#e6db74>&#34;mystorageaccount&#34;</span> {
    <span style=color:#a6e22e>name</span>                        = <span style=color:#e6db74>&#34;diag</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>random_id</span>.<span style=color:#a6e22e>randomId</span>.<span style=color:#a6e22e>hex</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span>         = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>
    <span style=color:#a6e22e>location</span>                    = <span style=color:#e6db74>&#34;westeurope&#34;</span>
    <span style=color:#a6e22e>account_tier</span>                = <span style=color:#e6db74>&#34;Standard&#34;</span>
    <span style=color:#a6e22e>account_replication_type</span>    = <span style=color:#e6db74>&#34;LRS&#34;</span>

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create (and display) an SSH key
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;tls_private_key&#34;</span> <span style=color:#e6db74>&#34;example_ssh&#34;</span> {
  <span style=color:#a6e22e>algorithm</span> = <span style=color:#e6db74>&#34;RSA&#34;</span>
  <span style=color:#a6e22e>rsa_bits</span> = <span style=color:#ae81ff>4096</span>
}
<span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;tls_private_key&#34;</span> { <span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>tls_private_key</span>.<span style=color:#a6e22e>example_ssh</span>.<span style=color:#a6e22e>private_key_pem</span> }<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Create virtual machine
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_linux_virtual_machine&#34;</span> <span style=color:#e6db74>&#34;myterraformvm&#34;</span> {
    <span style=color:#a6e22e>name</span>                  = <span style=color:#e6db74>&#34;myVM&#34;</span>
    <span style=color:#a6e22e>location</span>              = <span style=color:#e6db74>&#34;westeurope&#34;</span>
    <span style=color:#a6e22e>resource_group_name</span>   = <span style=color:#a6e22e>azurerm_resource_group</span>.<span style=color:#a6e22e>myterraformgroup</span>.<span style=color:#a6e22e>name</span>
    <span style=color:#a6e22e>network_interface_ids</span> = [<span style=color:#a6e22e>azurerm_network_interface</span>.<span style=color:#a6e22e>myterraformnic</span>.<span style=color:#a6e22e>id</span>]
    <span style=color:#a6e22e>size</span>                  = <span style=color:#e6db74>&#34;Standard_B1s&#34;</span>

    <span style=color:#a6e22e>os_disk</span> {
        <span style=color:#a6e22e>name</span>              = <span style=color:#e6db74>&#34;myOsDisk&#34;</span>
        <span style=color:#a6e22e>caching</span>           = <span style=color:#e6db74>&#34;ReadWrite&#34;</span>
        <span style=color:#a6e22e>storage_account_type</span> = <span style=color:#e6db74>&#34;Premium_LRS&#34;</span>
    }

    <span style=color:#a6e22e>source_image_reference</span> {
        <span style=color:#a6e22e>publisher</span> = <span style=color:#e6db74>&#34;Canonical&#34;</span>
        <span style=color:#a6e22e>offer</span>     = <span style=color:#e6db74>&#34;UbuntuServer&#34;</span>
        <span style=color:#a6e22e>sku</span>       = <span style=color:#e6db74>&#34;18.04-LTS&#34;</span>
        <span style=color:#a6e22e>version</span>   = <span style=color:#e6db74>&#34;latest&#34;</span>
    }

    <span style=color:#a6e22e>computer_name</span>  = <span style=color:#e6db74>&#34;myvm&#34;</span>
    <span style=color:#a6e22e>admin_username</span> = <span style=color:#e6db74>&#34;azureuser&#34;</span>
    <span style=color:#a6e22e>disable_password_authentication</span> = <span style=color:#66d9ef>true</span>

    <span style=color:#a6e22e>admin_ssh_key</span> {
        <span style=color:#a6e22e>username</span>       = <span style=color:#e6db74>&#34;azureuser&#34;</span>
        <span style=color:#a6e22e>public_key</span>     = <span style=color:#a6e22e>tls_private_key</span>.<span style=color:#a6e22e>example_ssh</span>.<span style=color:#a6e22e>public_key_openssh</span>
    }

    <span style=color:#a6e22e>boot_diagnostics</span> {
        <span style=color:#a6e22e>storage_account_uri</span> = <span style=color:#a6e22e>azurerm_storage_account</span>.<span style=color:#a6e22e>mystorageaccount</span>.<span style=color:#a6e22e>primary_blob_endpoint</span>
    }

    <span style=color:#a6e22e>tags</span> = {
        <span style=color:#a6e22e>environment</span> = <span style=color:#e6db74>&#34;Terraform Demo&#34;</span>
    }

    <span style=color:#a6e22e>custom_data</span> = filebase64(<span style=color:#e6db74>&#34;./init.sh&#34;</span>)
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;azurerm_public_ip&#34;</span> <span style=color:#e6db74>&#34;myterraformpublicip&#34;</span> {
  <span style=color:#a6e22e>name</span>                = <span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>myterraformpublicip</span>.<span style=color:#a6e22e>name</span>
  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_linux_virtual_machine</span>.<span style=color:#a6e22e>myterraformvm</span>.<span style=color:#a6e22e>resource_group_name</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;ip_address&#34;</span> { 
    <span style=color:#a6e22e>value</span> = data.<span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>myterraformpublicip</span>
}</code></pre></td></tr></table></div></div><p>The example is long but it is really simple, to be able to run it, you need to install Terraform and you <strong>need also to be logged into your azure account; this is done with the AZ cli tools</strong>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>az login
az account list --query <span style=color:#e6db74>&#34;[].{name:name, subscriptionId:id}&#34;</span>
az account set --subscription=<span style=color:#e6db74>&#34;&lt;subscription_id&gt;&#34;</span></code></pre></td></tr></table></div></div><p>Az login will open a browser window to perform login, account list allows you to list all of your subscriptions actually available and the third line is needed to select the subscription you want to work with.</p><blockquote><p>Azure CLI tools need to be installed to work properly with Terraform</p></blockquote><p>Line 187 of the script is the point where I&rsquo;m setting <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/custom-data>Virtual Machine Custom Data</a>, in this situation this is a <strong>super simple shell script to install nginx, but can be almost everything that stay in 64KB size limit</strong>. User Data should be base64 encoded.</p><p>This is the super complex bash script I&rsquo;ve used :)</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt-get update
apt-get install nginx -y</code></pre></td></tr></table></div></div><p>Now another interesting part is line 190-197 where I retrieve as output the ip_address. You need to be aware that <strong>if you are using dynamic public IP in azure, the IP is assigned only after the IP resource is assigned to something (like a VM)</strong>. This imply that you need to create VM resource with the IP BEFORE retrieving the IP as output.</p><blockquote><p>To effectively retrieve dynamic IP public address in azure you should use data (as in example lines 190-197).</p></blockquote><p>After you terraform init, terraform plan and terraform apply, you can verify if the IP is correct with this simple PowerShell.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ipAddress = terraform output -json ip_address | ConvertFrom-json
$ipAddress.ip_address</code></pre></td></tr></table></div></div><p>Terraform output in json format is really convenient because you can <strong>ConvertFrom-Json in PowerShell to have a nice object you can interact with</strong>.</p><p><a target=_blank href=../images/terraform-public-ip.png><img src=../images/terraform-public-ip.png alt="Public dynamic IP data"></a>
<em><strong>Figure 1</strong></em>: <em>Public dynamic IP data</em></p><blockquote><p>Thanks to PowerShell Json parsing capabilities, I can use complex Terraform Output objects natively.</p></blockquote><p>As you can see from <strong>Figure 1</strong> I got a nice object with properties that represents all data for the public IP just created, now I <strong>only need to browser that IP to verify that I&rsquo;ve really have an nginx instance answering from the other side</strong>. I can also browse the resource group from Azure Portal to verify what was really created.</p><p><a target=_blank href=../images/terrfaorm1-resource-group.png><img src=../images/terrfaorm1-resource-group.png alt="All resources created by terraform main.tf file"></a>
<em><strong>Figure 2</strong></em>: <em>All resources created by terraform main.tf file</em></p><p>This is all we need to automate the creation of a VM in azure, but, wait, can the example be made a little bit better? This approach, is not perfect because the <strong>SSH key is created by terraform and it is contained in the state file</strong>, this is not a perfect scenario because I do not want my SSH key to be contained in terraform store.</p><p><a target=_blank href=../images/terraform-created-RSA-key.png><img src=../images/terraform-created-RSA-key.png alt="RSA key was stored inside terraform state"></a>
<em><strong>Figure 3</strong></em>: <em>RSA key was stored inside terraform state</em></p><p>Ok, time to improve the script, but before <strong>DO NOT FORGET TO DO A TERRAFORM DESTROY REMOVING EVERYTHING TO AVOID PAYING FOR RESOURCES YOU ARE NOT USING, A TERRAFORM DESTROY WILL REMOVE EVERY RESOURCE FROM AZURE THAT WERE CREATED BY THIS SCRIPT</strong></p><p>The new script has some interesting modifications</p><ul><li>It uses a pre-created RSA key, <strong>but remember that private key should not be protected with password</strong></li><li>It uses resource provisioning to configure the machine.</li></ul><p>First of all, lets create a nice RSA key with the command <em>ssh-keygen.exe -b 4096</em>, when prompted save the key in local directory giving the name .\my-key, <strong>choose a blank password</strong> and you will end with two files: my-key.pub and my-key. We need not to setup password because Terraform resource for provisioning is not capable of using password. <strong>Using this approach has the advantage to not store the RSA key in terraform state</strong>. You can simply take the key and store in some secure vault or password manager, because you are not supposed to regularly SSH into azure machine (you should automate almost everything).</p><p>All new code can be found <a href=https://github.com/AlkampferOpenSource/terraform-up-and-running-code/tree/master/code/terraformAzure/01-why-terraform/web-server-provision>here in GitHub</a> and I&rsquo;m going to paste here only the relevant changes.</p><p>RSA key is not created anymore in the main.tf file, it is just referenced from external code</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform>    <span style=color:#a6e22e>admin_ssh_key</span> {
        <span style=color:#a6e22e>username</span>       = <span style=color:#e6db74>&#34;azureuser&#34;</span>
        <span style=color:#a6e22e>public_key</span>     = file(<span style=color:#e6db74>&#34;my-key.pub&#34;</span>)
    }</code></pre></td></tr></table></div></div><p>Thanks to the file function I can load public key directly from disk. Then I need to provision the VM, but <strong>remember the previous example when I told you that you do not have a public IP until you assign to the machine</strong>, this can be a problem, because the provisioner is actually connecting to that machine, and needs the public IP to do the connection.</p><p>It turns out that I cannot specify the provisioner inside Virtual Machine resource (because it would not know the IP address), but I can use the null_resource as a trick. <strong>After Virtual Machine creation you can add this code</strong>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;azurerm_public_ip&#34;</span> <span style=color:#e6db74>&#34;myterraformpublicip&#34;</span> {
  <span style=color:#a6e22e>name</span>                = <span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>myterraformpublicip</span>.<span style=color:#a6e22e>name</span>
  <span style=color:#a6e22e>resource_group_name</span> = <span style=color:#a6e22e>azurerm_linux_virtual_machine</span>.<span style=color:#a6e22e>myterraformvm</span>.<span style=color:#a6e22e>resource_group_name</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;ip_address&#34;</span> { 
    <span style=color:#a6e22e>value</span> = data.<span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>myterraformpublicip</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;null_resource&#34;</span> <span style=color:#e6db74>&#34;vm_provision&#34;</span> {
    <span style=color:#a6e22e>connection</span> {
        <span style=color:#a6e22e>type</span>        = <span style=color:#e6db74>&#34;ssh&#34;</span>
        <span style=color:#a6e22e>host</span>        = data.<span style=color:#a6e22e>azurerm_public_ip</span>.<span style=color:#a6e22e>myterraformpublicip</span>.<span style=color:#a6e22e>ip_address</span>
        <span style=color:#a6e22e>user</span>        = <span style=color:#e6db74>&#34;azureuser&#34;</span>
        <span style=color:#a6e22e>private_key</span> = file(<span style=color:#e6db74>&#34;my-key&#34;</span>)
    }
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>    provisioner</span> <span style=color:#e6db74>&#34;file&#34;</span> {
        <span style=color:#a6e22e>source</span>      = <span style=color:#e6db74>&#34;init.sh&#34;</span>
        <span style=color:#a6e22e>destination</span> = <span style=color:#e6db74>&#34;/tmp/init.sh&#34;</span>
    }
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>    provisioner</span> <span style=color:#e6db74>&#34;remote-exec&#34;</span> {
        <span style=color:#a6e22e>inline</span> = [
            <span style=color:#e6db74>&#34;sudo bash /tmp/init.sh&#34;</span>,
        ]
    }
}</code></pre></td></tr></table></div></div><p>The trick is simple, use data to retrieve public IP <strong>after the machine is created</strong>, then <strong>add a null resource just to contain provisioning code</strong>. Actually to provision a VM you need to specify a connection (because we are outside VM resource), you need to specify the private key file to use (and since we do not have the ability to specify a password you need to have it created without password). After the connection a file provisioner will copy a file into the machine, and a remote-exec provisioner will execute that bash script into the target machine.</p><p>After the machine is created you can actually retrieve public ip and try to navigate to the ip, you should see nginx welcome page. <strong>Do not forget to destroy everything to avoid paying for test resources</strong>. Also save and store your my-key RSA in some secure place if you plan to connect to the machine in the future.</p><blockquote><p>Remember that automating Cloud Resources creation is the heart of adopting a DevOps mindset for Cloud.</p></blockquote><p>Once you have a Terraform file, you can use in Azure DevOps pipelines or in GitHub actions to actually deploy resources on the cloud.</p><p>A special thanks to <a href=http://blog.casavian.eu/>Giulio Vian</a> for his invaluable support.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/devops/>DevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/azure/>Azure</a>, <a class=tag href=/tags/terraform/>terraform</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/general/iis-bind-ip/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Avoid IIS to bind to every IP Address port and other amenities</a></div><div class="next-entry sep-before"><a href=/post/azdo/pipeline/powershell-build/><span class=screen-reader-text>Next post: </span>Continuous integration: PowerShell way<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>