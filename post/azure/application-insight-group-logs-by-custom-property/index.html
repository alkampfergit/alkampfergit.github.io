<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sometimes you need to group by or filter Application Insight logs using a custom property, it is really easy with the expand capabilities"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Group application insight logs by custom property • Codewrecks"><meta property="og:description" content="Sometimes you need to group by or filter Application Insight logs using a custom property, it is really easy with the expand capabilities"><meta property="og:url" content="https://www.codewrecks.com/post/azure/application-insight-group-logs-by-custom-property/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Azure"><meta property="article:published_time" content="2020-04-27T18:45:18+02:00"><meta property="article:modified_time" content="2020-04-27T18:45:18+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Group application insight logs by custom property • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/azure/application-insight-group-logs-by-custom-property/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Group application insight logs by custom property</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Group application insight logs by custom property</h1><p class=desc>Sometimes you need to group by or filter Application Insight logs using a custom property, it is really easy with the expand capabilities</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-04-27T18:45:18+02:00>2020, Apr 27</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>Today we found excessive number of logs in Application Insight instance, an application that usually cost few bucks each month, started to use more resources. Looking at a summary of last 30 days we see <strong>excessive number of custom events</strong>.</p><p><a target=_blank href=../images/application-insight-summary.png><img src=../images/application-insight-summary.png alt="Summary of Application Insight data"></a></p><p><em><strong>Figure 1:</strong></em> <em>Application insight summary for a specific application</em></p><p>Now the problem is: how can I quickly spot out why we have an excessive number of CustomEvents? <strong>Logs shows me clearly that the vast majority of logs are indeed Custom Events</strong>. To have a better insight to detail of events, we need to use custom queries, first of all I grouped by name.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>customEvents
| extend itemType = iif(itemType == <span style=color:#e6db74>&#39;customEvent&#39;</span>,itemType,<span style=color:#e6db74>&#34;&#34;</span>)
| where (itemType == <span style=color:#e6db74>&#39;customEvent&#39;</span> and (timestamp &gt;= datetime(2020-03-28T08<span style=color:#960050;background-color:#1e0010>:</span>50<span style=color:#960050;background-color:#1e0010>:</span>00.000Z) and timestamp &lt;= datetime(2020-04-27T08<span style=color:#960050;background-color:#1e0010>:</span>50<span style=color:#960050;background-color:#1e0010>:</span>00.000Z))) 
| summarize Count = count() by name
| top 101 by Count desc</code></pre></td></tr></table></div></div><p>Thanks to powerful query language in Application Insight , we can simply summarize all custom events by name, to verify if <strong>some of the events are responsible for this increase of cost.</strong></p><p><a target=_blank href=../images/commands-event-application-insight.png><img src=../images/commands-event-application-insight.png alt="Result of the query"></a></p><p><em><strong>Figure 2.</strong></em> <em>Summarize immediately found the events that is gone wrong</em></p><p>From <em><strong>Figure 2</strong></em> it is really clear that almost all of the events are of type &ldquo;CommandExecuted&rdquo;. We are not using custom event extensively, one of the few custom event that we use is CommandExecuted, sent each time the server executes a command. Now my problem is: <strong>which command is responsible of most of the log?</strong></p><blockquote><p>Application Insight contains a really powerful language that allows me to group by and filter using both predefined properties or custom properties.</p></blockquote><p>Lets look at a single instance of CommandExecuted events, to verify if we have some interesting custom property to further group by.</p><p><a target=_blank href=../images/ai-events-custom-properties-event.png><img src=../images/ai-events-custom-properties-event.png alt="Custom properties of events"></a></p><p><em><strong>Figure 3.</strong></em> <em>Each event has some interesting custom properties, one is the CommandType</em></p><p>From <em><strong>Figure 3</strong></em> it is evident that <strong>CommandType Custom property is a good candidate for another group by</strong>. What I want is to be able to have a count for each distinct CommandType, but that property is indeed a custom property stored inside a dictionary. <strong>Thanks to AI we have a simple syntax for extending the resultset using a custom property or other dictionary data in the log.</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>customEvents
| extend itemType = iif(itemType == <span style=color:#e6db74>&#39;customEvent&#39;</span>,itemType,<span style=color:#e6db74>&#34;&#34;</span>)
| extend CommandType = tostring( customDimensions.CommandType)
| where (itemType == <span style=color:#e6db74>&#39;customEvent&#39;</span> and (timestamp &gt;= datetime(2020-03-28T08<span style=color:#960050;background-color:#1e0010>:</span>50<span style=color:#960050;background-color:#1e0010>:</span>00.000Z) and timestamp &lt;= datetime(2020-04-27T08<span style=color:#960050;background-color:#1e0010>:</span>50<span style=color:#960050;background-color:#1e0010>:</span>00.000Z))) 
| summarize Count = count() by CommandType
| top 101 by Count desc</code></pre></td></tr></table></div></div><p>Thanks to the extend functionality, <strong>I&rsquo;m able to ask to AI to create another column, called CommandType that is a conversion to string of customDinensions.CommandType</strong>. Once you extended the resultset and created a new CommandType column, I can summarize using that column obtaining the data I need.</p><p><a target=_blank href=../images/result-of-ai-group-by-custom-property.png><img src=../images/result-of-ai-group-by-custom-property.png alt="Resoult of grouping"></a></p><p><em><strong>Figure 4.</strong></em> <em>Group by custom property result</em></p><p>Bingo, we have lots of commands related to user synchronization from active directory. This happens because the frequency of user active directory sync was increased and also some customers have really big Active Directory, with a lot of users. <strong>Each time the system scan active directory, thousands of commands are launched, and if the sync happens once an hour, or more frequently, you got some million of commands in an entire month</strong>.</p><blockquote><p>Application Insight has a powerful query language that is able to filter and crunch an enormous amount of data, letting you group and filter even on your custom properties.</p></blockquote><p>Thanks to Application Insight, I was able to spot out which events generated excessive amount of log, then I immediately remove those two specific commands from tracing. The team decided that we do not need to track CommandExecuted events generated by User Sync job.</p><p>If you are using Application Insight, I strongly suggest you to start exploring query capability, it is a really powerful tool to immediately find the information you need.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/devops/>DevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/azure/>Azure</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/security/use-a-password-manager/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Validate User Input Step 4</a></div><div class="next-entry sep-before"><a href=/post/general/advantage-of-hugo/><span class=screen-reader-text>Next post: </span>Advantage of Hugo<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>