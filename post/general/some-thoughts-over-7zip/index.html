<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="7zip is a fantastic tool and it has plenty of knobs to turn to obtain maximum compression and maximum efficiency"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Fine control of compression level in 7zip • Codewrecks"><meta property="og:description" content="7zip is a fantastic tool and it has plenty of knobs to turn to obtain maximum compression and maximum efficiency"><meta property="og:url" content="https://www.codewrecks.com/post/general/some-thoughts-over-7zip/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="DevOps"><meta property="article:published_time" content="2021-08-10T20:00:00+02:00"><meta property="article:modified_time" content="2021-08-10T20:00:00+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Fine control of compression level in 7zip • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/general/some-thoughts-over-7zip/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Fine control of compression level in 7zip</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Fine control of compression level in 7zip</h1><p class=desc>7zip is a fantastic tool and it has plenty of knobs to turn to obtain maximum compression and maximum efficiency</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2021-08-10T20:00:00+02:00>2021, Aug 10</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>7 mins read</span></div></div></header><div class="container entry-content"><p>Even if 7zip is not a real DevOps argument, it is really interesting in the context of a build pipeline and <strong>artifacts publishing</strong>. AzureDevops Pipeilne and GitHub actions have <strong>dedicated actions to upload artifacts to the result of the pipeline/action</strong> but I often do not like this approach. Even if you can download everything as a zip, I like to create different archives before uploading, for at least two reasons</p><ol><li>I&rsquo;m able to create different archives based on specific semantics (one archive for web app, one for services, one for angular UI etc)</li><li>I can use 7zip tool to reduce archive size much more than a single zip.</li></ol><p>In a pipeline we have in AzureDevops we have a grand total of roughly 860 MB of dll, <strong>most of them duplicated because are shared reference used by many services</strong>. In that scenario I use a full PowerShell build script that organize all the services in a folder, then compress all 860 MB of data in a 7zip archive that will be uploaded by subsequent actions as artifact in the pipeline result.</p><blockquote><p>I usually use a really old version of 7za.ext (version 9.20) in my PowerShell script for convenience</p></blockquote><p>I have lots of PowerShell helpers written that automatically download 7za.exe version 9.20 and use it to compress folder, never felt the need to resort to full 7zip.exe even if I know that <strong>probably it will give me better result because it is a more recent version</strong>. In this project I started to have strange behavior, **Azure DevOps pipeline produces a 7zip file of 36 MB (I told you that 7zip is exceptional) but some developer started asking me **what option I&rsquo;ve used because they tried locally with latest version of 7zip but they got at least a 76MB archive, not 36MB **.</p><blockquote><p>When you create lots of pipelines / GitHub actions speed of execution and size of artifacts can make a big difference.</p></blockquote><p>The goal is having not high execution time (not using maximum compression if does not give real advantage) but having small artifacts to minimize upload time or server space if you have TFS on premise. In such scenario <strong>standard zip format does not stand a chance against 7zip, but even 7zip has a lot of options you need to consider to find the sweet spot</strong>.</p><p>I started creating a small PowerShell test script that you can find in <a href=https://gist.github.com/alkampfergit/0a6b683f3e9bb1b63a43c75c94abe5a8>this Gist</a>. The script is really stupid, it just try to compress the aforementioned folder using various compression level (1, 3, 5, 7, 9) with different options ti <strong>dumps reduction in size and time needed to archive the folder</strong>.</p><p>Here is the result of standard 7zip command line where I changed only the compression level (-mx option)</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>mx=1-&gt; 3474 ms file size 239133911 global reduction of 27.8% relative increase <span style=color:#66d9ef>in</span> compression time 100.0% vs relative reduction 100.0%
mx=3-&gt; 4383 ms file size 228246178 global reduction of 26.6% relative increase <span style=color:#66d9ef>in</span> compression time 126.2% vs relative reduction 95.4%
mx=5-&gt; 18973 ms file size 189873288 global reduction of 22.1% relative increase <span style=color:#66d9ef>in</span> compression time 546.1% vs relative reduction 79.4%
mx=7-&gt; 37825 ms file size 184362620 global reduction of 21.5% relative increase <span style=color:#66d9ef>in</span> compression time 1088.8% vs relative reduction 77.1%
mx=9-&gt; 74693 ms file size 78668370 global reduction of 09.2% relative increase <span style=color:#66d9ef>in</span> compression time 2150.1% vs relative reduction 32.9%</code></pre></td></tr></table></div></div><p>As you can see level 1 need 3.4 seconds to run and produces an archive that is <strong>27.8% of the original space</strong>, increasing the compression level to 7 needs 38 seconds to run but we have not a great reduction in size (21.5% vs 27.8%). With an increment in running time of 1088% with a small reduction of size of generated archive, it is <strong>clear that in my situation using compression level 1 is far better than level 7</strong>.</p><p>The real gain in size happens at compression level 9, where I have an archive that is 9.2% of the original size, but I need 74.5 seconds to run. So I have a 2150% increase in time with a relative reduction of size of 32.9 comparing to level 1.</p><blockquote><p>If you have reduced upload bandwidth usually having reduced size of artifacts is the top one priority.</p></blockquote><p>But I have a real strange report from developer tesam, if they manually create the archive, they are not able to get an archive that is <strong>less than 78 MB in size</strong>. The only difference is that pipeline script uses the really old 9.20 version (7za), so I executed the very same test with that version.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>7za920.exe mx=1-&gt; 28957 ms file size 227614220 global reduction of 26.5% relative increase <span style=color:#66d9ef>in</span> compression time 833.5% vs relative reduction 95.2%
7za920.exe mx=3-&gt; 23893 ms file size 138319244 global reduction of 16.1% relative increase <span style=color:#66d9ef>in</span> compression time 687.8% vs relative reduction 57.8%
7za920.exe mx=5-&gt; 67414 ms file size 37366034 global reduction of 04.3% relative increase <span style=color:#66d9ef>in</span> compression time 1940.5% vs relative reduction 15.6%
7za920.exe mx=7-&gt; 83525 ms file size 36869588 global reduction of 04.3% relative increase <span style=color:#66d9ef>in</span> compression time 2404.3% vs relative reduction 15.4%
7za920.exe mx=9-&gt; 83055 ms file size 36468973 global reduction of 04.2% relative increase <span style=color:#66d9ef>in</span> compression time 2390.8% vs relative reduction 15.3%</code></pre></td></tr></table></div></div><blockquote><p>It seems that 7za 9.20, a 10 years old product is far more better than last version of 7zip.</p></blockquote><p>The result is astonishing, <strong>with the older version I have a resulting archive of 37 MB at compression level 5</strong>. This imply that with the 10 years old utility I&rsquo;m able to get an archive that is less than half the size (37 MB vs 78MB) with less time (67 seconds vs 74 seconds).</p><blockquote><p>Since newer tools should be better, we need to investigate the root cause of this behavior.</p></blockquote><p>This explain the different in build upload result, my Azure DevOps pipeline uses the 10 year old 7za at level 5 (default) and it generates an archive <strong>half the size in less time that the new 7za at level 9</strong>.</p><p>I&rsquo;ve start to investigate, and since the original folder contains lots of identical files (dll and pdb) the problem <strong>could be related to solid archive type</strong>. A friend of mine suggests me to check for change in default option for solid archive block size, but all blocks are greater than my data, so it is not the problem.</p><p>Then I started reading t!he help thoroughly and here is what I found:</p><p><a target=_blank href=../images/solid-options-7zip.png><img src=../images/solid-options-7zip.png alt="Solid option for 7zip change in latest version"></a></p><p><em><strong>Figure 1:</strong></em> <em>Solid option for 7zip change in latest version</em></p><p>Now I try to re-run another run of the test script using latest version of 7zip adding the -mqs=on option that allows <strong>to use file extension ordering to solid compression</strong>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>mx=1 -mqs=on-&gt; 3452 ms file size 228971062 global reduction of 26.6% relative increase <span style=color:#66d9ef>in</span> compression time 99.4% vs relative reduction 95.8%
mx=3 -mqs=on-&gt; 3094 ms file size 147075071 global reduction of 17.1% relative increase <span style=color:#66d9ef>in</span> compression time 89.1% vs relative reduction 61.5%
mx=5 -mqs=on-&gt; 15176 ms file size 42474526 global reduction of 04.9% relative increase <span style=color:#66d9ef>in</span> compression time 436.8% vs relative reduction 17.8%
mx=7 -mqs=on-&gt; 27578 ms file size 39095401 global reduction of 04.6% relative increase <span style=color:#66d9ef>in</span> compression time 793.8% vs relative reduction 16.3%
mx=9 -mqs=on-&gt; 42668 ms file size 37472502 global reduction of 04.4% relative increase <span style=color:#66d9ef>in</span> compression time 1228.2% vs relative reduction 15.7%</code></pre></td></tr></table></div></div><p>Results were astonishing, <strong>as for 7za.exe version 9.20, I&rsquo;ve start looking to an extreme reduction of size at compression level 5 where I got an archive of 42.5 MB size but in 15 seconds</strong>. Even if the old version still generate a smaller archive (37 MB vs 42.5 MB), time of execution is 15 seconds versus 67 seconds. Raising the compression level to 9 I got almost the same size 37472502 vs 36468973 bytes, but in 42 seconds instead 67.</p><blockquote><p>After all these test I can confirm that newest version of 7zip gives me the best results, 15 seconds of execution and a zip file that is 4.9% of the original size.</p></blockquote><p>These simple tests confirms me that 7zip is an exceptional product, but that sometimes needs some <strong>fine grained tuning to get the maximum out of it</strong>.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/pipeline/>Pipeline</a>, <a class=category href=/categories/build/>Build</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/devops/>DevOps</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/azdo/pipeline/powershell-boolean/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Passing boolean parameters to PowerShell scripts in Azure DevOps Pipeline</a></div><div class="next-entry sep-before"><a href=/post/github/choose-environment-from-branch/><span class=screen-reader-text>Next post: </span>Choose environment from branch in GitHub action<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>