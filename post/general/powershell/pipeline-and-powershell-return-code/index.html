<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="If you decide to use PowerShell for your build and then use it in Azure DevOps pipeline you should pay attention to manage error code"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="How to handle  errors in PowerShell script used in Azure DevOps pipeline • Codewrecks"><meta property="og:description" content="If you decide to use PowerShell for your build and then use it in Azure DevOps pipeline you should pay attention to manage error code"><meta property="og:url" content="https://www.codewrecks.com/post/general/powershell/pipeline-and-powershell-return-code/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="PowerShell"><meta property="article:published_time" content="2020-11-15T08:00:00+02:00"><meta property="article:modified_time" content="2020-11-15T08:00:00+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>How to handle errors in PowerShell script used in Azure DevOps pipeline • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/general/powershell/pipeline-and-powershell-return-code/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>How to handle errors in PowerShell script used in Azure DevOps pipeline</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>How to handle errors in PowerShell script used in Azure DevOps pipeline</h1><p class=desc>If you decide to use PowerShell for your build and then use it in Azure DevOps pipeline you should pay attention to manage error code</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-11-15T08:00:00+02:00>2020, Nov 15</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>3 mins read</span></div></div></header><div class="container entry-content"><p>Building with PowerShell or other scripting engine is a really nice option because you can <strong>reuse the script in almost any Continuous Integration engine</strong> with a minimal effort, but sometimes there are tools that causes some headache.</p><p>I had problem with tooling like yarn and npm when they are run in Azure DevOps pipeline, the problem is that <strong>when the tool emit a warning, pipeline engine consider it an error and make the build fails</strong>. This happens usually because it is common to run PowerShell scripts in Azure DevOps pipeline with the option failOnStdErr to true</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#66d9ef>task</span>: PowerShell@<span style=color:#ae81ff>2</span>
  <span style=color:#66d9ef>displayName</span>: <span style=color:#e6db74>&#34;Execute build file to create release&#34;</span>
  <span style=color:#66d9ef>inputs</span>:
    <span style=color:#66d9ef>targetType</span>: filePath
    <span style=color:#66d9ef>filePath</span>: $(Build.SourcesDirectory)/src/Planner/build.ps1
    <span style=color:#66d9ef>workingDirectory</span>: $(Build.SourcesDirectory)/src/Planner
    <span style=color:#66d9ef>arguments</span>: -updateBuildNumber ${{parameters.updateBuildNumber}} -configuration ${{parameters.configuration}}
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#66d9ef>failOnStderr</span>: <span style=color:#66d9ef>true</span></span></code></pre></td></tr></table></div></div><blockquote><p>Option failOnStdErr is nice but it can lead to unwanted consequences if the tool output something to error console.</p></blockquote><p>Usually failOnStdError is set to true, thus if a tools write in the error stream task is considered to be failed. This assumption seems to be always true, after all, if the script output some error to console why not considering the entire task failed? This assumption is wrong with <strong>some tools that seems to output normal warning in stdErr output or in some way that is detected as error by Azure DevOps pipeline engine.</strong> With such tools your task is considered failed even if the tool simply generated only warnings. (<strong>Figure 1</strong>)</p><p><a target=_blank href=../images/warning-error-inside-pipeline.png><img src=../images/warning-error-inside-pipeline.png alt="Warning treated as error from pipeline engine"></a>
<em><strong>Figure 1:</strong></em> <em>Warning treated as error from pipeline engine</em></p><p>As you can see from <em><strong>Figure 1</strong></em> npm build tool is emitting a warning, but pipeline engine detect it as error and the task failed. My first reaction was to try to redirect warning from npm with some trick found in internet but nothing works. The I realized that I was <strong>lazy and I didn&rsquo;t correctly detect error in my script, letting pipeline do the dirty work</strong>.</p><blockquote><p>When you create a build script you should handle tools error correctly and not rely on pipeline engine or anything else.</p></blockquote><p>Writing scripts and letting the task fail on error in standard output is also not human friendly. You are requiring <strong>that the people that runs a manual build looks at the whole output for errors to understand if the build really failed</strong>. Thanks to PowerShell the solution is obvious: Just check some special variable that stores result of last operation like $?</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>if</span> ($false <span style=color:#f92672>-eq</span> $?)
</span>{
  Write-Error <span style=color:#e6db74>&#34;Msbuild exit code indicate build failure.&#34;</span>
  Write-Host <span style=color:#e6db74>&#34;##vso[task.logissue type=error]Msbuild exit code indicate build failure.&#34;</span>
  exit(1)
}</code></pre></td></tr></table></div></div><p>As you can see from line 1, after you run MsBuild, npm, yarn or any other tool, you can check the special variable $? that contains $true or $false depending on the result of latest PowerShell operation. This is correct for any operation you do in PowerShell, and you can also argue that, for normal external tool, you should probably check <strong>$LastExitCode that contains exit code of last program launched from PowerShell.</strong></p><p>In my specific situation for MsBuild, yarn and npm, I&rsquo;ve verified that $? works well so <strong>I&rsquo;ve decided to use it instead of $LastExitCode</strong>. If $? is not true I write an error to the host, then write a special pipeline command that makes task fails.</p><p>This gives me the flexibility of creating my build entirely in PowerShell but I&rsquo;m still able to decide what is a warning and what is an error, and gives me <strong>the power to decide when the task is considered to be failed, not relying on the failOnStdErr option, that should always set to false</strong>.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/azuredevops/>AzureDevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/powershell/>PowerShell</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/azdo/pills/powershell-download/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Pills: Invoke-WebRequest really Slow</a></div><div class="next-entry sep-before"><a href=/post/azdo/pills/progress-by-item/><span class=screen-reader-text>Next post: </span>Azure DevOps Pills: View progress in backlog<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>