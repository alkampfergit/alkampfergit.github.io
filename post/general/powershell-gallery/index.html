<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Take your PowerShell utilities functions to the next level, publish them to PowerShell gallery to make them always available"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Publish PowerShell functions to PowerShell Gallery • Codewrecks"><meta property="og:description" content="Take your PowerShell utilities functions to the next level, publish them to PowerShell gallery to make them always available"><meta property="og:url" content="https://www.codewrecks.com/post/general/powershell-gallery/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="PowerShell"><meta property="article:published_time" content="2020-06-28T08:00:00+02:00"><meta property="article:modified_time" content="2020-06-28T08:00:00+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Publish PowerShell functions to PowerShell Gallery • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/general/powershell-gallery/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Publish PowerShell functions to PowerShell Gallery</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Publish PowerShell functions to PowerShell Gallery</h1><p class=desc>Take your PowerShell utilities functions to the next level, publish them to PowerShell gallery to make them always available</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-06-28T08:00:00+02:00>2020, Jun 28</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>6 mins read</span></div></div></header><div class="container entry-content"><p>I&rsquo;m a great fan of PowerShell script for build and release, even if Azure DevOps, GitHub Actions, TeamCity or Jenkins have pre-made task for common operations (zipping, file handling, etc). I always like using PowerShell scripts to do most of the job and the reason is simple: <strong>PowerShell scripts are easy to test, easy to understand and are not bound to a specific CI/CD engine</strong>.</p><p>Since I&rsquo;m not a real PowerShell expert, during the years I&rsquo;ve made some functions I reuse across projects, but I didn&rsquo;t organize them, leading to some confusion over the years.</p><p>In a first moment I simply included all basic functions module in all repositories, everything is local, no problem, little effort. The drawback of this approach is that <strong>if I found bug or I create another useful function I need to update all projects</strong>. Over the years I have the very same functions copied over and over leading to confusion.</p><p>This leas to the obvious solution of developing PowerShell modules in a separate repository, then use that repository as submodule in real projects. This situation is far better, but it still not really optimal. As an example, it does not work if your project does not uses Git.</p><p>The real solution is <strong>using a git repository to evolve your modules, then publish them to the official <a href=https://www.powershellgallery.com/>PowerShell Gallery site</a></strong>. There are a lot of reasons to use PowerShell Gallery: the obvious one is that is free and available almost everywhere, then it is a good way to contribute to open source and finally it forces you to manage versioning and evolution of your functions.</p><p>This is perfect if you can open source your functions, but if they contain information that cannot be disclosed, you have always the option to publish in a private repository, so this approach is still valid.</p><p>Since I&rsquo;m not a PowerShell expert I&rsquo;ve started looking to some tutorial on the subject, but I had some problem setting up everything, so <strong>I decided to write this post as a reminder and an helper to those one that want to publish their code to PowerShell Gallery</strong>.</p><p>Basically you are expected to create a psm1 file with all the functions you want to publish, then add a psd1 file to describe the module and finally publish NuGet package to PowerShell gallery with the command</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>Publish-Module -Path C:\develop\GitHub\powershell-build-utils\src\build-utils  -NuGetApiKey your_api_key_here -Verbose</code></pre></td></tr></table></div></div><p>Indeed it was a journey longer than I expected.</p><h2 id=error-1-using-a-nuspec-file-to-publish-the-module>Error 1: using a .nuspec file to publish the module</h2><p>I&rsquo;ve found some blog posts that explain how to create a .psd1 file (module definition) and a .nuspec file (NuGet definition file) to publish your module. While this worked like a charm to publish module to MyGet or other NuGet repositories, I&rsquo;ve failed having it to work with PowerShell Gallery.</p><p>The solution was <strong>to follow the advice of <a href=https://github.com/anpur/powershellget-module>this nice GitHub repository</a> that contains a working sample</strong> on how you should organize the repository to publish everything to PowerShell gallery. From that sample I found that .nuspec file should be avoided letting Publish-Module PowerShell command to do everything.</p><h2 id=error-2-tls-12-and-connection-error>Error 2: TLS 1.2 and connection error</h2><p>My second problem is a cryptic error &ldquo;The underling connection was closed&rdquo;. This can be caused to PowerShell Gallery drop of TLS 1.0 and 1.1, but forcing TLS 1.2 did not solved my problem.</p><p><a target=_blank href=../images/powershell-connection-closed.png><img src=../images/powershell-connection-closed.png alt="PowerShell connection closed"></a>
<em><strong>Figure 1</strong></em>: *PowerShell Publish-Module failed with a Connection Closed error</p><p>Thanks to my Friend Leone Randazzo and the magic team of iCubed composed by: Leone Randazzo, Aaron Toro Araya and Corrado Mollica I was able to solve that problem.</p><p>You can force TLS 1.2 using this instruction before interacting with PowerShell Gallery, (or you can put it in your profile to have TLS 1.2 available for all connections)</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#66d9ef>[System.Net.ServicePointManager]</span>::SecurityProtocol = <span style=color:#66d9ef>[System.Net.ServicePointManager]</span>::SecurityProtocol <span style=color:#f92672>-bor</span> <span style=color:#66d9ef>[System.Net.SecurityProtocolType]</span>::Tls12</code></pre></td></tr></table></div></div><p>But this does not worked in my situation, so Aaron pointed me to a issue due to incomplete Internet Explorer configuration when it was first started. <strong>He gave me some registry Key to solve both the TLS 1.2 problem and incomplete IE configuration.</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>Set-ItemProperty
    -Path <span style=color:#e6db74>&#34;HKLM:\Software\Microsoft\.NetFramework\&lt;TargetVersion&gt;&#34;</span>
    -Name <span style=color:#e6db74>&#34;SchUseStrongCrypto&#34;</span>
    -Value <span style=color:#e6db74>&#34;1&#34;</span>
    -Type DWord
    -Force

Set-ItemProperty
    -Path <span style=color:#e6db74>&#34;HKLM:\Software\Wow6432Node\Microsoft\.NetFramework\&lt;TargetVersion&gt;&#34;</span>
    -Name <span style=color:#e6db74>&#34;SchUseStrongCrypto&#34;</span>
    -Value <span style=color:#e6db74>&#34;1&#34;</span>
    -Type DWord
    -Force

<span style=color:#75715e># Ie problem</span>
Set-ItemProperty
    -Path <span style=color:#e6db74>&#34;HKLM:\ Software\Policies\Microsoft\Internet Explorer\Main&#34;</span>
    -Name <span style=color:#e6db74>&#34; DisableFirstRunCustomize &#34;</span>
    -Value <span style=color:#e6db74>&#34;1&#34;</span>
    -Type DWord
    -Force</code></pre></td></tr></table></div></div><p>Now connection error is gone, but I was presented with another error.</p><h2 id=error-3-index-was-outside-the-bound-of-the-array>Error 3: Index was outside the bound of the array</h2><p>After TLS 1.2 was set, I start having this error, a strange error that happened also when I created nuget packages manually with nuget pack command. I suspected that it was probably a problem in psd1 file, but a check with <strong>Test-ModuleManifest -Path .\BuildUtils.psd1</strong> gives no error.</p><p>Nevertheless I took the psd1 example file from <a href=https://github.com/anpur/powershellget-module>https://github.com/anpur/powershellget-module</a> and modified it to match my need and gotcha, error is gone.</p><p>But I was presented with another error.</p><h2 id=error-4-failed-to-generate-compressed-file>Error 4: Failed To Generate Compressed file</h2><p>I need to tell you that at this point I was pretty frustrated, because now I was left in the dark with another cryptic error that did not give me any clue on what was wrong.</p><p><a target=_blank href=../images/unable-to-compress-file.png><img src=../images/unable-to-compress-file.png alt="Unable to compress file error"></a>
<em><strong>Figure 2</strong></em>: <em>PowerShell Publish-Module failed with a Unable to compress file</em></p><blockquote><p>This final error &ldquo;Failed to generate the compressed file for module&rdquo; really drove me mad.</p></blockquote><p>I had really no idea on what is going on so I&rsquo;ve <strong>first checked that I really have the last version of PowershellGet and Package provider.</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>Get-Module -Name PowerShellGet -ListAvailable | Select-Object -Property Name,Version,Path
Get-PackageProvider -Name NuGet</code></pre></td></tr></table></div></div><p>Then I&rsquo;ve found <strong>various articles on Internet that related this error to NuGet version</strong> used. After upgrading every nuget.exe file I&rsquo;ve found on my disk the error was still there.</p><p>Then I&rsquo;ve found some clue that the error can be indeed due to the fact that I&rsquo;ve installed .NET Core 5 preview, but even that road lead me nowhere.</p><p>Finally, I&rsquo;ve got really frustrated so I decided to <strong>publish the code of the original sample</strong> found at <a href=https://github.com/anpur/powershellget-module>https://github.com/anpur/powershellget-module</a> to verify that I&rsquo;ve no problem in my machine and Bingo: it worked.</p><p>Clearly my module has something wrong but what?? I&rsquo;ve then started removing functions, until I had the code in module with the very same content from the sample. Still it did not work.</p><blockquote><p>At that point I was convinced that then only difference between my module and the sample is in file names.</p></blockquote><p>So I found that the problem was indeed pascalCase of module name. <strong>When I changed the name of my module from build-utils to BuildUtils everything started working.</strong></p><p>So if you got this error please be sure to check that</p><ol><li>You have your script named in CamelCase, like BuildUtils.psm1 and BuildUtils.psd1</li><li>Ensure that both of these files are in a folder with the same name of the module (BuildUtils)</li></ol><p>You can find <a href=https://github.com/AlkampferOpenSource/powershell-build-utils>my module in GitHub</a> if you want to verify how it was done.</p><p>Finally I had my module published and it is ready to be used inside my build and release scripts.</p><p><a target=_blank href=../images/build-utils-module.png><img src=../images/build-utils-module.png alt="Build utils finally published"></a>
<em><strong>Figure 3</strong></em>: <em>Build utils finally published</em></p><p><a target=_blank href=../images/buidl-utils-installed.png><img src=../images/buidl-utils-installed.png alt="Build utils is available for install"></a>
<em><strong>Figure 4</strong></em>: <em>Build utils is available for install</em></p><p>Now you can simply run Install-Module BuildUtils to install your utility functions. This approach is really nice because you <strong>have a single repository with all of your PowerShell utilities</strong> and you can use them from any script with zer problem.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/devops/>DevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/powershell/>PowerShell</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/security/kali-linux-in-wsl2/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Use Kali linux in Windows Subsystem for Linux</a></div><div class="next-entry sep-before"><a href=/post/general/error-in-mongodb-serializer/><span class=screen-reader-text>Next post: </span>Error in mapping MongoDb classes after updating to 2.10 driver<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>