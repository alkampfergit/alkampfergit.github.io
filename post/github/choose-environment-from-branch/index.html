<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In a GitHub action you can have the need to choose the environment to use based on current branch, here is how you can do it."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Choose environment from branch in GitHub action • Codewrecks"><meta property="og:description" content="In a GitHub action you can have the need to choose the environment to use based on current branch, here is how you can do it."><meta property="og:url" content="https://www.codewrecks.com/post/github/choose-environment-from-branch/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="github"><meta property="article:published_time" content="2021-08-18T08:00:00+02:00"><meta property="article:modified_time" content="2021-08-18T08:00:00+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Choose environment from branch in GitHub action • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/github/choose-environment-from-branch/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Choose environment from branch in GitHub action</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Choose environment from branch in GitHub action</h1><p class=desc>In a GitHub action you can have the need to choose the environment to use based on current branch, here is how you can do it.</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2021-08-18T08:00:00+02:00>2021, Aug 18</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>I have a friend that asked me how to <strong>choose an <a href=https://docs.github.com/en/actions/reference/environments>enviroment</a> in a GitHub action based on the branch that triggered the action</strong>. Usually Environments are used in a sort of Promotion mechanism, where you start deploying on Test, then you have a manual or automatic approval to deploy on staging and finally to production. Even if this is a textbook scenario <strong>sometimes you need to create a simple sequence of steps to deploy your software in an environment and you want to choose environment based on branch</strong>. If you deploy master you deploy on production, if you deploy develop you deploy test.</p><blockquote><p>Choosing environment based on branch is a quite common strategy in continuos deployment of small project.</p></blockquote><p>The goal is <strong>having a single Workflow file and, most important, having a single sequence of steps to deploy the application</strong>, so you need to be able to choose the environment at run time based on branch name. The critical part of this action is that you need to create at least two jobs, <strong>the first will use bash (or PowerShell or whathever) to determine the name of the environment, while the second job will use that information to choose the environment</strong>.</p><blockquote><p>Each job can have an environment assigned to it, if that information is parametric you need at least another job to determine environment name.</p></blockquote><p>Here is how I defined the job that uses the environment to perform a deploy, as you can see <strong>the name of the environment is a parameter</strong>, based on a variable that belongs to another job.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#66d9ef>release</span>:
    <span style=color:#66d9ef>needs</span>: [build]
    <span style=color:#66d9ef>name</span>: Release some stuff 
    <span style=color:#66d9ef>runs-on</span>: ubuntu-latest
    <span style=color:#66d9ef>environment</span>: 
      <span style=color:#66d9ef>name</span>: ${{ needs.build.outputs.env_name }}</code></pre></td></tr></table></div></div><p>If you look closely, in <strong>line 6</strong> we are specifying the name of the environment with a special syntax. It starts with needs to indicate that the variable does not belongs to this job but belongs to some needs, then you need to specify the name of the other job (in this example is called build) followed by the outputs keyword and the name of the output variable to reference. The whole syntax works because the <strong>build jobs will export a variable called env_name to be consumed by dependant jobs</strong>. It is of uttermost importance that you specify the other job as need (<strong>line 2</strong>)</p><blockquote><p>Since each jobs runs in a different container, to be able to pass data between jobs, each jobs should export variables explictly</p></blockquote><p>With multiple jobos you cannot work with environment variables, remember that each job runs <strong>in a different container, so every environment variable that you define in a job is not present when another job runs</strong>. The correct solution is to define a variable using GitHub Action own syntax, then export the variable outside the job to be used in all jobs that depends on the current one. Here is the code.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#66d9ef>name</span>: Some check on branch
        <span style=color:#66d9ef>id</span>: branch_check
        <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>          echo &#34;Running on branch ${{ github.ref }}&#34;</span>
          if [ <span style=color:#e6db74>&#34;${{ github.ref }}&#34;</span> = <span style=color:#e6db74>&#34;refs/heads/master&#34;</span> ]; then
            echo <span style=color:#e6db74>&#34;::set-output name=env_name::Production&#34;</span>
          elif [ <span style=color:#e6db74>&#34;${{ github.ref }}&#34;</span> = <span style=color:#e6db74>&#34;refs/heads/develop&#34;</span> ]; then
            echo <span style=color:#e6db74>&#34;::set-output name=env_name::Test&#34;</span>
          else
             echo <span style=color:#e6db74>&#34;::set-output name=env_name::Features&#34;</span>
          fi         
          
      - <span style=color:#66d9ef>name</span>: Use variable setup in previous step
        <span style=color:#66d9ef>run</span>: echo <span style=color:#e6db74>&#34;I&#39;m using variable ${{ steps.branch_check.outputs.env_name }}&#34;</span>
        
    <span style=color:#66d9ef>outputs</span>:
      <span style=color:#66d9ef>env_name</span>: ${{ steps.branch_check.outputs.env_name }}</code></pre></td></tr></table></div></div><p>Build job is really simple, first of all it will use some bash to set the value of the <strong>env_name variable using the ::set-output command</strong>. You can find <a href=https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions>all avaliable command directly in the documentation</a>. The ::set-output command is used to set a value in a variable that can be used in subsequent steps with the syntax</p><p><em>${{ steps.<strong>id_of_the_step</strong>.outputs.<strong>variable_name</strong> }}</em>&rdquo;</p><p>You need to remember that the <strong>value of the variable is available only in the jobs where the command runs</strong>. If you look at the snippet you can see that the line 14 is using the value of the output variable with the above syntax, but this is valid only for steps in the same job.</p><blockquote><p>All variables values are not automatically transferred between jobs.</p></blockquote><p>If you want a variable to be available to other jobs <strong>you need to specify an output section (line 16) where you can export variables/values outside the job</strong>. In the above example I&rsquo;m using the same env_name value, but you can change the name if you like. Line 17 is simply declaring <strong>that this job will export a env_name variable whose value is the same of the env_name variable of the step branch_check</strong>.</p><p>The whole example is in the project <a href=https://github.com/alkampfergit/ActionsPlayground>ActionsPlayground</a>. If you look at <strong>Figure 1</strong> you can see the result of a run in master branch.</p><p><a target=_blank href=../images/action-run-on-master.png><img src=../images/action-run-on-master.png alt="Run result on master branch"></a></p><p><em><strong>Figure 1:</strong></em> <em>Run result on master branch</em>.</p><p>Since the run is done on master branch, I can check the log to verify that everything is correct and I&rsquo;m deploying on the Production environment. In <strong>Figure 2</strong> you can verify that the <strong>bash step correctly identified master branch and the value of env_name variable is Production.</strong></p><p><a target=_blank href=../images/output-of-branch-check-step.png><img src=../images/output-of-branch-check-step.png alt="Since the run was triggered by master branch, environment name is Production"></a></p><p><em><strong>Figure 2:</strong></em> <em>Since the run was triggered by master branch, environment name is Production</em>.</p><p>To verify that I&rsquo;m indeed using the correct environment I&rsquo;ve dumped a value of a secret defined in environment in base64 (if you try to output raw value it will be removed from the infrastructure). In <strong>Figure 3</strong> you can see the result.</p><p><a target=_blank href=../images/output-of-environment-production-job.png><img src=../images/output-of-environment-production-job.png alt="Dump of a secret in base64 format"></a></p><p><em><strong>Figure 3:</strong></em> <em>Dump of a secret in base64 format</em>.</p><p>A quick verify with CyberChef will confirm that the value of the secret is taken from the correct environment.</p><p><a target=_blank href=../images/cyber-chef-output.png><img src=../images/cyber-chef-output.png alt="Cyber chef verification of secret value"></a></p><p><em><strong>Figure 4:</strong></em> <em>Cyber chef verification of secret value</em>.</p><p>To recap we</p><ol><li>Created a bash script that will set a variable with the environment we want to use</li><li>Exported that variable from the job</li><li>Create the real deploy job that depend via needs to the previous job</li><li>Parametrize the environment name using the variable exported from previous job.</li></ol><p>And the game is done.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/security/>security</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/github/>github</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/general/some-thoughts-over-7zip/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Fine control of compression level in 7zip</a></div><div class="next-entry sep-before"><a href=/post/github/codespaces-hugo/><span class=screen-reader-text>Next post: </span>Use GitHub codespaces to author blog post<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>