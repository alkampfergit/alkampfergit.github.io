<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Strange errors happened if you try to test dotnetcore project compiled for x86 architecture"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="How to run x86 Unit Test in a .NET core application • Codewrecks"><meta property="og:description" content="Strange errors happened if you try to test dotnetcore project compiled for x86 architecture"><meta property="og:url" content="https://www.codewrecks.com/post/visualstudio/dotnetcore-run-test-x86/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="UnitTesting"><meta property="article:published_time" content="2020-05-06T21:45:18+02:00"><meta property="article:modified_time" content="2020-05-06T21:45:18+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>How to run x86 Unit Test in a .NET core application • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/visualstudio/dotnetcore-run-test-x86/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>How to run x86 Unit Test in a .NET core application</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>How to run x86 Unit Test in a .NET core application</h1><p class=desc>Strange errors happened if you try to test dotnetcore project compiled for x86 architecture</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-05-06T21:45:18+02:00>2020, May 06</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>3 mins read</span></div></div></header><div class="container entry-content"><p>We have a standard .NET standard solution with some projects and some Unit Tests, <strong>everything runs perfectly until we have the need to force compilation of one of the project in x86</strong>. This can be done with RuntimeIdentifier tag in project file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;Project</span> <span style=color:#a6e22e>Sdk=</span><span style=color:#e6db74>&#34;Microsoft.NET.Sdk&#34;</span><span style=color:#f92672>&gt;</span>

  <span style=color:#f92672>&lt;PropertyGroup&gt;</span>
    <span style=color:#f92672>&lt;TargetFramework&gt;</span>netcoreapp3.1<span style=color:#f92672>&lt;/TargetFramework&gt;</span>
    <span style=color:#f92672>&lt;RuntimeIdentifier&gt;</span>win-x86<span style=color:#f92672>&lt;/RuntimeIdentifier&gt;</span>
  <span style=color:#f92672>&lt;/PropertyGroup&gt;</span></code></pre></div><p>After this modification <strong>tests started to fail with an error</strong> that is clearly directly related to the change in runtime, but was highly unexpected.</p><pre><code>System.BadImageFormatException : 
Could not load file or assembly 'xxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null'. 
An attempt was made to load a program with an incorrect format.
</code></pre><p>This is an error that happens when a <strong>project running in x64 is trying to load a program that was explicitly compiled to run only in x86 version (32 bit)</strong>. The very same error happened if we run <em>dotnet test</em> in command line. We tried using the same RuntimeIdentifier on test project, but the situation is even worse, tests disappeared from test runner, test adapter was not even capable of scanning the assembly looking for tests. It seems that Visual Studio was not able to run tests compiled in x86.</p><p>After some investigation it turns out that if you want to run test for an assembly that target x86 architecture, <strong>you should use x86 version of dotnet.exe tool.</strong> To verify this assumption we tried to run test with commandline dontnet.exe tool using standard &ndash;runtime option</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dotnet test --runtime win-x86
</code></pre></div><p>Tests become green again, confirming us that this is indeed the right solution. Now the remaining problem is: <strong>how to configure Visual Studio to run test in x86 mode.</strong> The only obvious solution is to use a runsettings file, a type of file that was present in Visual Studio for a really long time, whose purpose is to configure test environment.</p><blockquote><p>Whenever you need to customize how Visual Studio is running tests, you probably need a .runsettings file.</p></blockquote><p>We created a test.runsettings file at the root of the solution (We have more than one test projects) with this simple content.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style=color:#f92672>&lt;RunSettings&gt;</span>
  <span style=color:#75715e>&lt;!-- Configurations that affect the Test Framework --&gt;</span>
  <span style=color:#f92672>&lt;RunConfiguration&gt;</span>

    <span style=color:#75715e>&lt;!-- x86 or x64 --&gt;</span>
    <span style=color:#75715e>&lt;!-- You can also change it from the Test menu; choose &#34;Processor Architecture for AnyCPU Projects&#34; --&gt;</span>
    <span style=color:#f92672>&lt;TargetPlatform&gt;</span>x86<span style=color:#f92672>&lt;/TargetPlatform&gt;</span>

  <span style=color:#f92672>&lt;/RunConfiguration&gt;</span>
<span style=color:#f92672>&lt;/RunSettings&gt;</span></code></pre></div><p>The only special settings is the TargetPlatform that forces running test in x86. To simplify configuration, instead of requiring all developers to choose that settings before running tests, <strong>we use a little know feature (I&rsquo;ve discovered today) that allows you to specify runsettings file directly inside a project file.</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;Project</span> <span style=color:#a6e22e>Sdk=</span><span style=color:#e6db74>&#34;Microsoft.NET.Sdk&#34;</span><span style=color:#f92672>&gt;</span>

  <span style=color:#f92672>&lt;PropertyGroup&gt;</span>
    <span style=color:#f92672>&lt;TargetFramework&gt;</span>netcoreapp3.1<span style=color:#f92672>&lt;/TargetFramework&gt;</span>
    <span style=color:#f92672>&lt;IsPackable&gt;</span>false<span style=color:#f92672>&lt;/IsPackable&gt;</span>
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&lt;RunSettingsFilePath&gt;</span>$(MSBuildProjectDirectory)\..\..\..\test.runsettings<span style=color:#f92672>&lt;/RunSettingsFilePath&gt;</span>
</span>  <span style=color:#f92672>&lt;/PropertyGroup&gt;</span></code></pre></td></tr></table></div></div><p>Thanks to RunSettingsFilePath we could specify that for that specific test project, we want test runner to use specified runsettings file (line 6). Using relative path relative to project directory will allow using a single runsettings file for all tests project. Once test projects are modified, a simple rebuild should fix all the tests.</p><p>All tests are now green again.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/developing/>developing</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/unittesting/>UnitTesting</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/general/advantage-of-hugo/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Advantage of Hugo</a></div><div class="next-entry sep-before"><a href=/post/security/play-security-in-a-secure-environment/><span class=screen-reader-text>Next post: </span>Play security in a secure environment<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>