<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In my post “Associate Work Items to check-in in a TF Service Git Enabled repository” I explained how simple is to associate a commit in git to a Work Item simply inserting an hashtag followed by the id of the work item. Some of my friend and colleagues told me that it would be nice to have such kind of integration even in standard TFS VCS. This feature can be extremely useful for people not using Visual Studio, or people that are lovers of command line (TFS has the tf."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="TFS Api to associate work item with check-in using comment tags • Codewrecks"><meta property="og:description" content="In my post “Associate Work Items to check-in in a TF Service Git Enabled repository” I explained how simple is to associate a commit in git to a Work Item simply inserting an hashtag followed by the id of the work item. Some of my friend and colleagues told me that it would be nice to have such kind of integration even in standard TFS VCS. This feature can be extremely useful for people not using Visual Studio, or people that are lovers of command line (TFS has the tf."><meta property="og:url" content="https://www.codewrecks.com/post/old/2013/02/tfs-api-to-associate-work-item-with-check-in-using-comment-tags/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Tfs"><meta property="article:published_time" content="2013-02-02T09:00:37+02:00"><meta property="article:modified_time" content="2013-02-02T09:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>TFS Api to associate work item with check-in using comment tags • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2013/02/tfs-api-to-associate-work-item-with-check-in-using-comment-tags/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>TFS Api to associate work item with check-in using comment tags</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>TFS Api to associate work item with check-in using comment tags</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2013-02-02T09:00:37+02:00>2013, Feb 02</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>In my post “<a href=http://www.codewrecks.com/blog/index.php/2013/01/31/associate-work-items-to-check-in-in-a-tf-service-git-enabled-repository/>Associate Work Items to check-in in a TF Service Git Enabled repository</a>” I explained how simple is to <strong>associate a commit in git to a Work Item simply inserting an hashtag followed by the id of the work item</strong>. Some of my friend and colleagues told me that it would be nice to have such kind of integration even in standard TFS VCS. This feature can be extremely useful for people not using Visual Studio, or people that are lovers of command line (TFS has the tf.exe command that permits you do do everything you need to do).</p><p>The solution is really simple, because * <strong>thanks to TFS API you can build a little utility that simply scans your TFS for check-ins, find all comments that contains #xxx code and create the association between the ChangesetId and the Work Item</strong> *. The code is really simple, first of all get a reference to all check-ins of the project</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// get a reference to the team project collection
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> projectCollection = TfsTeamProjectCollectionFactory.GetTeamProjectCollection(collectionUri))
{
    <span style=color:#75715e>// get a reference to the work item tracking service
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> workItemStore = projectCollection.GetService&lt;WorkItemStore&gt;();

    <span style=color:#66d9ef>var</span> teamProject = workItemStore.Projects
       .OfType&lt;Project&gt;()
       .Single(proj =&gt; proj.Name == <span style=color:#e6db74>&#34;FabrikamFiber&#34;</span>);

    <span style=color:#75715e>//now look for all the changeset
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> versionControl = projectCollection.GetService&lt;VersionControlServer&gt;();
    ChangesetVersionSpec versionFrom = <span style=color:#66d9ef>new</span> ChangesetVersionSpec(<span style=color:#ae81ff>1</span>);
    VersionSpec versionTo = VersionSpec.Latest;

    <span style=color:#66d9ef>var</span> changesets = versionControl.QueryHistory(
        <span style=color:#e6db74>&#34;$/FabrikamFiber&#34;</span>,
        versionTo,
        <span style=color:#ae81ff>0</span>,
        RecursionType.Full,
        <span style=color:#66d9ef>null</span>,
        versionFrom,
        versionTo,
        Int32.MaxValue,
        <span style=color:#66d9ef>true</span>,
        <span style=color:#66d9ef>false</span>
        );
</code></pre></td></tr></table></div></div><p>This code will get a reference for all the changesets of the project, to make it “production-ready” you should store the latest changeset id scanned, so at each run it will scan only newest changesets, but remember that developers can change the comment at any time, so a full scan it should be done from time to time. Now it <strong>is just a matter of cycling thought all changesets to find comments that contains association tag #workitemid</strong><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>foreach</span> (Changeset changeset <span style=color:#66d9ef>in</span> changesets)
{
    Console.WriteLine(<span style=color:#e6db74>&#34;Analyzing changeset {0}&#34;</span>, changeset.ChangesetId);
    <span style=color:#66d9ef>var</span> comment = changeset.Comment;
    <span style=color:#66d9ef>var</span> matches = Regex.Matches(comment, <span style=color:#e6db74>@&#34;#(?&lt;id&gt;\d+)&#34;</span>);
    <span style=color:#66d9ef>foreach</span> (Match match <span style=color:#66d9ef>in</span> matches)
    {
        <span style=color:#75715e>//I have an association on the form #changesetid
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>var</span> id = Int32.Parse(match.Groups[<span style=color:#e6db74>&#34;id&#34;</span>].Value);
        <span style=color:#66d9ef>var</span> workItem = workItemStore.GetWorkItem(id);

        <span style=color:#75715e>//now create the link
</span><span style=color:#75715e></span>        ExternalLink changesetLink = <span style=color:#66d9ef>new</span> ExternalLink(
            workItemStore.RegisteredLinkTypes[ArtifactLinkIds.Changeset],
            changeset.ArtifactUri.AbsoluteUri);
        <span style=color:#75715e>//you should verify if such a link already exists
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (!workItem.Links.OfType&lt;ExternalLink&gt;()
           .Any(l =&gt; l.LinkedArtifactUri == changeset.ArtifactUri.AbsoluteUri))
        {
            Console.WriteLine(<span style=color:#e6db74>&#34;\tAssociate changeset {0} to Work Item {1}:{2}&#34;</span>, 
                changeset.ChangesetId,
                workItem.Id,
                workItem.Title);
            workItem.Links.Add(changesetLink);
            workItem.Save();
        }
    }
}
</code></pre></td></tr></table></div></div></p><p>As you can verify it is just a matter of scanning the comment, use a regular expression to find all #wid pattern, then for each work item you need to associate:</p><ol><li>query it from the WorkItemStore</li><li>create a new link of type Changeset</li><li>finally verify if the Work Item has not already been associated to that Work Item, to avoid creating multiple association if you run this tool multiple times against all changesets.</li></ol><p>To verify that everything works as expected, simply create a comment with tags association</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image_thumb3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image_thumb3.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>This comment will associate the changeset to Work Items 46 and 47, the Changeset does not have any associated WI</em></p><p>Now run the tool and you should got something like this.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image_thumb4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image_thumb4.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>The tool correctly associate Work Items to changeset based on comment content</em></p><p>Now you can run the tool again to verify that this second run no association will be done because the link was already in place and clearly refresh the changeset details to verify if the association was correctly done.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image5.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image_thumb5.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2013/02/image_thumb5.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Association is now correctly done between the Changeset and work items</em></p><p><a href=http://sdrv.ms/14wkKRe>The code is here</a> <a href=http://sdrv.ms/14wkKRe title=http://sdrv.ms/14wkKRe>http://sdrv.ms/14wkKRe</a>. Remember that this is just a quick experiment, and you should probably improve it to be really production-ready :).</p><p>Happy TFS.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/team-foundation-server/>Team Foundation Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/tfs/>Tfs</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2013/02/remove-git-tf-tracked-branch-after-a-move-from-standard-tf-service-project-to-git-enabled-project/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Remove git-tf tracked branch after a move from standard TF Service project to Git enabled project</a></div><div class="next-entry sep-before"><a href=/post/old/2013/02/visual-studio-alm-linksweek-5-2013/><span class=screen-reader-text>Next post: </span>Visual Studio ALM Links-Week 5 2013<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>