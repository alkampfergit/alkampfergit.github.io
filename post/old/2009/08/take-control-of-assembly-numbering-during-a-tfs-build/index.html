<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="One of the most important stuff in a project build, is the ability to mark the assemblies with unique numbers that permits us to reproduce the build. Tfs does not have a standard way of doing this, but with a couple of MsBuild actions it is really simple to overcome this limitation. This is a good example that shows how you can extend build script to do complex task.
First of all I want to change only AssemblyFileVersion and not the AssemblyVersion, in this way all builds are compatible until someone manually changes AssemblyVersion."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Take control of assembly numbering during a tfs build • Codewrecks"><meta property="og:description" content="One of the most important stuff in a project build, is the ability to mark the assemblies with unique numbers that permits us to reproduce the build. Tfs does not have a standard way of doing this, but with a couple of MsBuild actions it is really simple to overcome this limitation. This is a good example that shows how you can extend build script to do complex task.
First of all I want to change only AssemblyFileVersion and not the AssemblyVersion, in this way all builds are compatible until someone manually changes AssemblyVersion."><meta property="og:url" content="https://www.codewrecks.com/post/old/2009/08/take-control-of-assembly-numbering-during-a-tfs-build/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Msbuild"><meta property="article:tag" content="TeamFoundationServer"><meta property="article:tag" content="TfsBuild"><meta property="article:published_time" content="2009-08-21T06:00:37+02:00"><meta property="article:modified_time" content="2009-08-21T06:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Take control of assembly numbering during a tfs build • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2009/08/take-control-of-assembly-numbering-during-a-tfs-build/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Take control of assembly numbering during a tfs build</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Take control of assembly numbering during a tfs build</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2009-08-21T06:00:37+02:00>2009, Aug 21</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>9 mins read</span></div></div></header><div class="container entry-content"><p>One of the most important stuff in a project build, is <em>the ability to mark the assemblies with unique numbers that permits us to reproduce the build</em>. Tfs does not have a standard way of doing this, but with a couple of MsBuild actions it is really simple to overcome this limitation. This is a good example that shows how you can extend build script to do complex task.</p><p>First of all I want to change only <a href=http://msdn.microsoft.com/en-us/library/system.reflection.assemblyfileversionattribute.aspx>AssemblyFileVersion</a> and not the AssemblyVersion, in this way all builds are compatible until someone manually changes AssemblyVersion. A standard technique I like very much is letting the programmers to <em>manage major and minor number manually</em>, and <em>letting my builds generates build and revision ones</em>. For build number I want to be able to generate a unique number each build, a sequential generator will be fine; but for revision number I want to use the changeset used to generate the build. To accomplish this we need essentially four macro steps.</p><p><a target=_blank href=http://yuml.me/45c1d876><img src=http://yuml.me/45c1d876 alt></a></p><p>In the first step I need to generate unique integer build number, most of the time sequential generator is ok, then I need also to find a way to correlate this generated number with the build label of the TFS. Step two is used to find latest changeset, then in step three we need to check-in modified files (the one used by the generator), being sure that this check-in does not trigger another build, finally we need to modify a file named ProjectVersion.cs that is used by all projects.</p><p>To modify AssemblyFileVersion for a project I love this technique: I remove AssemblyFileVersion and AssemblyVersion attributes from assemblyinfo.cs, put them in a single <strong>ProjectVersion.cs</strong> file stored in the root of the team project. Here is a typical content for the ProjectVersion.cs.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>using</span> System.Reflection;
<span style=color:#a6e22e>[assembly: AssemblyVersion(&#34;1.2.0.0&#34;)]</span>
<span style=color:#a6e22e>[assembly: AssemblyFileVersion(&#34;1.2.0.0&#34;)]</span>
</code></pre></td></tr></table></div></div><p>Next I import this file as link in every project that belong to this team project</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image25.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb25.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb25.png alt=image></a></a></p><p>With this little trick to change AssemblyFileVersion attribute for every project I<em>need only to change one file.</em> Now it is time to build some custom tasks that will help us to manage the whole process, first of all the task that generates unique numbers and correlate them with build label.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CSharp data-lang=CSharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BuildVersionNumberManagerTask</span> : Task
{
    <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// Filename that will store the versions
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span><span style=color:#a6e22e>    [Required]</span>
    <span style=color:#66d9ef>public</span> String VersionFileName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }

    <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// label of the current build.
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span><span style=color:#a6e22e>    [Required]</span>
    <span style=color:#66d9ef>public</span> String BuildLabel { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }

    <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// new incremental version numer.
</span><span style=color:#75715e></span>    <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span><span style=color:#a6e22e>    [Output]</span>
    <span style=color:#66d9ef>public</span> Int32 NewVersionNumber { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>bool</span> Execute()
    {
        <span style=color:#66d9ef>if</span> (!File.Exists(VersionFileName))
        {
            Log.LogError(<span style=color:#e6db74>&#34;The file {0}[{1}] with version number does not exists&#34;</span>, VersionFileName, Path.GetFullPath(VersionFileName));
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
        }
        String[] allLines = File.ReadAllLines(VersionFileName);
        String startChar = <span style=color:#e6db74>&#34;&#34;</span>;
        <span style=color:#66d9ef>if</span> (allLines.Length &gt; <span style=color:#ae81ff>0</span> &amp;&amp; !String.IsNullOrEmpty(allLines[allLines.Length - <span style=color:#ae81ff>1</span>]))
        {
            startChar = <span style=color:#e6db74>&#34;\n&#34;</span>;
            String lastline = allLines[allLines.Length - <span style=color:#ae81ff>1</span>];
            String lastNum = lastline.Substring(<span style=color:#ae81ff>0</span>, lastline.IndexOf(<span style=color:#e6db74>&#34;|&#34;</span>));
            Int32 lastNumber;
            <span style=color:#66d9ef>if</span> (!Int32.TryParse(lastNum, <span style=color:#66d9ef>out</span> lastNumber))
            {
                Log.LogError(<span style=color:#e6db74>&#34;There are errors in the version file, the last line does not contains lastnum|lastlabel valid format&#34;</span>);
                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
            }
            NewVersionNumber = lastNumber + <span style=color:#ae81ff>1</span>;
        } <span style=color:#66d9ef>else</span>
        {
            <span style=color:#75715e>//There is no lines, or the last line is empty.
</span><span style=color:#75715e></span>            NewVersionNumber = <span style=color:#ae81ff>1</span>;
        }
        String newLastLine = String.Format(<span style=color:#e6db74>&#34;{0}{1}|{2}&#34;</span>,startChar,  NewVersionNumber, BuildLabel);
        File.AppendAllText(VersionFileName, newLastLine);
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
    }
}
</code></pre></td></tr></table></div></div><p>The BuildVersionNumberManagerTask is responsible of the generation of a sequential number, as well as storing in a file the relationship between autogenerated numbers and build labels. It use a simple text file and write a line for each generated number. Here is an example of file content.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>...
<span style=color:#ae81ff>3</span>|Standard build <span style=color:#66d9ef>for</span> CI_20090820.<span style=color:#ae81ff>20</span>
<span style=color:#ae81ff>4</span>|Standard build <span style=color:#66d9ef>for</span> CI_20090820.<span style=color:#ae81ff>21</span>
<span style=color:#ae81ff>5</span>|Standard build <span style=color:#66d9ef>for</span> CI_20090820.<span style=color:#ae81ff>24</span>
...
</code></pre></td></tr></table></div></div><p>With such a technique, we can immediately find the build label associated with each auto generated number. Now if you have problem with an assembly that have 4 as the build number, I immediately find in the file that it was build by * <strong>Standard build for CI_20090820.21</strong> * Here is how I call this task into TFSBuild.proj file</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;PropertyGroup&gt;</span>
        <span style=color:#f92672>&lt;tfTool&gt;</span>&#34;C:\Program Files\Microsoft Visual Studio 9.0\Common7\IDE\tf.exe&#34;<span style=color:#f92672>&lt;/tfTool&gt;</span>
       ...
<span style=color:#f92672>&lt;Target</span> <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;BeforeCompile&#34;</span> <span style=color:#a6e22e>Condition=</span><span style=color:#e6db74>&#34; &#39;$(IsDesktopBuild)&#39; != &#39;true&#39; &#34;</span><span style=color:#f92672>&gt;</span>
        <span style=color:#f92672>&lt;Message</span> <span style=color:#a6e22e>Text=</span><span style=color:#e6db74>&#34;Beginning generation of new AssemblyFileVersionAttribute&#34;</span> <span style=color:#f92672>/&gt;</span>
        <span style=color:#f92672>&lt;Exec</span> <span style=color:#a6e22e>Command=</span><span style=color:#e6db74>&#34;$(tfTool) checkout..\sources\src\StandardBuildForCIVersion.txt&#34;</span>  <span style=color:#f92672>/&gt;</span>
        <span style=color:#f92672>&lt;BuildVersionNumberManagerTask</span>
            <span style=color:#a6e22e>VersionFileName=</span><span style=color:#e6db74>&#34;..\sources\src\StandardBuildForCIVersion.txt&#34;</span>
            <span style=color:#a6e22e>BuildLabel=</span><span style=color:#e6db74>&#34;$(BuildNumber)&#34;</span><span style=color:#f92672>&gt;</span>
            <span style=color:#f92672>&lt;Output</span> <span style=color:#a6e22e>TaskParameter=</span><span style=color:#e6db74>&#34;NewVersionNumber&#34;</span> <span style=color:#a6e22e>PropertyName=</span><span style=color:#e6db74>&#34;NewVersionNumber&#34;</span> <span style=color:#f92672>/&gt;</span>
        <span style=color:#f92672>&lt;/BuildVersionNumberManagerTask&gt;</span></code></pre></td></tr></table></div></div><p>I override the BeforeCompile task, since I need to change version number before the compile phase. As you can see <em>I use the Exex command to call the tf.exe tool to checkout the file</em> * <strong>StandardBuildForCIVersion.txt</strong> *, the one used to store autogenerated numbers. In this way I can use a different file for each build definition or I can use same file for different builds, I have great flexibility. The checkout is needed because I want to check in modified file at the end of the process, in this way the autogenerated number can be accessed from other build agents. Then I need another custom task capable to modify the ProjectVersion.cs file.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CSharp data-lang=CSharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AssemblyInfoVersionManagerTask</span> : Task
{
<span style=color:#a6e22e>    [Required]</span>
    <span style=color:#66d9ef>public</span> String AssemblyInfoFileName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [Required]</span>
    <span style=color:#66d9ef>public</span> Int32 NewBuildNumber { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [Required]</span>
    <span style=color:#66d9ef>public</span> Int32 NewRevisionNumber { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>bool</span> Execute()
    {
        <span style=color:#66d9ef>if</span> (!File.Exists(AssemblyInfoFileName))
        {
            Log.LogError(<span style=color:#e6db74>&#34;The file {0} does not exists&#34;</span>, AssemblyInfoFileName);
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
        }
        String filecontent = File.ReadAllText(AssemblyInfoFileName);
        Match curVersionMatch =
            Regex.Match(filecontent, <span style=color:#e6db74>&#34;AssemblyVersion\\(\&#34;(?&lt;curversion&gt;.*?)\&#34;\\)&#34;</span>);
        <span style=color:#66d9ef>if</span> (!curVersionMatch.Success)
        {
            Log.LogError(<span style=color:#e6db74>&#34;The content of file {0} does not contains valid Assemblyversion attribute&#34;</span>);
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
        }
        String curversion = curVersionMatch.Groups[<span style=color:#e6db74>&#34;curversion&#34;</span>].Value;
        String[] versionParts = curversion.Split(<span style=color:#e6db74>&#39;.&#39;</span>);
        String newVersion = String.Format(<span style=color:#e6db74>&#34;{0}.{1}.{2}.{3}&#34;</span>, versionParts[<span style=color:#ae81ff>0</span>], versionParts[<span style=color:#ae81ff>1</span>], NewBuildNumber, NewRevisionNumber);
        String newFileContent = Regex.Replace(
            filecontent,
            <span style=color:#e6db74>&#34;AssemblyFileVersion\\(\&#34;(?&lt;curversion&gt;.*?)\&#34;\\)&#34;</span>,
            String.Format(<span style=color:#e6db74>@&#34;AssemblyFileVersion(&#34;&#34;{0}&#34;&#34;)&#34;</span>, newVersion));
        FileAttributes currentFileAttributes = File.GetAttributes(AssemblyInfoFileName);
        File.SetAttributes(AssemblyInfoFileName, FileAttributes.Normal);
        File.WriteAllText(AssemblyInfoFileName, newFileContent);
        File.SetAttributes(AssemblyInfoFileName, currentFileAttributes);
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
    }
}
</code></pre></td></tr></table></div></div><p>This is another simple task, it uses a little bit of regular expression to find actual version number stored in the ProjectVersion.cs, then it creates another version number with simple composition. <strong>Major and minor number are taken from the original content, while build and revision are passed by the caller</strong>. Remember also to remove the Readonly attribute from the file, because it is usually readonly since it is under version control. Now I need the last piece, a simple TfTask that permits me to grab the changeset number associated with the current project.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CSharp data-lang=CSharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TfTask</span> : ToolTask
{
    <span style=color:#66d9ef>public</span> TfTask()
    {
        ToolPath = <span style=color:#e6db74>@&#34;C:\Program Files\Microsoft Visual Studio 9.0\Common7\IDE\&#34;</span>;
    }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [Required]</span>
    <span style=color:#66d9ef>public</span> String Operation { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [Output]</span>
    <span style=color:#66d9ef>public</span> String TfOutput { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }

    <span style=color:#66d9ef>public</span> String TfsUrl { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }

    <span style=color:#66d9ef>public</span> String TeamProject { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }

    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>int</span> ExecuteTool(<span style=color:#66d9ef>string</span> pathToTool, <span style=color:#66d9ef>string</span> responseFileCommands, <span style=color:#66d9ef>string</span> commandLineCommands)
    {
        TfTaskOperation operation = (TfTaskOperation)Enum.Parse(<span style=color:#66d9ef>typeof</span>(TfTaskOperation), Operation);
        String commandline;
        <span style=color:#66d9ef>switch</span> (operation)
        {
            <span style=color:#66d9ef>case</span> TfTaskOperation.GetLatestChangeset:
                commandline = String.Format(
                    <span style=color:#e6db74>&#34;history /s:{0} /stopafter:1 /noprompt /recursive /version:T $/{1}&#34;</span>, TfsUrl, TeamProject);
                <span style=color:#66d9ef>break</span>;
            <span style=color:#66d9ef>default</span>:
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException();
        }
        <span style=color:#66d9ef>using</span> (System.Diagnostics.Process process = <span style=color:#66d9ef>new</span> System.Diagnostics.Process())
        {
            process.StartInfo.FileName = Path.GetFullPath(pathToTool);
            process.StartInfo.Arguments = commandline;
            process.StartInfo.WorkingDirectory = Path.GetDirectoryName(pathToTool);
            process.StartInfo.WindowStyle = ProcessWindowStyle.Normal;
            process.StartInfo.UseShellExecute = <span style=color:#66d9ef>false</span>;
            <span style=color:#75715e>//process.StartInfo.ErrorDialog = false;
</span><span style=color:#75715e></span>            <span style=color:#75715e>//process.StartInfo.CreateNoWindow = true;
</span><span style=color:#75715e></span>            process.StartInfo.RedirectStandardOutput = <span style=color:#66d9ef>true</span>;
            process.Start();
            process.WaitForExit();
            TfOutput = process.StandardOutput.ReadToEnd();
        }
        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
    }

    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>string</span> GenerateFullPathToTool()
    {
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotImplementedException();
    }

    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>string</span> ToolName
    {
        <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;tf.exe&#34;</span>; }
    }
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> TfTaskOperation
{
    GetLatestChangeset = <span style=color:#ae81ff>0</span>,
}
</code></pre></td></tr></table></div></div><p>This is a simple wrapper to the tf.exe tool, and since I invoke it with the System.Diagnostic.Process class, <em>I&rsquo;m able to intercept the output</em>. There are a lot of possibilities on how to get latest changeset, but the simplest is to invoke tf.exe with a command line like this: <strong>tf.exe history /s:http://tfsalkampfer:8080 /stopafter:1 /noprompt /recursive /version:T $/MsBuildExtension</strong> This This command gives a result like this one.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>Changeset User          Date       Comment
--------- ------------- ---------- ---------------------------------
<span style=color:#ae81ff>129</span>       TfsService    <span style=color:#ae81ff>8</span>/<span style=color:#ae81ff>21</span>/<span style=color:#ae81ff>2009</span>  * **NO_CI** *
</code></pre></td></tr></table></div></div><p>That can be parsed with a simple regular expression, here is the remaining of the build script.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;TfTask</span> 
    <span style=color:#a6e22e>TfsUrl=</span><span style=color:#e6db74>&#34;$(TeamFoundationServerUrl)&#34;</span> 
    <span style=color:#a6e22e>TeamProject=</span><span style=color:#e6db74>&#34;$(TeamProject)&#34;</span> 
    <span style=color:#a6e22e>Operation=</span><span style=color:#e6db74>&#34;GetLatestChangeset&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;Output</span>    <span style=color:#a6e22e>TaskParameter=</span><span style=color:#e6db74>&#34;TfOutput&#34;</span> <span style=color:#a6e22e>PropertyName=</span><span style=color:#e6db74>&#34;historyOutput&#34;</span><span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;/TfTask&gt;</span>

<span style=color:#f92672>&lt;Message</span> <span style=color:#a6e22e>Text=</span><span style=color:#e6db74>&#34;historyOutput is $(historyOutput)&#34;</span> <span style=color:#f92672>/&gt;</span>

<span style=color:#f92672>&lt;RegexTask</span> <span style=color:#a6e22e>TextToMatch=</span><span style=color:#e6db74>&#34;$(historyOutput)&#34;</span> <span style=color:#a6e22e>Regex=</span><span style=color:#e6db74>&#34;\n(?&amp;lt;changeset&amp;gt;\d+)&#34;</span> <span style=color:#a6e22e>FailIfNoMatch=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#a6e22e>GroupName=</span><span style=color:#e6db74>&#34;changeset&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;Output</span>
         <span style=color:#a6e22e>TaskParameter=</span><span style=color:#e6db74>&#34;Result&#34;</span>
         <span style=color:#a6e22e>PropertyName=</span><span style=color:#e6db74>&#34;lastChangeset&#34;</span><span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;/RegexTask&gt;</span>

<span style=color:#f92672>&lt;AssemblyInfoVersionManagerTask</span>
    <span style=color:#a6e22e>AssemblyInfoFileName=</span><span style=color:#e6db74>&#34;..\sources\src\ProjectVersion.cs&#34;</span>
    <span style=color:#a6e22e>NewBuildNumber=</span><span style=color:#e6db74>&#34;$(NewVersionNumber)&#34;</span>
    <span style=color:#a6e22e>NewRevisionNumber=</span><span style=color:#e6db74>&#34;$(lastChangeset)&#34;</span><span style=color:#f92672>&gt;</span>
<span style=color:#f92672>&lt;/AssemblyInfoVersionManagerTask&gt;</span>

<span style=color:#f92672>&lt;Exec</span> <span style=color:#a6e22e>Command=</span><span style=color:#e6db74>&#39;$(tfTool) checkin /comment:&#34;* **NO_CI** *&#34;..\sources\src\StandardBuildForCIVersion.txt&#39;</span> <span style=color:#f92672>/&gt;</span></code></pre></td></tr></table></div></div><p>IT is quite simple, I first invoke the TfTask, then I use a simple RegexTask to find the changeset number from tf output. Thanks to TfTask custom task, the script remains simple, I need only to specify tfsurl, team project name and the operation I want to execute (in this situation GetLatestChangeset), and the task will store in the <em>historyOutput</em> property the full output of the tf.exe command.</p><p>Finally I use my AssemblyInfoVersionManager task to change the ProjectVersion.cs file and finally I do a check-in of the file that contains the new generated sequential build number <em>with comment ***NO_CI*** to avoid going in loop with continuos integration engine</em>.</p><p>After a build you can verify that everything is gone ok.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image26.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb26.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb26.png alt=image></a></a></p><p>Now if you deploy this assembly into a customer computer, if you have a problem in the future, you can immediately verify that this was compiled with the build called 8, then you check the StandardBuildForCIVersion.txt</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#ae81ff>7</span>|Standard build <span style=color:#66d9ef>for</span> CI_20090820.<span style=color:#ae81ff>37</span>
<span style=color:#ae81ff>8</span>|Standard build <span style=color:#66d9ef>for</span> CI_20090820.<span style=color:#ae81ff>39</span>
<span style=color:#ae81ff>9</span>|Standard build <span style=color:#66d9ef>for</span> CI_20090821.<span style=color:#ae81ff>2</span>
</code></pre></td></tr></table></div></div><p>You can immediately find the label of the build, but the most important thing in my opinion is the revision number, 128 in the picture above, because it is the changeset that generates this assembly, to replicate and debug any problem, you can simply do a Get Specific Version of that changeset, and you can work with the exact source code and build tools that generates that assembly.</p><p>This example shows how simple can be extending build process with the creation of some ad-hoc tasks and a good use of the tf.exe command line tool.</p><p>A zip of all the repository <a href=http://www.codewrecks.com/blog/storage/msbuildextension.zip>can be downloaded here</a>.</p><p>Alk.</p><p>Tags: <a href=http://technorati.com/tag/Team%20Foundation%20Server>Team Foundation Server</a> <a href=http://technorati.com/tag/MsBuild>MsBuild</a></p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/team-foundation-server/>Team Foundation Server</a>, <a class=category href=/categories/tools-and-library/>Tools and library</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/msbuild/>Msbuild</a>, <a class=tag href=/tags/teamfoundationserver/>TeamFoundationServer</a>, <a class=tag href=/tags/tfsbuild/>TfsBuild</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2009/08/problem-with-tfs2010-beta-error-tf31002/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Problem with TFS2010 Beta error TF31002</a></div><div class="next-entry sep-before"><a href=/post/old/2009/08/browse-nhibernate-metadata-to-validate-property-length/><span class=screen-reader-text>Next post: </span>Browse NHibernate metadata to validate property Length<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>