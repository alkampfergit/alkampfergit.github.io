<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some post ago I blogged about Pex, in that post I showed how to use pex to test a routine that does string manipulation, now that I have build a Msbuild Task (as blogged in this post) I want to try pex to analyze that task and find errors. If you simply run pex again the Execute method of the task you will obtain an error like this.

For those that know well MsBuild this error occours because the BuildEngine was not initialized, and this is obvious, because Pex have no idea on how to create a valid PeekTask to test."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Using Pex in more complex environment a tale of • Codewrecks"><meta property="og:description" content="Some post ago I blogged about Pex, in that post I showed how to use pex to test a routine that does string manipulation, now that I have build a Msbuild Task (as blogged in this post) I want to try pex to analyze that task and find errors. If you simply run pex again the Execute method of the task you will obtain an error like this.

For those that know well MsBuild this error occours because the BuildEngine was not initialized, and this is obvious, because Pex have no idea on how to create a valid PeekTask to test."><meta property="og:url" content="https://www.codewrecks.com/post/old/2009/08/using-pex-in-more-complex-environment-a-tale-of/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Testing"><meta property="article:published_time" content="2009-08-10T02:00:37+02:00"><meta property="article:modified_time" content="2009-08-10T02:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Using Pex in more complex environment a tale of • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2009/08/using-pex-in-more-complex-environment-a-tale-of/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Using Pex in more complex environment a tale of</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Using Pex in more complex environment a tale of</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2009-08-10T02:00:37+02:00>2009, Aug 10</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>Some post ago I <a href=http://www.codewrecks.com/blog/index.php/2009/06/16/pex-to-the-rescue/>blogged</a> about <a href=http://research.microsoft.com/en-us/projects/Pex/>Pex</a>, in that post I showed how to use pex to test a routine that does string manipulation, now that I have build a Msbuild Task (as blogged in this <a href=http://www.codewrecks.com/blog/index.php/2009/08/01/writing-extension-for-msbuild/>post</a>) I want to try pex to analyze that task and find errors. If you simply run pex again the Execute method of the task you will obtain an error like this.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image1.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb1.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb1.png alt=image></a></a></p><p>For those that know well <a href=http://msdn.microsoft.com/en-us/library/ms171452.aspx>MsBuild</a> this error occours because the BuildEngine was not initialized, and this is obvious, because Pex have no idea on how to create a valid PeekTask to test. Pex is very good in telling you what is wrong, and how to correct,</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image2.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb2.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb2.png alt=image></a></a></p><p>From the Testability tab pex is telling me that it guess how to build the task, it correctly suggest me that I need to specify the IBuildEngine and the ITaskHost. Clearly pex can build a specific factory method for you</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb3.png alt=image></a></a></p><p>Since pex needs to do a series of steps to enable your mstest project to run Pex specific tests, it gives you a preview of all operation that it will perform if you press ok</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb4.png alt=image></a></a></p><p>It even take care of adding everything is needed to run the pex test. It specifically creates a factory for the object that pex will use to test the object itself. This is needed because pex does not know how to build correctly an object, so it ask you to create a method that accepts simple parameters and creates an object. I edited the factory method in this way.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CSharp data-lang=CSharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>partial</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XmlPeekFactory</span>
{
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> IBuildEngine engineStub = MockRepository.GenerateStub&lt;IBuildEngine&gt;();
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ITaskHost hostStub = MockRepository.GenerateStub&lt;ITaskHost&gt;();
<span style=color:#a6e22e>    [PexFactoryMethod(typeof(XmlPeek))]</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> XmlPeek Create(
        <span style=color:#66d9ef>string</span> value_s,
        <span style=color:#66d9ef>string</span> value_s1,
        <span style=color:#66d9ef>bool</span> value_b,
        <span style=color:#66d9ef>string</span> value_s2)
    {
        XmlPeek xmlPeek = <span style=color:#66d9ef>new</span> XmlPeek();
        xmlPeek.XPath = value_s;
        xmlPeek.FilePath = value_s1;
        xmlPeek.FailIfError = value_b;
        xmlPeek.Value = value_s2;
        ((Task)xmlPeek).BuildEngine = engineStub;
        ((Task)xmlPeek).HostObject = hostStub;
        <span style=color:#66d9ef>return</span> xmlPeek;
    }
}
</code></pre></td></tr></table></div></div><p>Please not the Attribute PexFactoryMethod(typeof(XmlPeek)) that is used internally by pex to understand how to create an instance of XmlPeek. To solve dependencies to IBuildEngine and ITaskHost I simply creates a couple of stub with rhino mocks. Now if I run pex again I encounter this problem</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image5.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb5.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb5.png alt=image></a></a></p><p>Well, actually pex is complaining that he found a System.Io.File.Exists call, so it cannot generate tests because accessing file from the test is not permitted. This happens because files are part of the <em>environment</em>, and you must not interact with the environment during a pex test, since pex cannot modify the environment itself. The only things that I can do is to test directly the Peek function that does XPath logic instead of testing the PeekTask class. Again you can find that pex does not xnow well the concept of Xml and XElement, but now we know the trick and we can create a very simple factory like this.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-CSharp data-lang=CSharp><span style=color:#a6e22e>[PexFactoryMethod(typeof(XElement))]</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> XElement Create(XElement other_xElement1, <span style=color:#66d9ef>object</span> annotation_o)
{
    XElement xElement = XElement.Parse(<span style=color:#e6db74>&#34;&lt;root&gt;&lt;anode attribute=&#39;test&#39; /&gt;&lt;/root&gt;&#34;</span>);
    <span style=color:#66d9ef>return</span> xElement;
}
</code></pre></td></tr></table></div></div><p>and run pex again you can verify that pex indeed find a couple of errors.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image6.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb6.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2009/08/image-thumb6.png alt=image></a></a></p><p>OOpps, I forgot completely to test if the xpath string was in correct format and I forgot to test for null arguments like a null Xpath. To solve this problem I simply trap the XPAthException returning null to the caller. Running pex again I can verify that it does not find any other errors.</p><p>At the end of this little sample I came to this consideration</p><ol><li>pex is really flexible, thanks to the concept of object factory you can create a factory method that will be used to test your object</li><li>pex is still rough, since it does not know anything about XML and it cannot really test methods that deal with xml</li><li>pex is good in finding some standard programming mistake, as not to validate properly parameters of function</li></ol><p>in the end it seems to me that pex can give you good added value to spot out common mistakes.</p><p>alk.</p><p>Tags: <a href=http://technorati.com/tag/Pex>Pex</a></p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/testing/>Testing</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/testing/>Testing</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2009/08/team-foundation-server-and-excel/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Team foundation server and excel</a></div><div class="next-entry sep-before"><a href=/post/old/2009/08/manipulate-expression-tree-in-dtogenerator/><span class=screen-reader-text>Next post: </span>Manipulate Expression Tree in DtoGenerator<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>