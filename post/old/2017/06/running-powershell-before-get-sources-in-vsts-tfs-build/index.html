<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I have a VSTS build where I need to run a PowerShell scripts at the very beginning of the build, before the agent starts downloading the sources , and it seems that this cannot be done with a simple task, because there is no way to place a task before the Get Sources default task of VSTS Build.
Luckily enough there is a way to solve this problem, because each task can define a specific script that should be run when the build starts and before each task runs , here is how."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Running powershell before Get Sources in VSTS  TFS Build • Codewrecks"><meta property="og:description" content="I have a VSTS build where I need to run a PowerShell scripts at the very beginning of the build, before the agent starts downloading the sources , and it seems that this cannot be done with a simple task, because there is no way to place a task before the Get Sources default task of VSTS Build.
Luckily enough there is a way to solve this problem, because each task can define a specific script that should be run when the build starts and before each task runs , here is how."><meta property="og:url" content="https://www.codewrecks.com/post/old/2017/06/running-powershell-before-get-sources-in-vsts-tfs-build/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="build"><meta property="article:published_time" content="2017-06-10T13:00:37+02:00"><meta property="article:modified_time" content="2017-06-10T13:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Running powershell before Get Sources in VSTS TFS Build • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2017/06/running-powershell-before-get-sources-in-vsts-tfs-build/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Running powershell before Get Sources in VSTS TFS Build</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Running powershell before Get Sources in VSTS TFS Build</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2017-06-10T13:00:37+02:00>2017, Jun 10</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>I have a VSTS build where I need to <strong>run a PowerShell scripts at the very beginning of the build, before the agent starts downloading the sources</strong> , and it seems that this cannot be done with a simple task, because there is no way to place a task before the Get Sources default task of VSTS Build.</p><p>Luckily enough there is a way to solve this problem, because <strong>each task can define a specific script that should be run when the build starts and before each task runs</strong> , here is how. First of all create a new task with the usual TFX-Cli interface:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tfx build tasks create</code></pre></td></tr></table></div></div><p>I’ve already explained how to create a build task in a <a href=http://www.codewrecks.com/blog/index.php/2016/03/17/writing-a-custom-task-for-build-vnext/>previous post</a>, but it is time to add some more context, because the build system is slightly changed and you need to do some more steps to be able to run the task. First of all you can incurr in the error</p><blockquote><p>##[error]File not found: ‘C:\vso\_work\_tasks\LibreOfficeKiller_9073fee0-4de5-11e7-925d-cb284842266e\0.1.0\ps_modules\VstsTaskSdk\VstsTaskSdk.psd1’</p></blockquote><p>This error is telling you that VstsTasksSdk is missing from the installation folder. <strong>New scripts uses a base library to interact with the build system, you can find all the</strong> <a href=https://github.com/Microsoft/vsts-task-lib/blob/master/powershell/Docs/Consuming.md><strong>information here</strong></a> <strong>,</strong> it is just a matter of cloning the <a href=https://github.com/Microsoft/vsts-task-lib>VSTS Task Lib</a> in a folder of your disk, then locate  the PowerShell folder, that contains a folder called VstsTaskSdk, that should be copied in your task folder, under a folder ps_modules.</p><blockquote><p>VSTS / TFS Build system is evolving rapidly, new versions have nice new capabilities, but this requires you to always read latest documentation.</p></blockquote><p><strong>After you copied the VstsTAskSdk.psd1 folder in the right place you should be able to run a build with your task.</strong> Now there is the fun part, executing some script before the GetSouce phase of the build is run.</p><p>In this scenario I have a PowerShell scripts that kills every instance of LibreOffice that is running on the system. My build runs some integration tests that involves LibreOffice, but if, for some reason, a previous execution failed to kill properly running instances of LibreOffice, source folder in the agent cannot be clean, because soffice.exe process has open handle on source folder, thus, the GetSources task fails. The sympthom of this problem is the build failing with this error in the Get Sources:  The process cannot access the file ‘\?\C:\vso\_work\8\s\src\Jarvis.DocumentStore.Tests\bin\Debug’ because it is being used by another process.</p><p>With latest version of the tasks, I can use the prejobexecution and postjobexecution to ask the system to run scripts at the beginning and the end of the build.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image-1.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image_thumb-1.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image_thumb-1.png alt="Section of task.json file showing the use of prejobexecution."></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Relevant section of the script that uses prejobexecution to execute a script before any task runs.</em></p><p>**Now in Figure 1 you can verify that I’m invoking the script KillLibreoffice.ps1 not only in the <em>execution</em> node, but also with a special node called prejobexecution and postjobexecution. **These two nodes allows you to specify a script to be called before the very first task of the build is executed. To verify that everything works, here is a super simple and stupid build that uses this task.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image-2.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image_thumb-2.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image_thumb-2.png alt="Simple buidl that uses a libreofficekiller task then build the solution"></a></a>** Figure 2: ***Task LibreOfficeKiller used in a sample build*</p><p>From the output of the build you can verify that the script that kills LibreOffice is run not only before the Get Source phase, but also after all tasks are completed.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image-3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image_thumb-3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2017/06/image_thumb-3.png alt="Output of the build shows that kill libre office script is run three times, before any task, during task execution and finally after all tasks were run"></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Build output of the build with KillLibreOffice task.</em></p><p>From <strong>Figure 3</strong> you can verify that the LibreOfficeKiller is run three times, the first time (1) before the Get Sources phase, then during normal task execution (2) and finally after the last task executed (3). Now my build can run just fine, because I’m able to kill any instance of LibreOffice.exe before the GetSources tasks runs.</p><p>If you are interested in the whole task, <a href=https://1drv.ms/u/s!AvPVMcA4v48okvY_TAHc6HCw0MM8bg>here is the code</a>.</p><p>Happy building :).</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/team-foundation-server/>Team Foundation Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/build/>build</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2017/06/running-solrmeter-without-a-ui/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Running SolrMeter without a UI</a></div><div class="next-entry sep-before"><a href=/post/old/2017/06/use-conditional-task-in-vsts-tfs-build/><span class=screen-reader-text>Next post: </span>Use conditional task in VSTS TFS Build<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>