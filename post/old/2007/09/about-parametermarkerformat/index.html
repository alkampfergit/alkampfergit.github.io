<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some time ago I wrote a post about a generic data access helper based on an article of Ayende. In that article I did a mistake in the use of ParameterMarkerFormat and I think that is time to correct it. In that article I showed a little routine to get the parameter name based on type of provider, but I used in wrong part of the code. This is the correct function AddPArameterToCommand"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="About ParameterMarkerFormat • Codewrecks"><meta property="og:description" content="Some time ago I wrote a post about a generic data access helper based on an article of Ayende. In that article I did a mistake in the use of ParameterMarkerFormat and I think that is time to correct it. In that article I showed a little routine to get the parameter name based on type of provider, but I used in wrong part of the code. This is the correct function AddPArameterToCommand"><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/09/about-parametermarkerformat/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Sql Server"><meta property="article:published_time" content="2007-09-05T23:00:37+02:00"><meta property="article:modified_time" content="2007-09-05T23:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>About ParameterMarkerFormat • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/09/about-parametermarkerformat/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>About ParameterMarkerFormat</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>About ParameterMarkerFormat</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-09-05T23:00:37+02:00>2007, Sep 05</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>3 mins read</span></div></div></header><div class="container entry-content"><p>Some time ago I wrote a <a href="http://www.nablasoft.com/Alkampfer/?p=62">post about a generic data access</a> helper based on an article of <a href=http://www.ayende.com>Ayende</a>. In that article I did a mistake in the use of ParameterMarkerFormat and I think that is time to correct it. In that article I showed a little routine to get the parameter name based on type of provider, but I used in wrong part of the code. This is the correct function AddPArameterToCommand</p><p>publicstaticvoid AddParameterToCommand(<br>DbCommand command,<br>DbProviderFactory factory,<br>System.Data.DbType type,<br>String name,<br>object value) {</p><p>DbParameter param = factory.CreateParameter();<br>param.DbType = type;<br>param.ParameterName = name;<br>param.Value = value;<br>command.Parameters.Add(param);<br>}</p><p>As you can see this is only a wrapper to create and configure the command with a DbProviderFactory, in the old code the name of the parameter is created with the GetParameterName, this was not correct since the name of the parameter is the same for all provider. What changes is the query itself, while in sql server I create a query like “SELECT COUNT(*) FROM Customers WHERE City = @city” in oracle the same query whould be “SELECT COUNT(*) FROM Customers WHERE City = :city”. The name of the parameter object is <em>city</em> in both case, but the name of the parameter in query text is different. The ParameterMarkerFormat should serve this purpose, it should be @{0} for sql server and :{0} for oracle so you can build your query dynamically and use the correct name of the parameter for each provider. The problem is that sql server returns {0} for ParameterMarkerFormat and obviously this does not work. I want this test to pass:</p><p>[Test]<br>publicvoid TestDbHelper() {<br>Int32 CustomerCount = Nablasoft.Helpers.DataAccess.ExecuteScalar&lt;Int32>(<br>delegate(DbCommand command, DbProviderFactory factory) {<br>command.CommandType = System.Data.CommandType.Text;<br>command.CommandText = “SELECT COUNT(*) FROM Customers WHERE City = “ +<br>DataAccess.GetParameterName(command, “city”);<br>Nablasoft.Helpers.DataAccess.AddParameterToCommand(<br>command, factory, System.Data.DbType.String, “city”, “London”);<br>});<br>Assert.AreEqual(6, CustomerCount);<br>}</p><p>This test is run against a northwind database, as you can see the query text is build dynamically thanks to the DataAccess.GetParameterName() helper function. In a real production code all queries should be created in advance, to avoid concatenating strings each time a query is to be run. For this code to work you need to find the right format of the parameter name from the command, here is the code.</p><p>privatestaticString GetParameterFormat(DbCommand command) {</p><p>if (!mParametersFormat.ContainsKey(command.GetType())) {<br>mParametersFormat.Add(<br>command.GetType(),<br>command.Connection.GetSchema(“DataSourceInformation”)<br>.Rows[0][“ParameterMarkerFormat”].ToString());<br>}<br>return mParametersFormat[command.GetType()];<br>}</p><p>As you can see I use a simple dictionary called mParametersFormat that cache the formats to avoid calling the slow function Connection.GetSchema, this is not enough for this code to work, because sql server returns me the wrong {0} format, the obvious solution is create a static constructor that preload my cache,</p><p>static DataAccess() {<br>mParametersFormat = newDictionary&lt;Type, String>();<br>mParametersFormat.Add(typeof(SqlCommand), “@{0}”);<br>}</p><p>This makes the above test to work, fixing the bug of sql server. I searched a lot in the internet for this issue but seems that ParameterMarkerFormat is a strange beast not used by many people, as you can see it is more simplier adding all your needed format in static constructor without use the PArameterMarkerFormat at all.</p><p>Alk.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/sql-server/>Sql Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/sql-server/>Sql Server</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/09/test/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Test</a></div><div class="next-entry sep-before"><a href=/post/old/2007/09/complex-fixture-teardown/><span class=screen-reader-text>Next post: </span>Complex fixture teardown<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>