<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In another post I spoke about castle Windsor and lifecycle of objects, now I want to show how to write a custom lifecycle. First of all the class must inherit from AbstractLifestyleManager class, then we must choose where to store the instance of the object that are created by the container. Since I want to build a lifecycle that can be used both from winform code and from web code I choose to use System."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Write a custom lifecycle for castle windsor • Codewrecks"><meta property="og:description" content="In another post I spoke about castle Windsor and lifecycle of objects, now I want to show how to write a custom lifecycle. First of all the class must inherit from AbstractLifestyleManager class, then we must choose where to store the instance of the object that are created by the container. Since I want to build a lifecycle that can be used both from winform code and from web code I choose to use System."><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/09/write-a-custom-lifecycle-for-castle-windsor/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Castle"><meta property="article:published_time" content="2007-09-11T23:00:37+02:00"><meta property="article:modified_time" content="2007-09-11T23:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Write a custom lifecycle for castle windsor • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/09/write-a-custom-lifecycle-for-castle-windsor/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Write a custom lifecycle for castle windsor</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Write a custom lifecycle for castle windsor</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-09-11T23:00:37+02:00>2007, Sep 11</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>In <a href="http://www.nablasoft.com/Alkampfer/?p=105">another post</a> I spoke about castle Windsor and lifecycle of objects, now I want to show how to write a custom lifecycle. First of all the class must inherit from <em>AbstractLifestyleManager</em> class, then we must choose where to store the instance of the object that are created by the container. Since I want to build a lifecycle that can be used both from winform code and from web code I choose to use <a href=http://msdn2.microsoft.com/en-us/library/system.runtime.remoting.messaging.callcontext.aspx>System.Runtime.Remoting.Messaging.CallContext class</a>, this class is used internally to implement the HttpContext so it can be used to store object for a HttpCall. But I need another behavior, I need to programmatically manage the lifecycle from calling code, this is especially useful for testing purpose. The result is a class called <em>ManageableLifeCycle</em> used to implement a custom lifecycle that can be managed from called code.</p><p>The final result should be a lifecycle that is transient by default, but that can become singleton when the caller needs it, and only for a small amount of time. First step is making our custom lifecycle overrides the *Resolve()*method, that is called by castle when he need to resolve an object. This is the code.</p><p>publicoverrideobject Resolve(global::Castle.MicroKernel.CreationContext context) {<br>if (contextBag != null) {<br>//We are in a context<br>if (_instance == null) {<br>_instance = base.Resolve(context);<br>contextBag.Add(_instance);<br>}<br>return _instance;<br>} else {<br>//We are not in a context<br>returnbase.Resolve(context);<br>}<br>}</p><p>First of all you should know that castle creates a lifecycle manager for each defined components. Our lifecycle defines an arraylist called contextBag that contains all the instance that are created in a context, the context is defined from calling code, so if the calling code does not create a context the lifecycle of the object is the same as transient. As you can see the code first checks if the contextBag is null, if is null it simply returns base.Resolve() actually creating a new entity for each call. If the contextBag is not null we are inside a context, so we create the object and store it into a inner field called _instance. This means that our context works like a singleton inside a context and as transient outside the context. Please note that the instance created is also stored inside the arraylist stored in the CallContext. Now the lifecycle must also override the <em>Release()</em> method, called when the client code calls Release() on an instance created through the container.</p><p>publicoverridevoid Release(object instance) {<br>if (contextBag == null) {<br>base.Release(instance);<br>} else {<br>if (!contextBag.Contains(instance))<br>base.Release(instance);<br>}<br>}</p><p>If we are not in a context (contextBag != null) the lifecycle calls the base version of Release, but if we are in a managed cycle we release the object only if it is not contained in the contextBag, this is needed to mimic the same behavior of the singleton lifecycle, this means that calling Release inside a Contex does not release anything. Ok, now the goals it to make this test pass.</p><p>publicvoid TestInsideContext() {<br>using (IoC.OverrideGlobalConfiguration(@”Castle\Windsor\ManageableLifeCycle\WindsorConfig.xml”)) {<br>ITest dt1, dt2;<br>using (ManageableLifeCycle.BeginThreadContext()) {<br>dt1 = IoC.GetObject&lt;ITest>();<br>dt2 = IoC.GetObject&lt;ITest>();<br>Assert.AreSame(dt1, dt2);<br>}<br>//Context is ended now all requested object are new.<br>Assert.AreNotSame(dt1, IoC.GetObject&lt;ITest>());<br>//Check that object are really disposed when we are outside of a context<br>Assert.IsTrue(dt1.IsDisposed, “object gets not disposed correctly at the end of the context”);<br>}<br>}</p><p>When we call static method <em>BeginThreadContext()</em> we are actually asking to our lifecycle manager to go in singleton mode beginning a contet, but when the using block is ended the behavior is reverted to singleton. This is not enough because all objects created inside the context should be disposed if they implement the IDisposable interface. First of all let’s see the code to begin a context</p><p>publicstaticDisposableAction BeginThreadContext() {<br>if (contextBag != null)<br>thrownewInvalidOperationException(“Another thread context was already begun”);<br>CallContext.SetData(dataId, newArrayList());<br>returnnewDisposableAction(delegate() {<br>EndThreadContext();<br>});<br>}</p><p>We simply store a new arraylist in System.Runtime.Remoting.Messaging.CallContext class using a guid as key identifier, then we create a disposable action that simply call EndThreadContext.</p><p>publicstaticvoid EndThreadContext() {<br>if (contextBag == null)<br>thrownewInvalidOperationException(“No thread context is begun.”);<br>foreach (object obj in contextBag) {<br>IDisposable d = obj asIDisposable;<br>if (d != null)<br>d.Dispose();<br>}<br>CallContext.FreeNamedDataSlot(dataId);<br>}</p><p>The EndThreadContext simply iterate through the list of created objects, and if an object implements IDisposable it simply calls the Dispose Method. Now if you create a simple httpModule that calls BeginThreadContext at the beginning of a request and calls EndThreadContext at the end of the same request you have singleton behavior only for the scope of the WebRequest, and you can use the BeginThreadContext in your test to create a simple scope where the lifecycle of managed object are really singleton object but gets disposed and released when the scope ends.</p><p>Relating to an <a href="http://www.nablasoft.com/Alkampfer/?p=104">older post of mine</a> where I spoke about the importance to call Container.Release, please note that this custom lifecycle manager, does not store any reference to the object when there is no context, so it does not calls Dispose when the container is disposed nor it risk to have leak if you forget to call Container.Release.</p><p>Alk.</p><p>P.S If you are interested in the code you can checkout with subversion at <a href=http://nablasoft.googlecode.com/svn/trunk/>http://nablasoft.googlecode.com/svn/trunk/</a>, please excuse the messy of the code, since this repository is only a place where I do various experiments.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/castle/>Castle</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/castle/>Castle</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/09/complex-fixture-teardown/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Complex fixture teardown</a></div><div class="next-entry sep-before"><a href=/post/old/2007/09/how-to-add-reference-to-microsoftvisualstudiodesignerinterfaces/><span class=screen-reader-text>Next post: </span>How to add reference to MicrosoftVisualStudioDesignerInterfaces<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>