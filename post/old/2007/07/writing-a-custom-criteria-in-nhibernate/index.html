<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In the preceding post I showed you a simple class that store in database string or integer values, now I need to create a criteria to do searches in database. NHibernate Criteria API are really good and they are extendible, to create a new criteria simply create a class that inherits from AbstractCriterion. I need to create a Criteria that permits to specify an operator to use (lessthen, greater, equal, etc) specify the type of the data we want to search for, and the two properties of the entity that store respectively the RawData in string format or in integer format, and the type name of the data contained in database."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Writing a Custom Criteria in Nhibernate • Codewrecks"><meta property="og:description" content="In the preceding post I showed you a simple class that store in database string or integer values, now I need to create a criteria to do searches in database. NHibernate Criteria API are really good and they are extendible, to create a new criteria simply create a class that inherits from AbstractCriterion. I need to create a Criteria that permits to specify an operator to use (lessthen, greater, equal, etc) specify the type of the data we want to search for, and the two properties of the entity that store respectively the RawData in string format or in integer format, and the type name of the data contained in database."><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/07/writing-a-custom-criteria-in-nhibernate/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Nhibernate"><meta property="article:published_time" content="2007-07-26T00:00:37+02:00"><meta property="article:modified_time" content="2007-07-26T00:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Writing a Custom Criteria in Nhibernate • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/07/writing-a-custom-criteria-in-nhibernate/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Writing a Custom Criteria in Nhibernate</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Writing a Custom Criteria in Nhibernate</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-07-26T00:00:37+02:00>2007, Jul 26</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>In the <a href="http://www.nablasoft.com/Alkampfer/?p=93">preceding post</a> I showed you a simple class that store in database string or integer values, now I need to create a criteria to do searches in database. NHibernate Criteria API are really good and they are extendible, to create a new criteria simply create a class that inherits from AbstractCriterion. I need to create a Criteria that permits to specify an operator to use (lessthen, greater, equal, etc) specify the type of the data we want to search for, and the two properties of the entity that store respectively the RawData in string format or in integer format, and the type name of the data contained in database.</p><p>publicclassUntypedSearchCriteria : AbstractCriterion {</p><p>privateCriteriaOperator mInnerOperator;<br>privateobject mOperatorValue;<br>privateType mRealObjType;<br>privateString mPropertyName;<br>privateString mTypePropertyName;</p><p>The five inner field of the criteria have the following meanings</p><ul><li>mInnerOperator: is a custom enum to specify the operator I want to use (lessthan, greaterthan, etc)</li><li>mOperatorValue is the value of the comparison</li><li>mRealObjType is the clr type of the data we want to search in database</li><li>mPropertyName is the name of the property that store the raw data</li><li>mTypePropertyName is the name of the property of the object that store the type description</li></ul><p>The first Method to override is the * <strong>GetTypedValues()</strong> *used from Nhibernate to know type and value of the parameter of the query. The purpose of a Criteria is to generate a fragment of SQL code to perform the serach, all done without resort to a specific database syntax. The GetTypedValues() permits you to use parameter. To create my operator I need two parameter, the first is the value to check for, the other is the description of the type. If the user ask for LessThen 500 for a string field I need to create a SQL fragment like * <strong>CAST (rawproperty AS INT) > 500 and typename like ‘System.Int32%’</strong> *. With such a condition we retrieve only the data of the current format that store values that satisfy my condition.</p><p>publicoverride NHibernate.Engine.TypedValue[] GetTypedValues(<br>NHibernate.ICriteria criteria,<br>NHibernate.Expression.ICriteriaQuery criteriaQuery) {</p><p>returnnewTypedValue[] {<br>newTypedValue(GetITypeFromCLRType(mRealObjType), mOperatorValue),<br>newTypedValue(NHibernateUtil.String, mRealObjType.FullName + “%”)};<br>}</p><p>GetTypedValue() method needs to return an array of * <strong>TypedValue</strong> *object that is able to contain both the type and the value for a parameter. First of all I use an helper function to get the Nhibernate IType from the real type of the CLR, then I insert the parameter that filter for the object type.</p><p>privatestaticIType GetITypeFromCLRType(Type type) {<br>if (type == typeof(String))<br>return NHibernate.NHibernateUtil.String;<br>elseif (type == typeof(Int32))<br>return NHibernate.NHibernateUtil.Int32;<br>else<br>thrownewArgumentException(“Cannot handle type “ + type.FullName);<br>}</p><p>That’s all for the parameter of the query, as you can see the NhibernateUtil cames to help because contains fields and method to obtain instance of concrete nhibernate type name. Now comes the fun part the building of the query, done overriding the method * <strong>ToSqlString()</strong> *, that must return a SqlString, an object of nhibernate that encapsulate the concept of a query.</p><p>1publicoverride NHibernate.SqlCommand.SqlString ToSqlString(<br>2 NHibernate.ICriteria criteria,<br>3ICriteriaQuery criteriaQuery,<br>4 System.Collections.IDictionary context) {<br>5<br>6//retrieve with projection the real name of the property.<br>7String[] PropertyColumn = criteriaQuery.GetColumnsUsingProjection(criteria, mPropertyName);<br>8String[] resolvedTypeColumns = criteriaQuery.GetColumnsUsingProjection(criteria, mTypePropertyName);<br>9Dialect dialect = criteriaQuery.Factory.Dialect;<br>10ISQLFunction cf = (ISQLFunction) dialect.Functions[“cast”];<br>11<br>12String conversionRendered = cf.Render(newobject[] { PropertyColumn[0], GetSqlTypeFromCLRType(mRealObjType) }, criteriaQuery.Factory);<br>13//Now we have the cast operation required.<br>14return CreateQueryString(resolvedTypeColumns[0], conversionRendered);<br>15 }</p><p>Lines 7 and 8 use the GetColumnsUsingProjection() method of the ICriteria object passed as a parameter from nhibernate, this method translate property and field name to the name of the column specified in the mappings since the SQL fragment we need to create must speak about real database columns. In line 9 I get a reference to current dialect, this is needed to perform a cast. When I need to search for integer field, since the rawdata column is of a string type I need to perform a cast, but cast operation could be different for different database engine, so I need to ask to the dialect to perform the cast for me, following the specification of the current database. Dialect object has a Functions property that is a Dictionary of String, ISQLfunction object, it contains a series of function supported from the database, since I want to do a Cast there is no surprise that I ask for dialect.Functions[“cast”]. When you have the instance of the ISQLFunction the method * <strong>Render()</strong> *permits you to render SQL fragment related to that function. The Render method accepts two parameters, the array of the real parameter needed to the function and a reference to the current ISessionImplementorFactory object used internally to the function. Cast function need two parameter, the column to cast and the type of the cast that must be specified with a string that nhibernate could convert to a SqlType, so I create another helper function.</p><p>privatestaticString GetSqlTypeFromCLRType(Type type) {<br>if (type == typeof(String))<br>return“String(4000)”;<br>elseif (type == typeof(Int32))<br>return“Int32”;<br>else<br>thrownewArgumentException(“Cannot handle type “ + type.FullName);<br>}</p><p>For the string I really could to no cast, but to keep code uniform I decide to cast even the string to a nvarchar(4000). Finally we must discuss the CreateQueryString method that really build the query.</p><p>privateSqlString CreateQueryString(String typePropertyColumn, string conversionRendered) {<br>SqlStringBuilder sb = newSqlStringBuilder();<br>sb.Add(conversionRendered)<br>.Add(GetSqlOperator(mInnerOperator))<br>.AddParameter()<br>.Add(“ and “)<br>.Add(typePropertyColumn)<br>.Add(“ like “)<br>.AddParameter();<br>return sb.ToSqlString();<br>}</p><p>As you can see the query is build with a * <strong>SqlStringBuilder</strong> *object, this is necessary because we used parameters in our query (remember the parameters in GetTypedValues?). To build the query we simply use the add and continue to add fragment of standard ANSI SQL code, when you need to insert a parameter simply call * <strong>AddParameter()</strong> *but remember to call it in the same logical order you return the parameter in GetTypedValues(). The function GetSqlOperator() is simply a translation of my operator enum in the real SQL comparison operator “>”, “&lt;” etc.</p><p>Here you are, you have build a full functioning and Dialect aware Criteria Operator for nhibernate.</p><p>Alk.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/nhibernate/>Nhibernate</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/nhibernate/>Nhibernate</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/07/the-simpliest-thing-that-could-possibly-work/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>The simpliest thing that could possibly work</a></div><div class="next-entry sep-before"><a href=/post/old/2007/07/exceptional-aspnet/><span class=screen-reader-text>Next post: </span>Exceptional ASPNET<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>