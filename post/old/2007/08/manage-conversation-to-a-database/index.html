<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When you begin to work with an ORM you encounter the concept of conversation, a conversation is the analogous of a transaction for database code, in a conversation I must be able to make a dialog to the ORM using the same context. In database there is no such concept, but I like it, and since sometimes I need to share nhibernate code and standard sql code in the same project I wish to be able to create a “conversation” that spans direct database access and nhibernate code."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Manage conversation to a database • Codewrecks"><meta property="og:description" content="When you begin to work with an ORM you encounter the concept of conversation, a conversation is the analogous of a transaction for database code, in a conversation I must be able to make a dialog to the ORM using the same context. In database there is no such concept, but I like it, and since sometimes I need to share nhibernate code and standard sql code in the same project I wish to be able to create a “conversation” that spans direct database access and nhibernate code."><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/08/manage-conversation-to-a-database/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Nhibernate"><meta property="article:tag" content="Sql Server"><meta property="article:published_time" content="2007-08-04T01:00:37+02:00"><meta property="article:modified_time" content="2007-08-04T01:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Manage conversation to a database • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/08/manage-conversation-to-a-database/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Manage conversation to a database</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Manage conversation to a database</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-08-04T01:00:37+02:00>2007, Aug 04</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>When you begin to work with an ORM you encounter the concept of conversation, a conversation is the analogous of a transaction for database code, in a conversation I must be able to make a dialog to the ORM using the same context. In database there is no such concept, but I like it, and since sometimes I need to share nhibernate code and standard sql code in the same project I wish to be able to create a “conversation” that spans direct database access and nhibernate code. Basically a conversation has these properties</p><ul><li>All operation done into a conversation are transactional</li><li>Inside a conversation Nhibernate share the same connection used by direct SQL code</li><li>Inside a conversation I must use the same Nhibernate session.</li><li>Code must be unaware of the presence of a conversation, this means that the code should not matter if we are in or outside a conversation</li></ul><p>The first class I create is the Conversation, a class that takes care of the creation of the connection, session, transaction and so on. This class should implement IDisposable so I can use the semantic of <em>using keyword</em> that is really useful.</p><p>publicclassConversation : IDisposable {</p><p>privateDbConnection mConnection = null;<br>privateDbTransaction mTransaction = null;<br>privateISession mSession = null;<br>privateBoolean mIsDirty = false;</p><p>internalvirtualDbConnection Connection {<br>get {return mConnection ?? (mConnection = CreateConnection());}<br>}</p><p>internalvirtualDbTransaction Transaction {<br>get {return mTransaction;}<br>}</p><p>internalvirtualISession Session {<br>get {return mSession ?? (mSession = SessionManager.CreateNewSession(Connection));}<br>}</p><p>publicvirtualvoid MarkDirty() {<br>mIsDirty = true;<br>}</p><p>publicvirtualvoid Close() {<br>try {<br>if (!mIsDirty)<br>mTransaction.Commit();<br>}<br>finally {<br>mTransaction.Dispose();<br>Session.Dispose();<br>mConnection.Dispose();<br>}<br>}</p><p>publicvoid Dispose() {<br>Close();<br>}<br>}<br>}</p><p>This class creates a connection when needed, it does the same thing with the Nhibernate session, using a session manager that inject code into nhibernate session. It is disposable, and when dispose is called the transaction will be committed if no one had called the <em>ISDirty()</em> method. If you want to rollback the conversation simply call <em>IsDirty()</em> method and when the conversation will be closed, all operations will be rolled back. Now we need a static class called ConversationManager to keep track of the concept of “Current Conversation”</p><p><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2007/08/080407-0812-manageconve1.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2007/08/080407-0812-manageconve1.png alt></a></p><p>BeginConversation() will return a conversation object and since it is diposable you can use code like this.</p><p>using (Conversation conv = ConversationManager.BeginConversation()) {<br>//do your access code here using conv.Transaction or conv.Session<br>}</p><p>When code wants to access a database and wish to be enlisted in a Conversation, it should call <em>ConversationManager.GetConversation()</em>, this return a reference to the current conversation.</p><p>using (Conversation conversation = ConversationManager.GetConversation()) {<br>//do your access code here using conv.Transaction or conv.Session<br>}</p><p>To make this code work The <em>GetConversation()</em> function in the ConversationManager class should not return a direct reference to the current conversation, because the caller code will dispose it before the conversation is really ended, so I use a weak reference.</p><p>publicclassConversationWeakReference : Conversation {</p><p>privateConversation mOriginal;<br>public ConversationWeakReference (Conversation original) {<br>mOriginal = original;<br>}</p><p>publicoverride System.Data.Common.DbConnection Connection {<br>get {return mOriginal.Connection;}<br>}</p><p>publicoverrideglobal::NHibernate.ISession Session {<br>get {return mOriginal.Session;}<br>}</p><p>publicoverride System.Data.Common.DbTransaction Transaction {<br>get {return mOriginal.Transaction;}<br>}</p><p>protectedoverridevoid Close() {}<br>}</p><p>As you can see this class Inherit from a Conversation and wraps the real Conversation, but override the CloseMethod with a no op method. This means that when a ConversationWeakReference gets disposed the real conversation still remain open. The key is in the GetConversation() method of the ConversationManager.</p><p>publicstaticConversation GetConversation() {<br>Conversation current = GetFromStorage();<br>return current == null ? newConversation() : newConversationWeakReference(current);<br>}</p><p>As you can notice the ConversationManager check if there is an active Conversation, and returns a new conversation or a new conversationWeakReference if there is an active conversation. With this trick if the caller is in a ConversationScope he will get a weak reference, but if the code is not in a conversation it will obtain a full conversation object that gets committed at the end of the scope. Real code has some more check but this is the general idea. Basically if we are not in a Conversation the code</p><p>using (Conversation conversation = ConversationManager.GetConversation()) {<br>//do your access code here using conversation.Transaction or conversation.Session<br>}</p><p>creates a new conversation that gets closed at the end of the scope, actually committing all work. But if the call chain is the following</p><p>using (Conversation conv = ConversationManager.BeginConversation()) {<br>…<br>//in another class or method called<br>using (Conversation conversation = ConversationManager.GetConversation()) {<br>//do your access code here with conversation<br>}<br>…<br>//in another class or method called<br>using (Conversation conversation = ConversationManager.GetConversation()) {<br>//do your access code here with conversation<br>}<br>}</p><p>The two inner using block will share the same conversation, accessed by two distinct ConnectionWeakReference. The good of this technique is that the inner code is unaware of the presence or absence of a conversation.</p><p>Final question is “where do you store the reference to the current conversation”? I use <em>System.Runtime.Remoting.Messaging.CallContext</em> because it can manage the concept of call context, and works well even in web scenario where the context will span a whole ASP.NET Request. If you dig with reflector in the HttpContext object you will end finding that the web context is stored in a CallContext.</p><p>Alk.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/nhibernate/>Nhibernate</a>, <a class=category href=/categories/sql-server/>Sql Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/nhibernate/>Nhibernate</a>, <a class=tag href=/tags/sql-server/>Sql Server</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/08/castle-vs-spring-override-delle-properties/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Castle Vs Spring Override delle properties</a></div><div class="next-entry sep-before"><a href=/post/old/2007/08/irepository-and-query-objects/><span class=screen-reader-text>Next post: </span>IRepositoryT and query objects<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>