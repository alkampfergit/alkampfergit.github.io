<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The application model of Web Forms is not the most intuitive one, but to avoid being surprised and loosing time the most important thing to keep in mind is * page lifecycle.* If you forget page lifecycle hell awaits you. Here is one of the most common example, look at the following code.
<body>
<formid=”form1″runat=”server”>
<div>
<asp:DropDownListID=”MyDDListe1″EnableViewState=”true”AutoPostBack=”true”AppendDataBoundItems=”true”
runat=”server”OnSelectedIndexChanged=”SelectedIndexChanged”>
<asp:ListItem>Select a team</asp:ListItem>
</asp:DropDownList>
</div>
</form>
</body>
</html>
<scriptrunat=”server”>
protectedvoid Page_Load(object sender, EventArgs e) {"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="The hell of disabling viewstate in aspnet 20 • Codewrecks"><meta property="og:description" content="The application model of Web Forms is not the most intuitive one, but to avoid being surprised and loosing time the most important thing to keep in mind is * page lifecycle.* If you forget page lifecycle hell awaits you. Here is one of the most common example, look at the following code.
<body>
<formid=”form1″runat=”server”>
<div>
<asp:DropDownListID=”MyDDListe1″EnableViewState=”true”AutoPostBack=”true”AppendDataBoundItems=”true”
runat=”server”OnSelectedIndexChanged=”SelectedIndexChanged”>
<asp:ListItem>Select a team</asp:ListItem>
</asp:DropDownList>
</div>
</form>
</body>
</html>
<scriptrunat=”server”>
protectedvoid Page_Load(object sender, EventArgs e) {"><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/06/the-hell-of-disabling-viewstate-in-aspnet-20/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="ASPNET"><meta property="article:published_time" content="2007-06-05T09:00:37+02:00"><meta property="article:modified_time" content="2007-06-05T09:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>The hell of disabling viewstate in aspnet 20 • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/06/the-hell-of-disabling-viewstate-in-aspnet-20/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>The hell of disabling viewstate in aspnet 20</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>The hell of disabling viewstate in aspnet 20</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-06-05T09:00:37+02:00>2007, Jun 05</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>The application model of Web Forms is not the most intuitive one, but to avoid being surprised and loosing time the most important thing to keep in mind is * <strong>page lifecycle</strong>.* If you forget page lifecycle hell awaits you. Here is one of the most common example, look at the following code.</p><p>&lt;body><br>&lt;formid=”form1″runat=”server”><br>&lt;div><br>&lt;asp:DropDownListID=”MyDDListe1″EnableViewState=”true”AutoPostBack=”true”AppendDataBoundItems=”true”<br>runat=”server”OnSelectedIndexChanged=”SelectedIndexChanged”><br>&lt;asp:ListItem>Select a team&lt;/asp:ListItem><br>&lt;/asp:DropDownList><br>&lt;/div><br>&lt;/form><br>&lt;/body><br>&lt;/html></p><p>&lt;scriptrunat=”server”><br>protectedvoid Page_Load(object sender, EventArgs e) {<br>if (!IsPostBack) {<br>MyDDListe1.DataSource = newstring[] { “Ferrari”, “McLaren”, “Renault” };<br>DataBind();<br>}<br>}<br>protectedvoid SelectedIndexChanged(object sender, EventArgs e) {<br>string msg = string.Format(@”alert(‘Selected item {0}’);”, MyDDListe1.SelectedValue);<br>ClientScript.RegisterStartupScript(GetType(), “blah”, msg, true);<br>}<br>&lt;/script></p><p>It is a very simple one, a simple page with a single dropdownlist, when you select a different item in the ddlist, a messageBox appears showing the selected element. All works fine until you choose to disable viewstate, mainly for performance reason and for page size reduction. When you set EnableViewState property of the DDL to false, the example ceases to work. When you choose a team the message box does not show selected team, and all the items in the DDL disappear. First thing to do is remove the check <strong>if (!IsPostBack)</strong> made in form Load event, now all content of the DDL must be reloaded at every postback because there is no viewstate anymore to restore the old values. Now the DDL retains all elements, but the messagebox continues to miss the selected item. Now you should resist the temptation to open google to find the solution, and instead you should really ask yourself “why the combo does not retain the selected value in SelectedIndexChanged event?”. The answer is in page lifecycle; every control has an event called * <strong>LoadPostData()</strong> *that is called from infrastructure to make control restore its current value from post data. The AspNet infrastructure calls LoadPostData() in a time between page <strong>init</strong> and page <strong>load</strong> , so if you disable the viewstate and reload DropDownList elements in page load, when the page controller calls LoadPostData the DropDownList tries to recover selected values from post but it has no items yet, and so nothing gets selected. <strong>To solve the problem you must bind the ddl in page Init</strong>.</p><p>To verify that this is really the reason you can do a simple test, first of all create a new control that inherits from the dropdownlist and exposes a method that internally calls protected method LoadPostData().</p><p>[DefaultProperty(“Text”)]<br>[ToolboxData(“&lt;{0}:MyDDListe runat=server>&lt;/{0}:MyDDListe>”)]<br>publicclassMyDDListe : DropDownList {</p><p>publicvoid reloadValueFromPost() {<br>this.LoadPostData(this.ClientID, HttpContext.Current.Request.Form);<br>}<br>}</p><p>As you can see the LoadPostData() method accepts the key of the data in the post (the control id contained in ClientId property) and the collection of post parameters. With this control at hand change the page in this way</p><p>&lt;body><br>&lt;formid=”form1″runat=”server”><br>&lt;div><br>&lt;cc1:MyDDListeID=”MyDDListe1″EnableViewState=”false”AutoPostBack=”true”AppendDataBoundItems=”true”<br>runat=”server”OnSelectedIndexChanged=”SelectedIndexChanged”><br>&lt;asp:ListItem>Select a team&lt;/asp:ListItem><br>&lt;/cc1:MyDDListe><br>&lt;/div><br>&lt;/form><br>&lt;/body><br>&lt;/html><br>&lt;scriptrunat=”server”><br>protectedvoid Page_Load(object sender, EventArgs e) {<br>MyDDListe1.DataSource = newstring[] { “Ferrari”, “McLaren”, “Renault” };<br>DataBind();<br>MyDDListe1.reloadValueFromPost();<br>}<br>protectedvoid SelectedIndexChanged(object sender, EventArgs e) {<br>string msg = string.Format(@”alert(‘Selected item {0}’);”, MyDDListe1.SelectedValue);<br>ClientScript.RegisterStartupScript(GetType(), “blah”, msg, true);<br>}<br>&lt;/script></p><p>As you can see the DropDownList now gets substituted by MyDDListe control, in page load I simply calls <em>reloadValueFromPost()</em> method, this make my ddl to calls again LoadPostData() of the base control, and the example now works again, even if the data binding is done in Page Load event. When the viewstate is enabled the viewstate is restored before LoadPostData() gets called and all works as expected.</p><p><strong>So, every time a WebForm seems to behave in a strange way <em>first of all think about page lifecycle</em>, and most of the time you’ll find the answer.</strong></p><p>Alk.</p><p>P.S another way to verify this issue without the need to create a new control just to be able to call LoadPostData() that is a protected method, remember that through reflection calling a protected method is a breeze. The following code makes the combo work even if databinding is done in page load, clearly the best thing to do is rebind the combo in page init, but the following code is a verification that the reason why the combo stops to work with viewstate disabled is really the fact that LoadPostData() is called before page load.</p><p>protectedvoid Page_Load(object sender, EventArgs e) {<br>MyDDListe1.DataSource = newstring[] { “Ferrari”, “McLaren”, “Renault” };<br>DataBind();<br>MyDDListe1.GetType().GetMethod(“LoadPostData”, System.Reflection.BindingFlags.NonPublic<br>| System.Reflection.BindingFlags.Instance).Invoke(MyDDListe1,<br>newobject[] { MyDDListe1.UniqueID, Request.Form });<br>}</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/aspnet/>ASPNET</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/aspnet/>ASPNET</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/06/c-anonymous-delegates-and-template-pattern-2/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>C anonymous delegates and template pattern</a></div><div class="next-entry sep-before"><a href=/post/old/2007/06/overhead-calling-udf-in-sql-server-2005/><span class=screen-reader-text>Next post: </span>Overhead calling UDF in Sql server 2005<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>