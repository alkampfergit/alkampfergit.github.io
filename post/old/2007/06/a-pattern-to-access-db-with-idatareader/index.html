<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some days ago I posted about an helper class to easy the access to database. I took original code by ayende and do slightly modifications to make database indipendent. A natural extension to that class is the ability to retrieve a datareader with some data. An initial solution is simply call the core Execute() function with this code.
Nablasoft.Helpers.DataAccess.Execute(
delegate(DbCommand command, DbProviderFactory factory) {
command.CommandType = System.Data.CommandType.Text;
command.CommandText = “SELECT CompanyName FROM Customers WHERE CustomerId = @id”;"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="A pattern to access DB with IDataReader • Codewrecks"><meta property="og:description" content="Some days ago I posted about an helper class to easy the access to database. I took original code by ayende and do slightly modifications to make database indipendent. A natural extension to that class is the ability to retrieve a datareader with some data. An initial solution is simply call the core Execute() function with this code.
Nablasoft.Helpers.DataAccess.Execute(
delegate(DbCommand command, DbProviderFactory factory) {
command.CommandType = System.Data.CommandType.Text;
command.CommandText = “SELECT CompanyName FROM Customers WHERE CustomerId = @id”;"><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/06/a-pattern-to-access-db-with-idatareader/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="General"><meta property="article:tag" content="Sql Server"><meta property="article:published_time" content="2007-06-18T04:00:37+02:00"><meta property="article:modified_time" content="2007-06-18T04:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>A pattern to access DB with IDataReader • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/06/a-pattern-to-access-db-with-idatareader/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>A pattern to access DB with IDataReader</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>A pattern to access DB with IDataReader</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-06-18T04:00:37+02:00>2007, Jun 18</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>Some days ago I <a href="http://www.nablasoft.com/Alkampfer/?p=62">posted</a> about an helper class to easy the access to database. I took original code by ayende and do slightly modifications to make database indipendent. A natural extension to that class is the ability to retrieve a datareader with some data. An initial solution is simply call the core <em>Execute()</em> function with this code.</p><p>Nablasoft.Helpers.DataAccess.Execute(<br>delegate(DbCommand command, DbProviderFactory factory) {<br>command.CommandType = System.Data.CommandType.Text;<br>command.CommandText = “SELECT CompanyName FROM Customers WHERE CustomerId = @id”;<br>Nablasoft.Helpers.DataAccess.AddParameterToCommand(<br>command, factory, System.Data.DbType.String, “id”, “ANATR”);<br>//now access the datareader.<br>using(IDataReader dr = command.ExecuteReader()) {<br>Assert.IsTrue(dr.Read()); //Check if the datareader contains data.<br>Assert.AreEqual(“Ana Trujillo Emparedados y helados”, (String)dr[“CompanyName”]);<br>}<br>});</p><p>The code simply creates a delegate that prepares the command, and then retrieves a IDataReader with ExecuteReader(). The code above was easy to read but it has a problem, if the caller forget to dispose the IDataReader object a connection leak will show up. In past experiences I found that dealing with connection leaks, especially in web application can be a nightmare, so I’d like to wrap the creation of DataReader in a way that permits to the caller not worry about disposing any resource he uses. This poses a problem, actually the template pattern work with this sequences of operations</p><p><em>1) Create the connection and a transaction<br>2) Create the command and enlist in the current transaction<br>3) Call the delegates passed by the caller, the delegates prepare the command and does something with it<br>4) Using clause dispose command, connection and check for exeption to rollback transaction.</em></p><p>I should modify the pattern of the template, point 3 should be splitted</p><p><em>3a) call the delegate passed by the caller, this delegate prepare the command<br>3b) call ExecuteDataReader() on prepared command<br>3c) Call another delegate that access IDataReader object<br>3d) Dispose the IDataReader.</em></p><p>This pattern forced the caller to create two anonymous delegates, one to prepare the command, and the other to access the IDataReader, this makes the code less readable. A better solution is to create an helper function like this</p><p>1publicstaticvoid ExecuteReader(<br>2VoidFunc&lt;DbCommand, DbProviderFactory, Func&lt;IDataReader>> commandPrepareFunction) {<br>3<br>4 Execute(delegate(DbCommand command, DbProviderFactory factory) {<br>5//The code to execute only assures that the eventually created datareader would be<br>6//closed in a finally block.<br>7IDataReader dr = null;<br>8try {<br>9 commandPrepareFunction(command, factory,<br>10delegate() {<br>11 dr = command.ExecuteReader();<br>12return dr;<br>13 });<br>14 }<br>15finally {<br>16if (dr != null) dr.Dispose();<br>17 }<br>18 });<br>19 }</p><p>This function accepts a delegate with three arguments, the first is the command to retrieve data, second parameter is DbFactory class to create parameters for the command and at last we have another delegate function with no parameter that returns a IDataReader. This function creates an anonymous delegate at line 4, the body of the delegate simply call the caller supplied delegate (line 9) and creates another anonymous delegate for the third parameter, the function is called with a try-finally block to ensure that the datareader will be disposed. The trick is that the creation of the IDAtaReader object now is moved to the infrastructure code, so I can dispose it. Let’s look at how the caller can use this helper function to access data.</p><p>[Test]<br>publicvoid TestDbHelperDataReader() {<br>Nablasoft.Helpers.DataAccess.ExecuteReader(<br>delegate(DbCommand command, DbProviderFactory factory, Func&lt;IDataReader> getDatareader) {<br>//First prepare the command<br>command.CommandType = System.Data.CommandType.Text;<br>command.CommandText = “SELECT CompanyName FROM Customers WHERE CustomerId = @id”;<br>Nablasoft.Helpers.DataAccess.AddParameterToCommand(<br>command, factory, System.Data.DbType.String, “id”, “ANATR”);<br>//now access the datareader.<br>IDataReader dr = getDatareader();<br>Assert.IsTrue(dr.Read()); //Check if the datareader contains data.<br>Assert.AreEqual(“Ana Trujillo Emparedados y helados”, (String) dr[“CompanyName”]);<br>});<br>}</p><p>As you can see the code is really simple and straightforward. The caller first prepares the command, and then once the command is ready to be executed it calls the getDatareader() delegate passed as argument to obtain a datareader for accessing data. What I like of this pattern is that the caller do not have the burden to close the IDataReader because this is done in the infrastructure function. Code with a lot of using or try-finally blocks is less readable, and moreover an inexperienced programmer could forget to dispose a datareader. With this pattern the caller should only prepare the DbCommand and access the DataReader, no using, no try catch, no way to make a leak. With this pattern we can also make an helper class to work with DataSets.</p><p>publicstaticvoid ExecuteDataset(<br>VoidFunc&lt;DbCommand, DbProviderFactory, Func&lt;DataSet>> commandPrepareFunction) {</p><pre><code>          Execute(delegate(DbCommand  command,  DbProviderFactory  factory)  {  
</code></pre><p>//The code to execute only assures that the eventually created datareader would be<br>//closed in a finally block.<br>using (DataSet ds = newDataSet()) {<br>commandPrepareFunction(command, factory,<br>delegate() {<br>using (DbDataAdapter da = factory.CreateDataAdapter()) {<br>da.SelectCommand = command;<br>da.Fill(ds);<br>}<br>return ds;<br>});<br>}</p><pre><code>          });  
    }
</code></pre><p>This function is a copy of the previous one, it simply uses the command prepared by the caller to insert as selectCommand for a DataAdapter and fill a dataset. The using clauses are needed to be sure that everything is diposed correctly. Here is how you can retrieve data</p><p>delegate(DbCommand command, DbProviderFactory factory, Func&lt;DataSet> getDataSet) {<br>command.CommandText = “SELECT * FROM Customers”;<br>DataSet Result = getDataSet();<br>Assert.AreEqual(1, Result.Tables.Count);<br>Assert.AreNotEqual(0, Result.Tables[0].Rows.Count);<br>});</p><p>Again the caller has not the burden of dispose anything. If you like this you can access code <a href=https://www.codewrecks.com/blog/wp-content/uploads/2007/06/dataaccess.zip>here</a>.</p><p>Alk.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/general/>general</a>, <a class=category href=/categories/sql-server/>Sql Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/general/>General</a>, <a class=tag href=/tags/sql-server/>Sql Server</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/06/standard-configuration-for-net-20/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Standard configuration for net 20</a></div><div class="next-entry sep-before"><a href=/post/old/2007/06/watin-looking-for-content-in-gridview/><span class=screen-reader-text>Next post: </span>WatiN looking for content in GridView<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>