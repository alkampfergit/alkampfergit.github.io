<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="After the creation of Registry pattern I need to create a localization scheme that will satisfy the remaining points of the list; first of all I write some tests following the best practices of Test Driven Development. The class under test will be called Entity, and has an integer property and two string properties that are to be localized. The scheme I used to localize the entity is to enclose all localizable properties in a different class called EntityResources, and storing all resources of an Entity instance through a simple IDictionary<LangCode, EntityResources>."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Localizable entities with Nhibernate part 2 • Codewrecks"><meta property="og:description" content="After the creation of Registry pattern I need to create a localization scheme that will satisfy the remaining points of the list; first of all I write some tests following the best practices of Test Driven Development. The class under test will be called Entity, and has an integer property and two string properties that are to be localized. The scheme I used to localize the entity is to enclose all localizable properties in a different class called EntityResources, and storing all resources of an Entity instance through a simple IDictionary<LangCode, EntityResources>."><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/05/localize-entity-with-nhibernate-part-2/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Nhibernate"><meta property="article:published_time" content="2007-05-21T23:00:37+02:00"><meta property="article:modified_time" content="2007-05-21T23:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Localizable entities with Nhibernate part 2 • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/05/localize-entity-with-nhibernate-part-2/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Localizable entities with Nhibernate part 2</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Localizable entities with Nhibernate part 2</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-05-21T23:00:37+02:00>2007, May 21</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>After the creation of Registry pattern I need to create a localization scheme that will satisfy the remaining points of the list; first of all I write some tests following the best practices of Test Driven Development. The class under test will be called Entity, and has an integer property and two string properties that are to be localized. The scheme I used to localize the entity is to enclose all localizable properties in a different class called <em>EntityResources</em>, and storing all resources of an <em>Entity</em> instance through a simple IDictionary&lt;LangCode, EntityResources>. This scheme has the advantage to be enough flexible to satisfy all my requirements, while keeping the class simple. The first test checks that a single localization is handled correctly</p><pre><code class=language-chsarp data-lang=chsarp>[Test]  
public void TestAddLocalization() {  
Entity ent = new Entity();  
   ent.AddResource(LangCode.En, new EntityResources(“Name”, “Description”));  
   Registry.InstanceRegistry.CurrentLangCode = LangCode.En;  
Assert.AreEqual(“Name”, ent.Name);  
Assert.AreEqual(“Description”, ent.Description);  
}</code></pre><p>Then a couple of test to check that default localization is used when exact localization is not present<pre><code class=language-chsarp data-lang=chsarp>[Test]  
public void TestDefaultLocalization1() {  
Entity ent = new Entity();  
   ent.AddResource(LangCode.En, new EntityResources(“Name”, “Description”));  
   Registry.InstanceRegistry.CurrentLangCode = LangCode.De;  
Assert.AreEqual(“Name”, ent.Name);  
Assert.AreEqual(“Description”, ent.Description);  
}  
[Test]  
public void TestDefaultLocalizationEnglishDefault() {  
Entity ent = new Entity();  
   ent.AddResource(LangCode.It, new EntityResources(“Nome”, “Descrizione”));  
   ent.AddResource(LangCode.En, new EntityResources(“Name”, “Description”));  
   Registry.InstanceRegistry.CurrentLangCode = LangCode.De;  
   Registry.InstanceRegistry.DefaultLangCode = LangCode.En;   
Assert.AreEqual(“Name”, ent.Name);  
Assert.AreEqual(“Description”, ent.Description);  
}</code></pre></p><p>The most interesting tests are those used to test transparent localization features such as this one</p><pre><code class=language-chsarp data-lang=chsarp>[Test]  
public void TestAutomaticLocalization() {  
Entity ent = new Entity();  
   Registry.InstanceRegistry.CurrentLangCode = LangCode.It;  
   ent.Name = “Nome”;  
   ent.Description = “Descrizione”;  
Assert.AreEqual(“Nome”, ent.Name);  
Assert.AreEqual(“Descrizione”, ent.Description);  
   Registry.InstanceRegistry.CurrentLangCode = LangCode.En;  
   ent.Name = “Name”;  
   ent.Description = “Description”;  
Assert.AreEqual(“Name”, ent.Name);  
Assert.AreEqual(“Description”, ent.Description);  
   Registry.InstanceRegistry.CurrentLangCode = LangCode.It;  
Assert.AreEqual(“Nome”, ent.Name);  
Assert.AreEqual(“Descrizione”, ent.Description);  
}</code></pre><p>This test verify that a user can actually set properties of the Entity object without worrying if a suitable localization ResourceEntity already exists on the object. This feature is very useful for my project, but can be a little bit confusing. Let’s make an example: if current language is ‘de’ and the user ask for an object that has no resource for ‘de’ LangCode, the Entity class shows Name and Description properties taking default resource. At this time if the user changes the value of one of these properties a new localization resource gets created for ‘de’ language and added to Entity object transparently. If this is not the behavior you needs, simply disable this feature and throw an exception or permit the user to modify the default resource.</p><p>Now it’s time to look at Entity’s code, first of all the class stores all localization resources inside a IDictionary&lt;LangCode, EntityResource>, Name and Description properties simply look for a suitable resource to show to the user.</p><pre><code class=language-chsarp data-lang=chsarp>public String Name {  
get { return GetResource().Name; }  
set { GetOrCreateResource().Name = value; }  
}

public String Description {  
get { return GetResource().Description; }  
set { GetOrCreateResource().Description = value; }  
}</code></pre><p>As you can see the getter part of the property calls GetResource() method to find the most suitable resource, while setter part uses GetOrCreateResource() that actually create a new resource if the current language missing it. GetResource() simply check if a resource for the current language is present in the dictionary, if not it calls GetDefaultResource() that simply checks if the dictionary contains the resource for the default language. If the dictionary is empty, GetResource() returns an instance of a default resource.</p><pre><code class=language-chsarp data-lang=chsarp>protected  
EntityResources GetResource() {

LangCode locinfo = Registry.InstanceRegistry.CurrentLangCode;  
if (mResources.ContainsKey(locinfo))  
return mResources[locinfo];  
else  
return GetDefaultResource();  
}  
  
protected virtual EntityResources GetDefaultResource() {  
if (mResources.ContainsKey(Registry.InstanceRegistry.DefaultLangCode))  
return mResources[Registry.InstanceRegistry.DefaultLangCode];    
foreach (KeyValuePair&amp;lt;LangCode, EntityResources&amp;gt; element in mResources) {  
return element.Value;  
   }  
return EntityResources.DefaultResource;  
}</code></pre><p>GetOrCreateResource() is a little bit interesting because it handle transparent localization. It first checks if a resource for the current langcode is present, if not it creates a new EntityResource making a clone of the current resource. This is necessary because if the user change only one property and a new resource needs to be created, the caller should see the other properties unchanged.</p><pre><code class=language-chsarp data-lang=chsarp>protected EntityResources GetOrCreateResource() {  
LangCode locinfo = Registry.InstanceRegistry.CurrentLangCode;  
if (mResources.ContainsKey(locinfo))  
return mResources[locinfo];  
else {  
EntityResources newResource = (EntityResources) GetResource().Clone();  
  AddResource(locinfo, newResource);  
return newResource;  
   }  
}</code></pre><p>That’s all, with this scheme the Entity object now supports the concept of localization and thanks to the registry pattern we can access the current language and the default language from every classes. This scheme has some disadvantages, first of all an Entity object needs to contain all the resources for all languages to support Transparent localization, this approach uses more memory than a plain object. A second issue is that accessing Name and Description properties is slower compared to standard properties implemented with a private field. If performance is a key issue, and if the profiler shows you that the implementation of localized entities really impacts on your performance, you can adopt an internal cache of the resources. The first time that Name or Description properties are called, we store current resource in a private field as well as the current language, at each call we simply check if the language is changed, if not we can return cached resource without incurring in the penality of calling GetResource() or GetOrCreateResource(). My approach is not to worry too much about performance until a profiler shows me where and when the performance are poor and the code needs to be tuned, so previous scheme suits well most of my needs.</p><p>In the next part of this tutorial I’ll finally show you how to map this class with NHibernate along with some queries to work with localized objects.</p><p>Alk.</p><p><a href="http://www.nablasoft.com/Alkampfer/?p=41">Localizable Entities With Nhibernate – Part 1</a></p><p><a href="http://www.nablasoft.com/Alkampfer/?p=44">Localizable Entities With Nhibernate – Part 3</a></p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/nhibernate/>Nhibernate</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/nhibernate/>Nhibernate</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/05/localize-entity-with-nhibernate-part-1/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Localizable entities with Nhibernate Part 1</a></div><div class="next-entry sep-before"><a href=/post/old/2007/05/localize-entity-with-nhibernate-part-3/><span class=screen-reader-text>Next post: </span>Localizable Entities With Nhibernate Part 3<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>