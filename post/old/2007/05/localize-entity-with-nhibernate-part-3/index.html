<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Now that the Entity object works as expected the only issue remaining is the integration with NHibernate. First Step is creating mapping file to store the object in the database. Database structure is very simple, just a table for the Entity class plus another table for localized resources.

Against this database schema we can map the Entity class with this mapping file.
<?xmlversion=“1.0“encoding=“utf-8“ ?>
<hibernate-mappingxmlns=“urn:nhibernate-mapping-2.2“
assembly=“Example1“
namespace=“Example1“
default-lazy=“false“>
<classname=“Entity“table=“Entity“>"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Localizable Entities With Nhibernate Part 3 • Codewrecks"><meta property="og:description" content="Now that the Entity object works as expected the only issue remaining is the integration with NHibernate. First Step is creating mapping file to store the object in the database. Database structure is very simple, just a table for the Entity class plus another table for localized resources.

Against this database schema we can map the Entity class with this mapping file.
<?xmlversion=“1.0“encoding=“utf-8“ ?>
<hibernate-mappingxmlns=“urn:nhibernate-mapping-2.2“
assembly=“Example1“
namespace=“Example1“
default-lazy=“false“>
<classname=“Entity“table=“Entity“>"><meta property="og:url" content="https://www.codewrecks.com/post/old/2007/05/localize-entity-with-nhibernate-part-3/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Nhibernate"><meta property="article:published_time" content="2007-05-22T23:00:37+02:00"><meta property="article:modified_time" content="2007-05-22T23:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Localizable Entities With Nhibernate Part 3 • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2007/05/localize-entity-with-nhibernate-part-3/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Localizable Entities With Nhibernate Part 3</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Localizable Entities With Nhibernate Part 3</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2007-05-22T23:00:37+02:00>2007, May 22</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>Now that the Entity object works as expected the only issue remaining is the integration with NHibernate. First Step is creating mapping file to store the object in the database. Database structure is very simple, just a table for the Entity class plus another table for localized resources.</p><p><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2007/05/052307-0636-localizable1.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2007/05/052307-0636-localizable1.png alt></a></p><p>Against this database schema we can map the Entity class with this mapping file.</p><p>&lt;?xmlversion=“1.0“encoding=“utf-8“ ?><br>&lt;hibernate-mappingxmlns=“urn:nhibernate-mapping-2.2“<br>assembly=“Example1“<br>namespace=“Example1“<br>default-lazy=“false“><br>&lt;classname=“Entity“table=“Entity“><br>&lt;idname=“Id“unsaved-value=“0“><br>&lt;generatorclass=“native“ /><br>&lt;/id></p><pre><code>    &amp;lt;propertyname=“SomeCode“column=“somecode“type=“Int32“  /&amp;gt;  
    &amp;lt;mapname=“Resources“table=“EntityResources“lazy=“false“fetch=“join“&amp;gt;  

          &amp;lt;keycolumn=“entityid“  /&amp;gt;  
          &amp;lt;composite-indexclass=“Registry.LangCode,  Registry“&amp;gt;  
                &amp;lt;key-propertyname=“Code“column=“langcode“access=“property“  /&amp;gt;  
          &amp;lt;/composite-index&amp;gt;  

          &amp;lt;composite-elementclass=“EntityResources“&amp;gt;  
                &amp;lt;propertyname=“Name“column=“name“  /&amp;gt;  
                &amp;lt;propertyname=“Description“column=“description“  /&amp;gt;  
          &amp;lt;/composite-element&amp;gt;  
    &amp;lt;/map&amp;gt;  
</code></pre><p>&lt;/class><br>&lt;/hibernate-mapping></p><p>Dictionary properties are mapped with the element &lt;map> on the database table EntityResources, then we needs to specify the key tag that contains the foreign key, in our model the column <em>entityid</em>. Keys of the dictionary are instances of LangCode class, so we need to specify a &lt;composite-index> tag with class attribute, inside the composite-index nhibernate we need to specify which columns of the table are used to build the key part of the dictionary with the element &lt;key-property>. In this example the LangCode is composed only by language code, so it maps to the single column langcode. For the element we needs also to specify a &lt;composite-element>, but now this class maps to the two column Name and Description of the table. This completes the mapping.</p><p>To conclude this tutorial it is interesting to show some HQL queries that can be used to manage this particular entity. A main disadvantage of this mapping scheme is that when we load a list of Entity objects used only to show data to the user, each instance of the Entity class will contains all resources for each language supported, this waste a lot of memory and also retrieve too much data from database. If we are sure that all the objects have resources for current language, and the current language will not change for the lifetime of the object, we can do a HQL query to retrieve only the resource for current language, this avoid to load localization data for language that will be not necessary.</p><p>from Entity as E left join fetch E.Resources as res where INDEX(res) = ‘it’</p><p>This query uses the special syntax INDEX() that permits to specify criteria for the key of a dictionary. The purpose of this query is to retrieve all entities but only with the ‘it’ resource. The left join fetch is used to use an eager fetch strategy, if a simple join would be used, NHibernate would have done a first select to retrieve the entity list, and subsequently a single select for each entity to retrieve the resource corresponding to ‘it’ language.</p><p>As usual you can search inside the description or name property, but you must pay attention. A query like this</p><p>select distinct from Entity as E join E.Resources as res where res.Description like ‘des%’</p><p>actually search for entities that have one of its localization resource with a value like des%. Suppose that an entity has two resources: the ‘it’ has Description property equal to “Descrizione” and ‘de’ has Description property equal to “Schilderung”. If current language is de and you run the previous query, the previous entity is returned, because it has the ‘it’ resource that satisfy the match, but when you show the Description property to screen it shows “Shilderung” because ‘de’ is the current language. This kind of experience can be frustrating for the user that really does not understand why this object had matched the filter. To avoid this problem the INDEX(res) = :langcode filter should be included for each query that does a filtering on localizable properties of the entity.</p><p>For those interested in performances, the previous HQL query produce this SQL (Captured with profiler)</p><p>select distinct entity0_.Id as Id0_, entity0_.somecode as somecode0_</p><p>from Entity entity0_ inner join EntityResources resources1_ on entity0_.Id=resources1_.entityid</p><p>where (resources1_.description like ‘des%’)</p><p>As you can see the query is efficient because it join directly the two tables and does not suffer for the n-select problem. Please do not forget to use <em>select distinct</em> on HQL query because if it’s not specified and an entity has more than one resource that matches the filter, the query returns duplicate results.</p><p>I hope this little tutorial can help anyone that needs to use localizable entities with NHibernate.</p><p>Alk.</p><p><a href="http://www.nablasoft.com/Alkampfer/?p=41">Localizable entities with Nhibernate Part 1</a></p><p><a href="http://www.nablasoft.com/Alkampfer/?p=42">Localizable entities with Nhibernate Part 2</a></p><p><a href=http://www.nablasoft.com/files/localization.7z>Example Code</a>.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/nhibernate/>Nhibernate</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/nhibernate/>Nhibernate</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2007/05/localize-entity-with-nhibernate-part-2/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Localizable entities with Nhibernate part 2</a></div><div class="next-entry sep-before"><a href=/post/old/2007/05/difference-between-c-and-vb-simple-add/><span class=screen-reader-text>Next post: </span>Difference between C and VB simple add<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>