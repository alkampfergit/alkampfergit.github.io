<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Previous posts on the NoSql and Raven Series
 NoSql and a life without Schema NoSql and a life without schema continued  Other posts by Mauro on RavenDb Subject.
 RavenDb: Start your engines RavenDb: First Contact  In previous articles I showed how simple is to store objects inside a NO SQL database because the data storage has no schema and does not require you to specify the format of your data."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Rename a property in RavenDb • Codewrecks"><meta property="og:description" content="Previous posts on the NoSql and Raven Series
 NoSql and a life without Schema NoSql and a life without schema continued  Other posts by Mauro on RavenDb Subject.
 RavenDb: Start your engines RavenDb: First Contact  In previous articles I showed how simple is to store objects inside a NO SQL database because the data storage has no schema and does not require you to specify the format of your data."><meta property="og:url" content="https://www.codewrecks.com/post/old/2012/02/rename-a-property-in-ravendb/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="RavenDB"><meta property="article:published_time" content="2012-02-08T17:00:37+02:00"><meta property="article:modified_time" content="2012-02-08T17:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Rename a property in RavenDb • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2012/02/rename-a-property-in-ravendb/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Rename a property in RavenDb</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Rename a property in RavenDb</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2012-02-08T17:00:37+02:00>2012, Feb 08</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>6 mins read</span></div></div></header><div class="container entry-content"><p>Previous posts on the NoSql and Raven Series</p><ul><li><a href=http://www.codewrecks.com/blog/index.php/2012/02/04/nosql-and-a-life-without-schema/>NoSql and a life without Schema</a></li><li><a href=http://www.codewrecks.com/blog/index.php/2012/02/06/nosql-and-a-life-without-schema-continued/>NoSql and a life without schema continued</a></li></ul><p>Other posts by Mauro on RavenDb Subject.</p><ul><li><a href=http://mauroservienti.blogspot.com/2012/01/ravendb-start-your-engines.html>RavenDb: Start your engines</a></li><li><a href=http://mauroservienti.blogspot.com/2012/02/ravendb-first-contact.html>RavenDb: First Contact</a></li></ul><p>In previous articles I showed how simple is to store objects inside a NO SQL database because the data storage has no schema and does not require you to specify the format of your data. I decided to use RavenDb as a NoSql storage to show some basic concepts of NoSql and I showed also how simple is to add a new property to a document, because RavenDb takes care of everything, just save and load objects and the new property is just there.</p><p>Now I want to deal with a different kind of problem:<em>what happen when you rename a property of a document that has already some instances saved in database</em>?</p><p>This is the typical situation where having No Schema does not solves the problem automatically. Suppose you change the Player document *renaming <strong>Description</strong> property to <strong>Background</strong> *, if you load an old document from the database, since the Description property does not exists anymore, it is ignored and when the object is saved again, it will be deleted. Clearly this is unacceptable because it lead to data loss, so there is some need of manual intervention to handle the scenario of property rename.</p><p>There are multiple approaches to solve this problem, but the simplest one is verifying if your NoSql storage supports the concepts of Bulk-Updating documents, a feature that is really well supported by RavenDb.</p><p>RavenDb natively support the concept of  <strong>Document Patch</strong> , a technique used to update a single document without the need to load the entire object or replacing its entire content. Basically a Patch is a dedicated command that transform a stored document directly in the store; along the many different type of patches supported by RavenDb you can use the <strong><em>rename</em> <em>patch</em></strong>specifically designed to change the name of a property. The code is really simple, just reference the assembly <em>Raven.Abstractions</em>and write this code.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>store.DatabaseCommands.Patch(<span style=color:#e6db74>&#34;Players/1&#34;</span>,
<span style=color:#66d9ef>new</span>[] { <span style=color:#66d9ef>new</span> PatchRequest() {
Type = PatchCommandType.Rename,
Name = <span style=color:#e6db74>&#34;Description&#34;</span>,
Value = <span style=color:#66d9ef>new</span> RavenJValue(<span style=color:#e6db74>&#34;Background&#34;</span>),
}
;
</code></pre></td></tr></table></div></div><p>The syntax is really simple, the IDocumentStore has a property called * <strong>DatabaseCommands</strong> *used to access all commands supported by RavenDb engine; with this property you can call the * <strong>Patch()</strong> *method specifying the Id of the object you want to patch and an array of PatchRequest (you can ask to apply a sequence of patches, in this example I only want to rename a property). To request a Patch operation you need to specify the type of <em>Patch</em>you want to execute, in this example * <strong>PatchCommandType.Rename</strong> *, then you need to fill the appropriate properties of PatchRequest object, required by the type of the path you are issuing. To rename a property you need to specify the <strong>Name</strong> of the property in the <strong>Name</strong> field and the new name of the property in the <strong>Value</strong> parameter, passed as RavenJValue element.</p><p>This technique is useful but it does not solve our original problem, because it * <strong>patches a single entity</strong> <em>, while our need is to rename the property <em>Description of all saved documents of type Player</em>, so we need to use a different type of operation called: <a href=http://ravendb.net/docs/client-api/set-based-operations>set-based-operation</a>. A set-based-operation is an operation that operates on multiple documents at once, in its most basic form it request an <em>index</em>to identify the list of documents to modify and a list of Patch operation</em>.*The whole concept of indexes is a really fundamental concept in RavenDb and in all NoSql database, but for this specific need just think to index as a <em>way to create a query that identify documents in database</em>. To define an index by code you must create a specific class for the index, but I can easily create an index with RavenStudio. In <strong>Figure 1</strong> I created an index to identify all the documents of type Players.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2012/02/image4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2012/02/image_thumb4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2012/02/image_thumb4.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Define an index in RavenStudio</em></p><p>To define a simple index you just need to give it a name and write the text of the index. The index starts with * <strong>from doc in docs</strong> *, this part is used to query all documents of the database, then I specify a restriction with the keyword * <strong>where</strong> *followed by the condition.</p><p>In this example the condition is doc[”@metadata”][“Raven-Entity-Name”] == “Players”, and uses <a href=http://ravendb.net/docs/client-api/advanced/document-metadata>RavenDb Metadata</a>, a series of internal properties that RavenDb attach to each saved document. One of this metadata is called * <strong>Raven-Entity-Name</strong> *and for.NET object is the name of the class followed by an s to pluralize the name. In my example, since the.NET class saved is called “Player” the Raven-Entity-Name is equal to “Players”. The last part of the Index Map is the select clause, where I simply select property Name of the document, but it is not important for our example, because I’m only interested in creating an index to <em>identify all documents that corresponds to Player entity.</em></p><p>You can execute the index from RavenDb Studio just to verify that it works as intended and it selects all the entities of desired type. When the index is ok you are able to issue a Set-Based-Patch operation:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>store.DatabaseCommands.UpdateByIndex(<span style=color:#e6db74>&#34;PlayersToBeUpdated&#34;</span>,
<span style=color:#66d9ef>new</span> IndexQuery(),
<span style=color:#66d9ef>new</span> [] {<span style=color:#66d9ef>new</span> PatchRequest() {
Type = PatchCommandType.Rename,
Name = <span style=color:#e6db74>&#34;Description&#34;</span>,
Value = <span style=color:#66d9ef>new</span> RavenJValue(<span style=color:#e6db74>&#34;Background&#34;</span>),
}
});
</code></pre></td></tr></table></div></div><p>As you can see the syntax is really similar to the previous example, the main difference is that you should not use the * <strong>Patch()</strong> *  database command but * <strong>UpdateByIndex()</strong> *that requires:</p><ul><li>the name of the index to use</li><li>an index query (to specify index parameters, if any)</li><li>the list of Patches request.</li></ul><p>The above command basically means:</p><p><em>Apply the list of Patches to all object identified by the index named “PlayersToBeUpdated”</em></p><p>This simple call updates all Player objects saved in database, renaming the property, as you can verify from RavenDb Studio.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2012/02/image5.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2012/02/image_thumb5.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2012/02/image_thumb5.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Description property was renamed to Background</em></p><p>As you can see, even if NoSql databases does not require schema, if you refactor your documents changing the name of existing properties, you need to update all saved data to reflect your changes.</p><p>In the next series of posts I’ll deal with RavenDb HTTP API to show how to rename a property directly with HTTP requests, without the need to use C# code. This is useful if you want easily to generate a bat script that updates documents using only HTTP Requests.</p><p>Gian Maria</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/nosql/>NoSql</a>, <a class=category href=/categories/ravendb/>RavenDB</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/ravendb/>RavenDB</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2012/02/check-progress-of-dbcc-checkdb/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Check progress of DBCC CHECKDB</a></div><div class="next-entry sep-before"><a href=/post/old/2012/02/first-touch-of-ravendb-http-api/><span class=screen-reader-text>Next post: </span>First touch of RavenDb HTTP API<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>