<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Visual Studio 2017 introduced a new.csproj file format for C# project that is the key to move to.NET Standard but it is useful also for project with Full Framework, because is more human manageable.
The main drawback of this approach is that you end compatibility with older version of VS , if you open the.csproj with VS2015 you are not able to compile the project anymore. For this reason, switching to new format should be a decision that is well discussed in the team."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Converting a big project to new VS2017 csproj format • Codewrecks"><meta property="og:description" content="Visual Studio 2017 introduced a new.csproj file format for C# project that is the key to move to.NET Standard but it is useful also for project with Full Framework, because is more human manageable.
The main drawback of this approach is that you end compatibility with older version of VS , if you open the.csproj with VS2015 you are not able to compile the project anymore. For this reason, switching to new format should be a decision that is well discussed in the team."><meta property="og:url" content="https://www.codewrecks.com/post/old/2018/10/converting-a-big-project-to-new-vs2017-csproj-format/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Visual Studio"><meta property="article:published_time" content="2018-10-27T14:00:37+02:00"><meta property="article:modified_time" content="2018-10-27T14:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Converting a big project to new VS2017 csproj format • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2018/10/converting-a-big-project-to-new-vs2017-csproj-format/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Converting a big project to new VS2017 csproj format</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Converting a big project to new VS2017 csproj format</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2018-10-27T14:00:37+02:00>2018, Oct 27</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>6 mins read</span></div></div></header><div class="container entry-content"><p><strong>Visual Studio 2017 introduced a new.csproj file format for C#</strong> project that is the key to move to.NET Standard but it is useful also for project with Full Framework, because is more human manageable.</p><p>The main drawback of this approach is that <strong>you end compatibility with older version of VS</strong> , if you open the.csproj with VS2015 you are not able to compile the project anymore. For this reason, switching to new format should be a decision that is well discussed in the team.</p><blockquote><p>New project format is really human friendly, the only drawback is losing compatibility with older VS.</p></blockquote><p>Luckily enough, when you have a solution with 68 project, you do not need to do all the work manually thanks to a nice tool found on GitHub, <a href=https://github.com/hvanbakel/CsprojToVs2017>CsprojToVs2017</a>. <strong>I’ve done manual conversion in the past, it is time consuming and frustrating, the above tools is not perfect but it does most of the work for you.</strong> First of all I’ve run the tool to do a conversion of the entire solution without creating backup files (why should you take a backup when you can do all the test in a Git branch isolated from the rest of the code?).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>csproj-to-2017 --no-backup.\mysln.sln</code></pre></td></tr></table></div></div><p>The tool output lots of information, warning and other suggestion, I simply stored in a file as reference but I immediately opened the solution to verify that it compiles successfully and the answer is no, but most of the work was already done for me.</p><blockquote><p>Automated tool can do most of the work for you, but you will always do some manual work to finish and fine tune the conversion.</p></blockquote><p>First of all the tool remove all the information of assembly from assemblyinfo.cs file, and in my situation it generates an error because I have AssemblyInformationalVersion in my assemblyinfo.cs, value of this attribute is “localCompile” and here what the tools generates.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image-12.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-12.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-12.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Incorrectly Version generated by conversion tool</em></p><p>I <strong>still prefer all version information to be stored inside assemblyinfo.cs, so I removed all the version information from all.csproj file, added the attribute &lt;GenerateAssemblyInfo>false&lt;/GenerateAssemblyInfo> to avoid automatic generation of assemblyinfo</strong> and finally reverted all the modification done to all assemblyinfo.cs to revert to previous content.</p><p>Then I start having a strange error:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Assets file …<span style=color:#ae81ff>\o</span>bj<span style=color:#ae81ff>\p</span>roject.assets.json<span style=color:#960050;background-color:#1e0010>&#39;</span> not found. Run a NuGet package restore to generate this file</code></pre></td></tr></table></div></div><p>This error can be solved simply running a dotnet restore and in this particular situation it probably happens because in the sln file there are still a couple of web project that were not converted because web project still should use the old format. If we removed those two project from the solution everything compiles correctly, probably VS2017 got confused when a solution mixed the two types of project. The funny thing is that this error did not happened to every member of the team and happens only when we switched branch from a branch with the old format to the new format. This is usually not a big problem, when we switch branch we should only issue a git clean –xdf to clean every file not in source control, dotnet restore and we are ready to go. Now that we do not have active branches with the old format, this issue is gone away.</p><p><strong>Then we start having some compilation errors because the new project formats includes automatically all.cs files inside project folders</strong> and during the years, some files were probably removed from the project , but they are still in the file system as you can see in following picture, where we have in the left the converted project to the right the original one.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image-13.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-13.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-13.png alt=image></a></a></p><p><strong>As you can verify the file ConfigurationManagerProcessManagerConfiguration is present in file system but it is excluded from the project</strong> (right part of the picture) and it is incorrectly included by the new project format.</p><p>To solve this problem you should open side by side converted version of the project and original version and manually remove all cs files that are still in source code but are not referenced by the old project format, to avoid them to be incorrectly included after conversion.</p><blockquote><p>One nice side effect of the conversion is that we found a bunch of files still in source control but not included in the solution</p></blockquote><p>Then we have problem with Post Build Action, because we use Pre and Post build action to xcopy some files around but with the new format it seems not to work anymore. It turns out that in post build and pre build action some of the properties, as $(ConfigurationName) were not correctly populated, thus all the post and pre build actions generate error. The solution is really simple, <strong>convert them to a standard MsBuild Target as seen in the following snippet, where you can see the correct way to use xcopy and the original code that gets converted</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image-14.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-14.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-14.png alt=image></a></a></p><p>Conversion is really simple, original part is commented in the lower part of previous snippet, and it is composed by a series of xcopy command inside a PreBuildEvent. To made it work with the new csproj format the solution is adding a Target with a BeforeTarget=”PreBuildEvent” that will be run before the pre build event, then add a Exec task for each xcopy instruction. Remember also that the output folder is not bin/debug but you need to append the net461 (framework version).</p><p>The whole conversion took almost a couple of  hours for a 68 project solution and thanks to the automatic conversion tool, most of the work was automated, we only need to tweak a little bit project files and solves some problems due to the fact that this is a 5 years old solution.</p><p>This conversion forces also you to review your build in VSTS or whatever build system you are using. I encountered a couple of modification to do to every build.</p><blockquote><p>Once you switch to the new project version it is time to check the all automated builds.</p></blockquote><ol><li><strong>First of all I need to be sure that the version of NuGet used to restore dependencies should be set at minimum to 4.6.</strong> to be sure of the NuGet version used, you should use the couple of task  <strong>NuGet Tool Installer</strong> plus <strong>Nuget</strong> , as I described in a <a href=http://www.codewrecks.com/blog/index.php/2018/08/27/be-sure-to-use-latest-version-of-nuget-restore-task-in-vsts-build/>previous post</a>.</li></ol><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image-22.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-22.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-22.png alt=image></a></a></p><p>If you are using a wrong nuget version, probably the build solution will fail with an error like: <em>Assets file ……\project.assets.json’ not found. Run a NuGet package restore to generate this file.</em></p><p>Another problem is due to switching between a branch that still uses old project format and branch that use the new format. It is imperative that obj folders are cleared because building again, or the build probably will fail. To accomplish this, I simply decide to clear everything before a get sources. (This was related to the issue I explained before.)</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image-23.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-23.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2018/08/image_thumb-23.png alt=image></a></a></p><p>Symptoms of not clearing the obj folder are weird error like: <em>Your project file doesn’t list ‘win’ as a “RuntimeIdentifier”. You should add ‘win’ to the “RuntimeIdentifiers” property in your project file and then re-run NuGet restore.</em></p><p>The overall process went smooth, and now we are ready to start the migration to dotnetcore.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/visual-studio/>Visual Studio</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/visual-studio/>Visual Studio</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2018/10/nullreferenceexception-in-windows-when-git-fetch-or-pull/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>NullReferenceException in windows when Git fetch or pull</a></div><div class="next-entry sep-before"><a href=/post/old/2018/11/end-of-life-of-php-5-6-please-upgrade-to-7-version/><span class=screen-reader-text>Next post: </span>End of life of PHP 56 please upgrade to 7 version<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>