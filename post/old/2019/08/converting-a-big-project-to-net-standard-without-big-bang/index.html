<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When you have a big project in.NET full framework and you want to convert to.NET standard / core, usually MultiTargeting can be a viable solution to avoid a Big Bang conversion. You starts with the very first assembly in the chain of dependency, the one that does not depends on any other assembly in the project, and you start checking compatibility with.NET standard for all referenced NuGet Packages. Once the first project is done you proceed with the remaining."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Converting a big project to NET Standard without big bang • Codewrecks"><meta property="og:description" content="When you have a big project in.NET full framework and you want to convert to.NET standard / core, usually MultiTargeting can be a viable solution to avoid a Big Bang conversion. You starts with the very first assembly in the chain of dependency, the one that does not depends on any other assembly in the project, and you start checking compatibility with.NET standard for all referenced NuGet Packages. Once the first project is done you proceed with the remaining."><meta property="og:url" content="https://www.codewrecks.com/post/old/2019/08/converting-a-big-project-to-net-standard-without-big-bang/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Visual Studio"><meta property="article:published_time" content="2019-08-05T16:00:37+02:00"><meta property="article:modified_time" content="2019-08-05T16:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Converting a big project to NET Standard without big bang • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2019/08/converting-a-big-project-to-net-standard-without-big-bang/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Converting a big project to NET Standard without big bang</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Converting a big project to NET Standard without big bang</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2019-08-05T16:00:37+02:00>2019, Aug 05</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>6 mins read</span></div></div></header><div class="container entry-content"><p>When you have a big project in.NET full framework and you want to convert to.NET standard / core, <strong>usually MultiTargeting can be a viable solution to avoid a Big Bang conversion.</strong> You starts with the very first assembly in the chain of dependency, the one that does not depends on any other assembly in the project, and you start checking compatibility with.NET standard for all referenced NuGet Packages. Once the first project is done you proceed with the remaining.</p><p>The very first step is converting <a href=http://www.codewrecks.com/blog/index.php/2018/10/27/converting-a-big-project-to-new-vs2017-csproj-format/>all project files to new project format</a>, leave all project to target full framework, then you can use a nice technique called MultiTargeting starting with the aforementioned first assembly of the chain.</p><blockquote><p>Multitargeting allows you to target both framework with a single Visual Studio Project</p></blockquote><p>To enable it just edit project files, and change TargetFramework to TargetFramework <strong>s</strong> (mind the final s) and specify that you want that project compiled for Full Framework and.NET Standard. Including.NET Standard in the list of target framework requires removal of all code that is dependent on Full Framework, but this <strong>is not always obtainable in a single big bang conversion, because the amount of code could be really high.</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image-10.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-10.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-10.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Multi Targeting in action</em></p><p><strong>To easy the transition I usually add some constants so I’ll be able to use #ifdef directive to isolate some piece of code only when the project is targeting Full Framework.</strong><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#f92672>&lt;PropertyGroup</span> <span style=color:#a6e22e>Condition=</span><span style=color:#e6db74>&#34; &#39;$(TargetFramework)&#39; == &#39;netstandard2.0&#39;&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;DefineConstants&gt;</span>NETCORE;NETSTANDARD;NETSTANDARD2_0<span style=color:#f92672>&lt;/DefineConstants&gt;</span>
  <span style=color:#f92672>&lt;/PropertyGroup&gt;</span>

  <span style=color:#f92672>&lt;PropertyGroup</span> <span style=color:#a6e22e>Condition=</span><span style=color:#e6db74>&#34; &#39;$(TargetFramework)&#39; == &#39;net461&#39;&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;DefineConstants&gt;</span>NET45;NETFULL<span style=color:#f92672>&lt;/DefineConstants&gt;</span>
  <span style=color:#f92672>&lt;/PropertyGroup&gt;</span></code></pre></td></tr></table></div></div></p><blockquote><p>Thanks to conditional compile we can have some of the code that is compiled only for full framework, or we can have different implementation for a given class (full or netstandard)</p></blockquote><p>After multitarget is enabled and netstandard is one of the target,  project usually stops compiling, because it usually contains some code that depends on full framework. There are two distinct problems: A) nuget packages that does not support netstandard, B) references to full framework assembly. <strong>To solve the problem you must use conditional referencing, setting the references only for specific framework version.</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image-11.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-11.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-11.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Conditional reference in action.</em></p><p>As you can see in <strong>Figure 2</strong> I can reference difference nuget packages or assemblies depending on the version of framework used. <strong>The nice part is being able to reference different version of a library (ex System.Buffers) for full framework or.net standard framework.</strong> At this point the project usually stops compiling because code references classes that are not available in netstandard, as an example in <strong>Figure 2</strong> you can verify that netstandard misses lots of references like System.Runtime.Caching and System.Runtime.Remoting. <strong>For all code that uses references not available for netstandard project just use a #ifdef NETFULL to compile those classes only with full framework.</strong> This is not a real complete solution, but at the end you will have your project that is still fully functional with.NET full framework, and a nice list of #ifdef NETFULL that identify the only parts that are not available in netstandard. Now you can continue working as usual while slowly removing and upgrading all the code to netstandard.</p><p>Now repeat the process this for every project in the solution, usually there are two scenarios:</p><p><em>1) The vast majority of the code is full functional with netstandard, there are very few point in the code where you use #ifdef NETFULL.<br>2) Some of the classes / functionality available only in full framework are extensively used in all of your code, the amount of code with #ifdef NETFULL is becoming too big</em></p><p>Point 1 is the good side, you can continue working with full framework then convert remaining code with your pace. If you find yourself in point 2, as an example if some code uses MSMQ you should <strong>isolate the full framework depending code in a single class, then use Inversion Of Control to inject concrete class.</strong> As an example, instead of having lots of points in the code that uses MSMQ simply abstract all the code in a IQueue interface, create a MSMQQueue class and you have a single point of code that is not available for netstandard. You can then write code that uses Rabbit MQ and the problem is gone with a simple class rewrite.</p><p>Lets do an example: <strong>I have a InMemoryCacheHelper to abstract the usage of MemoryCache, and since MemoryCache class from System.Runtime.Caching is not available in netstandard, I simply protect the class with #if NETFULL conditional compiling.</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image-13.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-13.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-13.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Conditional compilation, this is version of the class for NET Full.</em></p><p>Looking in the documentation there is a nuget package called Microsoft.Extensions.Caching.Memory meant to be a replacement for MemoryCache standard full framework class. I can use this NuGet packages to create an implementation of InMemoryCacheHelper compatible with netstandard.</p><blockquote><p>When you enable multitargeting it is quite common to manually edit references in project file, because references are different from Full Framework build and NetStandard build.</p></blockquote><p><strong>Remember that you need to reference the full framework version (1) for net461 compilation, but reference nuget package for netstandard version. This can be done manually editing references in csproj file</strong> <strong>Figure 4</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image-14.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-14.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-14.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>Reference the correct assembly or NugetPackage based on framework version.</em></p><p>Now you come back to the InMemoryCacheHelper class add an #else branch to the #ifdef NETFULL directive and start writing a version of the class that uses Microsoft.Extensions.Caching.Memory. One class after another you will have all of your code that is able to target both net full and netcore. <strong>You can rewrite the entire class or you can use the same class and use #if NETFULL inside each method, I prefer the first approach but this is what happens when I’m starting editing the netstandard version of the class</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image-15.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-15.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-15.png alt=image></a></a></p><p><em><strong>Figure 5</strong></em>: <em>No highlight and no intellisense because we are in a conditional compilation branch that evaluates to false.</em></p><p>Ouch, since we are in a branch of conditional compilation that evaluate to false, VS does not offer highligh, no intellisense, everything is greyed out. At this point you should be aware that, <strong>when you use multitargeting, the order of the frameworks in the project file matters. The first framework in &lt;TargetFrameworks> node is the one that VS would use to evaluate conditional compilation</strong>. This means that, when you are working on classes or piece of code that should target both full framework and NET standard, you need to change the order to fit your need.</p><p>In this example I needed to change &lt;TargetFrameworks>net461;netstandard2.0;&lt;/TargetFrameworks> to &lt;TargetFrameworks>netstandard2.0;net461&lt;/TargetFrameworks>, save project file and unload and reload the project (sometimes you need to force a project reload) and Visual Studio will consider netstandard2.0 during code editing.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image-16.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-16.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/07/image_thumb-16.png alt=image></a></a></p><p><em><strong>Figure 6</strong></em>: <em>Reversing the order of the frameworks, will enable intellisense for netstandard branch of the conditional compilation directive.</em></p><p>Now you can edit the netstandard version of your class and convert one by one all parts of the code that does not natively run on netstandard.</p><p>Happy coding.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/visual-studio/>Visual Studio</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/visual-studio/>Visual Studio</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2019/07/how-to-configure-visual-studio-as-diff-and-merge-tool-for-git/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>How to configure Visual Studio as Diff and Merge tool for Git</a></div><div class="next-entry sep-before"><a href=/post/old/2019/08/azure-devops-gems-yaml-pipeline-and-templates/><span class=screen-reader-text>Next post: </span>Azure DevOps gems YAML Pipeline and Templates<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>