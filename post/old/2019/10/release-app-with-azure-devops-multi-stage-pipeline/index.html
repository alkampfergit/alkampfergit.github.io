<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MultiStage pipelines are still in preview on Azure DevOps, but it is time to experiment with real build-release pipeline, to taste the news. The Biggest limit at this moment is that you can use Multi Stage to deploy in Kubernetes or in the cloud, but there is not support for agent in VM (like standard release engine). This support will be added in the upcoming months but if you use azure or kubernetes as a target you can already use it."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Release app with Azure DevOps Multi Stage Pipeline • Codewrecks"><meta property="og:description" content="MultiStage pipelines are still in preview on Azure DevOps, but it is time to experiment with real build-release pipeline, to taste the news. The Biggest limit at this moment is that you can use Multi Stage to deploy in Kubernetes or in the cloud, but there is not support for agent in VM (like standard release engine). This support will be added in the upcoming months but if you use azure or kubernetes as a target you can already use it."><meta property="og:url" content="https://www.codewrecks.com/post/old/2019/10/release-app-with-azure-devops-multi-stage-pipeline/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="AzureDevOps"><meta property="article:tag" content="build"><meta property="article:tag" content="release"><meta property="article:published_time" content="2019-10-21T15:00:37+02:00"><meta property="article:modified_time" content="2019-10-21T15:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Release app with Azure DevOps Multi Stage Pipeline • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2019/10/release-app-with-azure-devops-multi-stage-pipeline/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Release app with Azure DevOps Multi Stage Pipeline</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Release app with Azure DevOps Multi Stage Pipeline</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2019-10-21T15:00:37+02:00>2019, Oct 21</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>MultiStage pipelines are still in preview on Azure DevOps, but it is time to experiment with real build-release pipeline, to taste the news. The Biggest limit at this moment is that you can use Multi Stage to deploy in Kubernetes or in the cloud, but there is not support for agent in VM (like standard release engine). This support will be added in the upcoming months but <strong>if you use azure or kubernetes as a target you can already use it.</strong> My sample solution is <a href=https://github.com/alkampfergit/AzureDevopsReleaseSamples>in GitHub</a>, it contains a real basic Asp.NET core project that contains some basic REST API and a really simple angular application. On of the advantage of having everything in the repository is that you can simply fork my repository and make experiment.</p><blockquote><p>Thanks to Multi Stage Pipeline we finally can have build-test-release process directly expressed in source code.</p></blockquote><p>First of all you need to enable MultiStage Pipeline for your account in the Preview Features, clicking on your user icon in the upper right part of the page.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-35.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-35.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-35.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Enable MultiStage Pipeline with the Preview Features option for your user</em></p><p>Once MultiStage Pipeline is enables, all I need to do is to create a nice release file to deploy my app in azure. <strong>The complete file is here</strong> <a href=https://github.com/alkampfergit/AzureDevopsReleaseSamples/blob/develop/CoreBasicSample/builds/build-and-package.yaml title=https://github.com/alkampfergit/AzureDevopsReleaseSamples/blob/develop/CoreBasicSample/builds/build-and-package.yaml><strong>https://github.com/alkampfergit/AzureDevopsReleaseSamples/blob/develop/CoreBasicSample/builds/build-and-package.yaml</strong></a> and I will highlight the most important part here. This is the starting part.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-36.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-36.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-36.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>First part of the pipeline</em></p><p>One of the core differences from a standard pipeline file is the structure of jobs, <strong>after trigger and variables, instead of directly having jobs, we got a stages section, followed by a list of stages that in turns contains jobs</strong>. In this example the first stage is called build_test, it contains all the jobs to build my solution, run some tests and compile Angular application. Inside a single stage we can have more than one job and in this particular pipeline I divided the build_test phase in two sub jobs, <strong>the first is devoted to build ASP.NET core app, the other will build the Angular application.</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-37.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-37.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-37.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Second job of first stage, building angular app.</em></p><p>This part should be familiar to everyone that is used to YAML pipeline, because it is, indeed, a standard sequences of jobs; the only difference is that we put them under a stage. <strong>The convenient aspect of having two distinct jobs, is that they can be run in parallel, reducing overall compilation time.</strong> > <strong>If you have groups of taks that are completely unrelated, it is probably bettere to divide in multiple jobs and have them running in parallel.</strong> The second stage is much more interesting, because it contains a completely different type of job, called deployment, used to deploy my application.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-38.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-38.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-38.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>Second stage, used to deploy the application</em></p><p>The dependsOn section is needed to specify that this stage can run only after build_test stage is finished. Then it starts jobs section that contains a single deployment job. <strong>This is a special type of job where you can specify the pool, name of an environment and then a strategy of deploy</strong> ; in this example I choose the simplest, a run once strategy composed by a list of standard tasks.</p><p><strong>If you ask yourself what is the meaning of environment parameter, I’ll cover it in much extension on a future post, for this example just ignore it, and consider it as a way to give a name to the environment you are deploying.</strong> > MultiStage pipeline introduced a new job type called deployment, used to perform deployment of your application</p><p>All child steps of deployment job are standard tasks used in standard release, the only limitation of this version is that they run on the agent, you cannot run on machine inside environment (you cannot add anything else than kubernetes cluster to an environment today).</p><p>The nice aspect is that, since this stage depends on build_test, when deployment section runs, <strong>it automatically download artifacts produced by previous stage and place them in folder $(Pipeline.Workspace) followed by another subdirectory that has the name of the artifacts itself</strong>. This solves the need to transfer artifact of the first stage (build and test) to deployment stage</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-39.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-39.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-39.png alt=image></a></a></p><p><em><strong>Figure 5</strong></em>: <em>Steps for deploying my site to azure.</em></p><p>Deploying the site is really simple, I just unzip asp.NET website to a subdirectory called FullSite, then copy all angular compiled file in www folder and <strong>finally use a standard AzureRmWebAppDeployment to deploy my site to my azure website.</strong> Running the pipeline shows you a different user interface than a standard build, clearly showing the result for each distinct stage.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-40.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-40.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-40.png alt=image></a></a></p><p><em><strong>Figure 6</strong></em>: <em>Result of a multi stage pipeline has a different User Interface</em></p><p>I really appreciate this nice graphical representation of how the stage are related. For this example the structure is is really simple (two sequential steps), but <strong>it shows clearly the flow of deployment and it is invaluable for most complex scenario</strong>. If you click on Jobs you will have the standard view, where all the jobs are listed in chronological order, with the Stage column that allows you to identify in which stage the job was run.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-41.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-41.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-41.png alt=image></a></a></p><p><em><strong>Figure 7</strong></em>: <em>Result of the multi stage pipeline in jobs view</em></p><p>All the rest of the pipeline is pretty much the same of a standard pipeline, the only notable difference is that <strong>you need to use the stage view to download artifacts, because each stage has its own artifacts</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-42.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-42.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-42.png alt=image></a></a></p><p><em><strong>Figure 8</strong></em>: <em>Downloading artifacts is possible only in stages view, because each stage has its own artifacs.</em></p><p>Another nice aspect is that you can simply rerun each stage, useful is some special situation (like when your site is corrupted and you want to redeploy without rebuilding everything)</p><p>Now I only need to check if my sites was deployed correctly and … voilà everything worked as expected, my site is up and running.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image-43.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-43.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/10/image_thumb-43.png alt=image></a></a></p><p><em><strong>Figure 9</strong></em>: <em>Interface of my really simple sample app</em></p><p><strong>Even if MultiStage pipeline is still in preview, if you need to deploy to azure or kubernetes it can be used without problem</strong> , the real limitation of actual implementation is the inability to deploy with agents inside VM, a real must have if you have on-premise environment.</p><p>On the next post I’ll deal a little more with Environments.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/azure-devops/>Azure DevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/azuredevops/>AzureDevOps</a>, <a class=tag href=/tags/build/>build</a>, <a class=tag href=/tags/release/>release</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2019/10/vulnhub-tr0ll3-walktrough/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Vulnhub Tr0ll3 walktrough</a></div><div class="next-entry sep-before"><a href=/post/old/2019/10/github-security-alerts/><span class=screen-reader-text>Next post: </span>GitHub security Alerts<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>