<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I’ve blogged in the past about deploying ASP.NET application, but lots of new feature changed in Azure DevOps and it is time to do some refresh of basic concepts. Especially in the field of web.config transform there is always lots of confusion and even if I’m an advocate of removing every configuration from files and source, it is indeed something that worth to be examined. > The best approach for configuration is removing then from source control, use configuration services, etc and move away from web."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Build and Deploy AspNet App with Azure DevOps • Codewrecks"><meta property="og:description" content="I’ve blogged in the past about deploying ASP.NET application, but lots of new feature changed in Azure DevOps and it is time to do some refresh of basic concepts. Especially in the field of web.config transform there is always lots of confusion and even if I’m an advocate of removing every configuration from files and source, it is indeed something that worth to be examined. > The best approach for configuration is removing then from source control, use configuration services, etc and move away from web."><meta property="og:url" content="https://www.codewrecks.com/post/old/2019/03/build-and-deploy-asp-net-app-with-azure-devops/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="build"><meta property="article:tag" content="release"><meta property="article:published_time" content="2019-03-28T19:00:37+02:00"><meta property="article:modified_time" content="2019-03-28T19:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Build and Deploy AspNet App with Azure DevOps • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2019/03/build-and-deploy-asp-net-app-with-azure-devops/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Build and Deploy AspNet App with Azure DevOps</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Build and Deploy AspNet App with Azure DevOps</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2019-03-28T19:00:37+02:00>2019, Mar 28</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>I’ve blogged in the past about deploying ASP.NET application, but lots of new feature changed in Azure DevOps and it is time to do some refresh of basic concepts. <strong>Especially in the field of web.config transform there is always lots of confusion and even if I’m an advocate of removing every configuration from files and source, it is indeed something that worth to be examined.</strong> > <strong>The best approach for configuration is removing then from source control, use configuration services, etc and move away from web.config.</strong> But since most people still use web.config, lets start with a standard ASP.NET application with a Web.Config and a <strong>couple of application settings that should be changed during deploy.</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-8.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-8.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-8.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Simple configuration file with two settings</em></p><p>When it is time to configure your release pipeline, you <strong>MUST adhere to the mantra: Build once, deploy many. This means that you should have one build that prepares the binaries to be installed, and the very same binaries will be deployed in several environment.</strong> Since each environment will have a different value for app settings stored in web.config, I’ll start creating a web config transform for the Release configuration (then one that will be released), changing each configuration with a specific token.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-9.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-9.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-9.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Transformation file that tokenize the settings</em></p><p>In Figure 2 I show how I change the value of Key1 setting to __Key1__ and Key2 to __Key2 <strong>__. This is necessary because I’ll replace these value with the real value during release.</strong> > The basic trick is changing configuration values in files during the build, setting some tokenized value that will be replaced during release. Using double underscore as prefix and suffix is enough for most situations.</p><p>Now it is time to create a build that generates the package to install. The pipeline is really simple, the solution is build with MsBuild with standard configuration for publishing web site. I’ve used MsBuid and not Visual Studio Task, because I do not want to have Visual Studio on my build agent to build, MsBuild is enough.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-10.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-10.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-10.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Build and publish web site with a standard MsBuild task.</em></p><p>If you run the build you will be disappointed <strong>because resulting web.config is not transformed, but it remains with the very content of the one in source control.</strong> This happens because transformation is an operation that is not done during standard web site publishing, but from Visual Studio when you use publish wizard. <strong>Luckly enough there is a task in preview that performs web.config transformation, you can simply place this task before MsBuild task and the game is done.</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-11.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-11.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-11.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>File transform task is in preview but it does its work perfectly</em></p><p>As you can see in Figure 4, you should simply specify the directory of the application, then choose XML transformation and finally the option to use web.$(BuildConfiguration).config transformation file to transform web.config.</p><p>Now you only need to copy the result of the publish into the artifact staging directory, then upload with standard upload artifact task.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-12.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-12.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-12.png alt=image></a></a></p><p><em><strong>Figure 5</strong></em>: <em>Copy result of the publish task into staging directory and finally publish the artifact.</em></p><p>If you read other post of my blob you know that I usually place a PowerShell script that reorganize files, compress etc, but for this simple application it is perfectly fine to copy the _PublishedWebsites/ directory as build artifact.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-13.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-13.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-13.png alt=image></a></a></p><p><em><strong>Figure 6</strong></em>: <em>Published artifacts after the build completes.</em></p><blockquote><p>Take time to verify that the output of the build (Artifacts) is exactly what you expected before moving to configure the release.</p></blockquote><p>Before going to build the release phase, please download the web.config file and verify that the substitution were performed and web.config contains what you expected.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-14.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-14.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-14.png alt=image></a></a></p><p><strong>Fiure 7:</strong> <em>Both of my settings were substituted correctly.</em></p><p><strong>Now it is time to create the release, but first of all I suggest you to install</strong> <a href="https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens&targetId=0ab47163-c335-4202-af04-4f37a747eecb&utm_source=vstsproduct&utm_medium=ExtHubManageList"><strong>this extension</strong></a> <strong>that contains a nice task to perform substitution during a release in an easy and intuitive way.</strong> > <strong>One of the great power of Azure DevOps is extensibility, there are tons of custom task to perform lots of different task, so take time and look in the marketplace if you are not able to find the Task you need from basic ones.</strong> Lets start creating a simple release that uses the previous build as artifact, and contains two simple stages, dev and production.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-15.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-15.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-15.png alt=image></a></a></p><p><em><strong>Figure 8</strong></em>: <em>Simple release with two stages to deploy the web application.</em></p><p>Each of the two stages have a simple two task job to deploy the application and they are based on the assumption that each environment was already configured (IIS installed, site configure etc), so, <strong>to deploy our asp.net app, we can simply overwrite the old installation folder and replace with the new binaries.</strong> The Replace Token task comes in hand in this situation, you simply need to add as the first task of the job (before the task that copies file into IIS directory), <strong>then configure prefix and suffix with the two underscore to match criteria used to tokenize configuration in web.config</strong> <a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-16.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-16.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-16.png alt=image></a></a></p><p><em><strong>Figure 9</strong></em>: <em>Configure replace token suffix and prefix to perform substitution.</em></p><p>In this example only web.config should be changed, but the task can perform substitution on multiple files.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-17.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-17.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-17.png alt=image></a></a></p><p><em><strong>Figure 10</strong></em>: <em>Substition configuration points to web.config file.</em></p><p>The beautiful aspect of transform task is that it uses all the variables of the release to perform substitution. <strong>For each variable it replace token using prefix and suffix, this is the reason of my transformation release file in the build; my web.config file has __Key1__ and __Key2__ token inside configuration, so I can simply configure those two variables differently for the two environment and my release is finished.</strong> If you use Grid visualization it is immediate to understand how each stage is configured.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-18.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-18.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-18.png alt=image></a></a></p><p><em><strong>Figure 11</strong></em>: <em>Configure variables for each stage, the replace task will do the rest.</em></p><p>Everything is done, just trigger a release and verify that the web config of the two stages is changed accordingly.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image-19.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-19.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/03/image_thumb-19.png alt=image></a></a></p><p><em><strong>Figure 12</strong></em>: <em>Sites deployed in two stages with different settings, everything worked as expected.</em></p><p>Everything worked good, I was able to build once with web.config tokenization, then release the same artifacts in different stages with different configurations managed by release definition.</p><p>Happy AzDo</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/azure-devops/>Azure DevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/build/>build</a>, <a class=tag href=/tags/release/>release</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2019/03/yaml-build-in-azure-devops/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>YAML Build in Azure DevOps</a></div><div class="next-entry sep-before"><a href=/post/old/2019/04/troubleshoot-yaml-build-first-run/><span class=screen-reader-text>Next post: </span>Troubleshoot YAML Build first run<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>