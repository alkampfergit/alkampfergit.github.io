<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="If you want to build an OpenSource project with Azure DevOps, you can open a free account and you have 10 concurrent pipelines with free agents to build your project, yes, completely free. The only problem you have in this scenario is that, sometimes, you need some prerequisites installed on the build machine, like MongoDb and they are missing on hosted build.
Lets take as use case NStore, an open source library for Event Sourcing in C# that needs to run unit test against MongoDb and SqlServer, prerequisites that are not present in Linux Hosted Agents."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Hosted Agents plus Docker perfect match for Azure DevOps and Open source Project • Codewrecks"><meta property="og:description" content="If you want to build an OpenSource project with Azure DevOps, you can open a free account and you have 10 concurrent pipelines with free agents to build your project, yes, completely free. The only problem you have in this scenario is that, sometimes, you need some prerequisites installed on the build machine, like MongoDb and they are missing on hosted build.
Lets take as use case NStore, an open source library for Event Sourcing in C# that needs to run unit test against MongoDb and SqlServer, prerequisites that are not present in Linux Hosted Agents."><meta property="og:url" content="https://www.codewrecks.com/post/old/2019/06/hosted-agents-plus-docker-perfect-match-for-azure-devops-and-open-source-project/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="General"><meta property="article:published_time" content="2019-06-10T20:00:37+02:00"><meta property="article:modified_time" content="2019-06-10T20:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Hosted Agents plus Docker perfect match for Azure DevOps and Open source Project • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2019/06/hosted-agents-plus-docker-perfect-match-for-azure-devops-and-open-source-project/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Hosted Agents plus Docker perfect match for Azure DevOps and Open source Project</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Hosted Agents plus Docker perfect match for Azure DevOps and Open source Project</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2019-06-10T20:00:37+02:00>2019, Jun 10</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>If you want to build an OpenSource project with Azure DevOps, <strong>you can open a free account and you have 10 concurrent pipelines with free agents to build your project, yes, completely free</strong>. The only problem you have in this scenario is that, sometimes, you need some prerequisites installed on the build machine, like MongoDb and they are missing on hosted build.</p><p>Lets take as use case <a href=https://github.com/ProximoSrl/NStore>NStore</a>, an open source library for Event Sourcing in C# that needs to run unit test against MongoDb and SqlServer, prerequisites that are not present in Linux Hosted Agents. Before giving up using Hosted Agents and start deploying private agents, <strong>you need to know that Docker is up and running in Hosted Agents and it can be used to have your missing prerequisites</strong>.</p><blockquote><p>Thanks to docker you can simply have prerequisites for your build to run in an Hosted Environment</p></blockquote><p>Having docker preinstalled on Hosted Buil Agent gives you a tremendous power, combined with Docker Task. If I want to run a build on Linux Hosted agent of NStore, here is a possible build that runs perfectly fine.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Simple build definition that starts a MongoDb and Sql Server instance with Docker before actually running th ebuild.</em></p><p>If you examine the very first task it is amazing how simple it is to start a MsSql instance running on your Linux box. <strong>At the end of Task execution you have a fully functional container running in Hosted Agent</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image-1.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-1.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-1.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Running MsSql as a container in Linux</em></p><p>You just need to remember to redirect the port (-p 1433:1433) so that you can access SqlServer instance and the game is done.</p><p>Task number 2 uses the very same technique to run a MongoDB instance inside another docker container instance then Task 3 is a simple Docker Ps command, just to verify that the two container are running correctly. As you can see from <strong>Figure 3</strong> , it is quite useful to know if the container really started correctly.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image-2.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-2.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-2.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Ps command allows for simple dump of all containers running in the machine</em></p><p>You can log every container output, <strong>in Task number 4 I’m just running a logs command for the MsSql container, just to verify, in case MsSql test are all failing, why the container did not started</strong> (like you forgot the ACCEPT_EULA, or you choose a password not enough complex.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image-3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-3.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>Logging output of container to troubleshoot them.</em></p><p>Remember that if the container does not start correctly your build will have tons of failing tests, so <strong>you really need a way to quick understand if tests are really failing or your container instance simply did not start (and the reason why it failed)</strong> All subsequent tasks are standard for a.NET Core project, just dotnet restore, build and test your solution, and upload test results in the build result, so you can have a nice result of all of your tests.</p><blockquote><p>It is almost impossible to pretend that someone gives you a build agent with Everything you can possibly need, but if you give to the user Docker support, life is really easier.</p></blockquote><p>Finally, to make everything flexible, you should grab connection strings for Tests from environment variables. NStore uses a couple of Environment Variable called NSTORE_MONGODB and NSTORE_MSSQL to specify connection strings used for test. I really want you to remember that all Variables of a build are copied to Environment Variables during the build.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image-4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2019/06/image_thumb-4.png alt=image></a></a></p><p><em><strong>Figure 5</strong></em>: <em>Configuration of test connection strings are directly stored in Build Variables.</em></p><p>As you can see from <strong>Figure 5</strong> I used a MongoDb without password (this is a instance in docker that will be destroyed after the build, so it is acceptable to run without a password) but you can usually configure Docker Instances with start parameters. In that example I gave SQL Server a strong password (it is required for the container to start).</p><p><strong>Remember, if you have an open source project, you can build for free with Azure DevOps pipelines with minimum effort and before giving away using Hosted Agents, just verify if you can have what you miss with Docker.</strong> Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/general/>general</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/general/>General</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2019/05/azure-devops-and-secdevops/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Azure DevOps and SecDevOps</a></div><div class="next-entry sep-before"><a href=/post/old/2019/06/install-latest-node-version-in-azure-pipelines/><span class=screen-reader-text>Next post: </span>Install latest node version in Azure Pipelines<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>