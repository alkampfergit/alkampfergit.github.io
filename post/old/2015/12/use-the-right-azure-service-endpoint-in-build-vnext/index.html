<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Build vNext has a task dedicated to uploading files in azure blob , as you can see from Figure 1: 
Figure 1: Azure File Copy task configured in a vNext build
The nice parte is the Azure Subscription setting, that allows to choose one of the Azure endpoint configured for the project. Using service endpoint, you can ask to the person that has password/keys for Azure Account to configure an endpoint."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Use the right Azure Service Endpoint in build vNext • Codewrecks"><meta property="og:description" content="Build vNext has a task dedicated to uploading files in azure blob , as you can see from Figure 1: 
Figure 1: Azure File Copy task configured in a vNext build
The nice parte is the Azure Subscription setting, that allows to choose one of the Azure endpoint configured for the project. Using service endpoint, you can ask to the person that has password/keys for Azure Account to configure an endpoint."><meta property="og:url" content="https://www.codewrecks.com/post/old/2015/12/use-the-right-azure-service-endpoint-in-build-vnext/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="Azure"><meta property="article:tag" content="build"><meta property="article:tag" content="VSTS"><meta property="article:published_time" content="2015-12-29T08:00:37+02:00"><meta property="article:modified_time" content="2015-12-29T08:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Use the right Azure Service Endpoint in build vNext • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2015/12/use-the-right-azure-service-endpoint-in-build-vnext/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Use the right Azure Service Endpoint in build vNext</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Use the right Azure Service Endpoint in build vNext</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2015-12-29T08:00:37+02:00>2015, Dec 29</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>Build vNext has a <strong>task dedicated to uploading files in azure blob</strong> , as you can see from <em><strong>Figure 1</strong></em>: <a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image2.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb2.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb2.png alt="Sample build vNext that has an Azure File Copy task configured."></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Azure File Copy task configured in a vNext build</em></p><p>The nice parte is the Azure Subscription setting, that allows to choose one of the Azure endpoint configured for the project. Using service endpoint, you can ask to the person that has password/keys for Azure Account to configure an endpoint. Once it is configured <strong>it can be used by team members with sufficient right to access it, without requiring them to know password or token or whatever else</strong>.</p><blockquote><p>Thanks to Services Endpoints you can allow member of the team to create builds that can interact with Azure Accounts without giving them any password or token</p></blockquote><p>If you look around you find a nice blog post that explain how to <a href=http://blogs.msdn.com/b/visualstudioalm/archive/2015/10/04/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-build-release-management.aspx>connect your VSTS account using a service principal</a>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb3.png alt="SAmple of configuration of an Endpoint for Azure with Service Principal"></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Configure a service endpoint for Azure with Service Principal Authentication</em></p><p>Another really interesting aspect of Service Endpoints, is the ability to choose people that can administer the account and people that can use the endpoint, thus giving you full security on who can do what.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb4.png alt="Each Service endpoint has its security setting to specify people that can administer or read the endpoint"></a></a></p><p><em><strong>Figure 3</strong></em>: <em>You can manage security for each Service Endpoint configured</em></p><p>Finally, using Service Endpoint you have a <strong>centralized way to manage accessing your Azure Subscription Resources</strong> , if for some reason a subscription should be removed and not used anymore, you can simply remove the endpoint. This is a better approach than having data and password or token scattered all over the VSTS account (builds, etc).</p><p>I’ve followed all the steps in the article to <a href=http://blogs.msdn.com/b/visualstudioalm/archive/2015/10/04/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-build-release-management.aspx>connect your VSTS account using a service principal</a>, but when it is time to execute the Azure File Copy action, I got a strange error.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Executing the powershell script: C:<span style=color:#ae81ff>\L</span>R<span style=color:#ae81ff>\M</span>MS<span style=color:#ae81ff>\S</span>ervices<span style=color:#ae81ff>\M</span>ms<span style=color:#ae81ff>\T</span>askAgentProvisioner<span style=color:#ae81ff>\T</span>ools<span style=color:#ae81ff>\a</span>gents<span style=color:#ae81ff>\d</span>efault<span style=color:#ae81ff>\t</span>asks<span style=color:#ae81ff>\A</span>zureFileCopy<span style=color:#ae81ff>\1</span>.0.25<span style=color:#ae81ff>\A</span>zureFileCopy.ps1
Looking <span style=color:#66d9ef>for</span> Azure PowerShell module at C:<span style=color:#ae81ff>\P</span>rogram Files <span style=color:#f92672>(</span>x86<span style=color:#f92672>)</span><span style=color:#ae81ff>\M</span>icrosoft SDKs<span style=color:#ae81ff>\A</span>zure<span style=color:#ae81ff>\P</span>owerShell<span style=color:#ae81ff>\S</span>erviceManagement<span style=color:#ae81ff>\A</span>zure<span style=color:#ae81ff>\A</span>zure.psd1
AzurePSCmdletsVersion<span style=color:#f92672>=</span> 0.9.8.1
Get-ServiceEndpoint -Name 75a5dd41-27eb-493a-a4fb-xxxxxxxxxxxx -Context Microsoft.TeamFoundation.DistributedTask.Agent.Worker.Common.TaskContext
tenantId<span style=color:#f92672>=</span> ****** **azureSubscriptionId<span style=color:#f92672>=</span> xxxxxxxx-xxxxxxx-xxxx-xxxx-xxxxxxxxxx
azureSubscriptionName<span style=color:#f92672>=</span> MSDN Principal
Add-AzureAccount -ServicePrincipal -Tenant $tenantId -Credential $psCredential
There is no subscription associated with account** **** **.
Select-AzureSubscription -SubscriptionId xxxxxxxx-xxxxxxx-xxxx-xxxx-xxxxxxxxxx
The subscription id xxxxxxxx-xxxxxxx-xxxx-xxxx-xxxxxxxxxx doesn<span style=color:#960050;background-color:#1e0010>&#39;</span>t exist.
Parameter name: id
The Switch-AzureMode cmdlet is deprecated and will be removed in a future release.
The Switch-AzureMode cmdlet is deprecated and will be removed in a future release.
Storage account: portalvhdsxxxxxxxxxxxxxxxxx1 not found. Please specify existing storage account</code></pre></td></tr></table></div></div><p>This error is really strange because the first error line told me:</p><blockquote><p>** The subscription id xxxxxx-xxxxxx-xxxxxx-xxxxxxxxxxxxx doesn’t exist. <strong>This cannot be the real error, because I’m really sure that my Azure Subscription is active and it is working everywere else. Thanks to the help of <a href=https://social.msdn.microsoft.com/profile/roopesh%20nair/>Roopesh Nair</a>, I was able to find my mistake. It turns out that the</strong> Storage Account I’m trying to access is an old one created with Azure Classic Mode, and it is not accessible with Service Principal. **A Service Endpoint using Service Principal can manage only Azure Resource Manager based entities.</p></blockquote><p>Shame on me :) because I was aware of this limitation, but for some reason I completely forgot it this time.</p><p>Another sign of the problem is the error line telling me: Storage account xxxxxxxxx not found, that should ring a warning bell about the** script not being able to find that specific resource, because it is created with classic mode **.</p><p>The solution is simple, I could use a Blob Storage created with Azure Resource Manager, or I can configure another Service Endpoint, this time based on a management certificate. The second option is preferrable, because** having two Service Endpoint, one configured with Service Principal and the other configured with Certificate allows me to manage all type of Azure Resources **.</p><p>Configure an endpoint with certificate is really simple, you should only copy data from the management certificate inside the Endpoint Configuration and you are ready to go.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image5.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb5.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/12/image_thumb5.png alt="Configuration of an endpoint based on Certificate"></a></a>** Figure 4: ***Configure an Endpoint based on Certificate*</p><p>Now my build task Azure File Copy works as expected and I can choose the right Service Endpoint based on what type of resource I should access (Classic or ARM)</p><p>Gian Maria</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/azure/>Azure</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/azure/>Azure</a>, <a class=tag href=/tags/build/>build</a>, <a class=tag href=/tags/vsts/>VSTS</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2015/12/finally-vsts-vso-has-basic-work-item-customization/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Finally VSTS VSO has Basic Work Item customization</a></div><div class="next-entry sep-before"><a href=/post/old/2015/12/rename-xmlrpc-php-on-your-wordpress-installation/><span class=screen-reader-text>Next post: </span>Rename xmlrpcphp on your WordPress installation<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>