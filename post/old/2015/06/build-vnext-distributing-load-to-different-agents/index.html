<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="One of the major benefit of the new build infrastructure of TFS and Visual Studio Online is the easy deployment of build agents. The downside of this approach is that your infrastructure become full of agents, and you should have some way to determine which agent(s) to use for a specific build. The problem is:
 avoid running builds in machines that are “not appropriate” for that build.
 Running on a specific agent If you are customizing a build, or if you are interested in running the build on a specific agent in a specific machine (ex: local agent), the solution is super easy, Just edit build definition and in General tab add a * demand *named Agent."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Build vNext distributing load to different agents • Codewrecks"><meta property="og:description" content="One of the major benefit of the new build infrastructure of TFS and Visual Studio Online is the easy deployment of build agents. The downside of this approach is that your infrastructure become full of agents, and you should have some way to determine which agent(s) to use for a specific build. The problem is:
 avoid running builds in machines that are “not appropriate” for that build.
 Running on a specific agent If you are customizing a build, or if you are interested in running the build on a specific agent in a specific machine (ex: local agent), the solution is super easy, Just edit build definition and in General tab add a * demand *named Agent."><meta property="og:url" content="https://www.codewrecks.com/post/old/2015/06/build-vnext-distributing-load-to-different-agents/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="build"><meta property="article:tag" content="devops"><meta property="article:published_time" content="2015-06-06T09:00:37+02:00"><meta property="article:modified_time" content="2015-06-06T09:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Build vNext distributing load to different agents • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2015/06/build-vnext-distributing-load-to-different-agents/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Build vNext distributing load to different agents</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Build vNext distributing load to different agents</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2015-06-06T09:00:37+02:00>2015, Jun 06</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>One of the major benefit of the new build infrastructure of TFS and Visual Studio Online is the <strong>easy deployment of build agents</strong>. The downside of this approach is that your infrastructure become full of agents, and you should have some way to <strong>determine which agent(s) to use for a specific build.</strong> The problem is:</p><blockquote><p>avoid running builds in machines that are “not appropriate” for that build.</p></blockquote><h2 id=running-on-a-specific-agent>Running on a specific agent</h2><p>If you are customizing a build, or if you are interested in running the build on a specific agent in a specific machine (ex: local agent), the solution is super easy, Just edit build definition and in General tab add a * <strong>demand</strong> *named Agent.Name with the value of the name of the specified Agent.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Adding a demand for a specific agent</em></p><p>If the agent is not available, you are warned when you try to queue the build.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image1.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb1.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb1.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Warning on build queuing when there are agents problem</em></p><p>In this situation <strong>the system is warning me that there are agents compatible to the build, but they are offline</strong>. You can queue the build and it will be executed when the Agent will be online again, or you can press cancel and understand why the agent is not online.</p><blockquote><p>If you want to run a build on a specific agent, just add Agent.Name demand on the build.</p></blockquote><h2 id=specifying-demands>Specifying demands</h2><p>The previous example is interesting because it is using Build Demands against properties of the agent. If you navigate on build agent admin page, <strong>for each agent you are able to see all associated properties</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image2.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb2.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb2.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Agent capabilities</em></p><p>On top there are User Capabilities that are editable. They are used to give custom capabilities to your agents. In bottom part there are <strong>System Capabilities, automatically determined by the agent itself and thus cannot be changed</strong>. If you examine all these capabilities you can see interesting capabilities such as VisualStudio that tells you if the agent is installed on a machine where Visual Studio is installed, other capabilities are also used to verify exact version of Visual Studio.</p><p>This is really important, because if you examine demands for a build you can verify that some of them are <strong>already placed in the build definition and they could not be removed</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb3.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>some of the demands are read-only, you can add your demand</em></p><p>If you wonder why the build has some predefined, readonly demands, the answer is: <strong>they are taken from the build definition</strong>.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb4.png alt=image></a></a></p><p><em><strong>Figure 5</strong></em>: <em>Build definition</em></p><p>If you look at the build definition, it contains a Visual Studio Build task, and it is this block that automatically adds the visualstudio demands on the build. This explain why that demand cannot be removed, it is required from a Build Step. You can <strong>try to remove Visual Studio Test task, and you can verify that the vstest demands is also gone</strong>.</p><blockquote><p>Each Build Task automatically adds demands to be sure to run in compatible agents.</p></blockquote><p>In my example I have some agents deployed on my office; they are used to run tests on some machines, and I use them to run build definitions composed only by build and test tasks, but <strong>no publish build artifacts.</strong> The reason is: I have really low upload bandwidth on my office, but I have fast machine on really fast SSD and tons of RAM so they are able to quickly build and test my projects.</p><p>Then I have some build used to Publish Artifacts, and I want to be sure that those build are not executed on agents in my office or they will saturate my upload Bandwidth. To avoid this problem I simply add * <strong>uploader</strong> *demands on these builds, and manually add this capability to agents deployed on machine that have no problem with Upload Bandwidth, Ex on agents deployed on Azure Virtual Machines.</p><blockquote><p>You can use custom Demands to be sure that a build runs on agents with specific capabilities.</p></blockquote><h2 id=using-agent-pools-to-separate-build-environments>Using Agent pools to separate build <em>environments</em></h2><p>The final solution to subdivide works to your agent is using agent pools. A pool is similar to the old concept of controller, each build is associated to a default pool, and it can be scheduled only on agents bounded to that pool. <strong>Using different pools can be useful if you have really different building environments, and you want to have a strong separation between them</strong>.</p><p>A possible example is, if you have agents deployed on fast machines with fast SSD or RAMDisk to speedup build and testing, you can create a dedicated pool with a name such as *FastPool.*Once the pool is created <strong>you can schedule high priority build on that pool to be sure that the build will be completed in the least amount of time</strong>. You can further subdivide agents in that pool using capabilities, such as: <em>SSD, RAMDISK, etc.</em></p><p>You can also create a pool called “Priority” to execute build with high priority and being sure that some slow build does not slow down high priority build and so on. If you have two different offices located very far away you can have a different pool for each office, to be sure that some builds are executed in local network for that office and so on.</p><blockquote><p>With Agent Pools you can have a strong separation between your build Environment.</p></blockquote><p>To conclude this post, you should use Agent Pools if you want to achieve strong separation and you are creating distinct <em>Build Environment</em>that shares some common strong characteristic (phisical location, machine speed, priority, etc). Inside a poll you can further subdivide work among agents using custom demands.</p><p>As final notice, as of today, with the latest update of VSO, the new build engine is not anymore in preview, the tab has no Asterisk anymore and the keyword PREVIEW is gone away :), so vNext in VSO reached GA.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image5.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb5.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2015/06/image_thumb5.png alt=image></a></a></p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/team-foundation-server/>Team Foundation Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/build/>build</a>, <a class=tag href=/tags/devops/>DevOps</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2015/06/tfs-new-build-system-vnext-agents/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>TFS New Build System vNext agents</a></div><div class="next-entry sep-before"><a href=/post/old/2015/06/build-vnext-and-continuous-integration-on-github/><span class=screen-reader-text>Next post: </span>Build vNext and continuous integration on GitHub<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>