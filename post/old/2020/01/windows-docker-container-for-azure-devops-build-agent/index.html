<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Thanks to Docker Compose, I can spin off an agent for Azure Devops in mere seconds (once you have all the images). Everything I need is just insert the address of my account a valid token and an agent is ready.
With.NET core everything is simple, because we have a nice build task that automatically install.NET Core SDK in the agent, the very same for node.js. This approach is really nice, because it does not require to preinstall too much stuff in your agent, everything is downloaded and installed on the fly when a build needs that specific tooling."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Windows Docker Container for Azure Devops Build agent • Codewrecks"><meta property="og:description" content="Thanks to Docker Compose, I can spin off an agent for Azure Devops in mere seconds (once you have all the images). Everything I need is just insert the address of my account a valid token and an agent is ready.
With.NET core everything is simple, because we have a nice build task that automatically install.NET Core SDK in the agent, the very same for node.js. This approach is really nice, because it does not require to preinstall too much stuff in your agent, everything is downloaded and installed on the fly when a build needs that specific tooling."><meta property="og:url" content="https://www.codewrecks.com/post/old/2020/01/windows-docker-container-for-azure-devops-build-agent/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="devops"><meta property="article:tag" content="Docker"><meta property="article:published_time" content="2020-01-25T11:00:37+02:00"><meta property="article:modified_time" content="2020-01-25T11:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Windows Docker Container for Azure Devops Build agent • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2020/01/windows-docker-container-for-azure-devops-build-agent/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Windows Docker Container for Azure Devops Build agent</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Windows Docker Container for Azure Devops Build agent</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-01-25T11:00:37+02:00>2020, Jan 25</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>Thanks to Docker Compose, <a href=http://www.codewrecks.com/blog/index.php/2019/12/27/azure-devops-agent-with-docker-compose/>I can spin off an agent for Azure Devops in mere seconds</a> (once you have all the images). Everything I need is just insert the address of my account a valid token and an agent is ready.</p><p><strong>With.NET core everything is simple, because we have a nice build task that automatically install.NET Core SDK in the agent,</strong> the very same for node.js. This approach is really nice, because it does not require to preinstall too much stuff in your agent, everything is downloaded and installed on the fly when a build needs that specific tooling.</p><blockquote><p>.NET core Node.Js and other SDK can be installed directly from build definition, without any requirement on the machine where the agent is running</p></blockquote><p>In my projects I need also to build solution based on Full Framework SDK and clearly I want to use the very same Docker approach for Agents. Everything I need is a machine with Windows Server2019 with docker enabled and looking in the internet for needed Dockerfile or pre build images on public registry.</p><p><strong>I’ve started with a nice article that explain how to</strong> <a href="https://docs.microsoft.com/en-us/visualstudio/install/build-tools-container?view=vs-2019"><strong>install Build Tools inside a container</strong></a> <strong>.</strong> This articles gives you a dockerfile that basically is doing everything, just docker build and the container is ready to be used.</p><p>The only real modification I need is excluding most of the packages I’m not using in my project; I’ve also changed base image to use.NET Framework 4.8 and not 4.7.2.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image-13.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-13.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-13.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>RUN instruction to install build tools inside a Docker Image.</em></p><p>Be prepared to wait a litlle bit for the image to be built, because it downloads all the packages from network and then install into the machine. To build the container image from dockerfile you can simply type.</p><p>docker build -t buildtools2019:1.0 -m 4GB.</p><p>Now I need to modify my Azure Devops Agent dockerfile built <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops">following MSDN instructions</a>  and change base image to <strong>FROM buildtools2019:1.0</strong> this will base the agent image on the new image built with all.NET sdk for full framework and all build tools. With this image the agent can build Full Framework projects.</p><blockquote><p>Creating a Docker Images with all needed tools for full framework SDK was really easy.</p></blockquote><p><strong>The other challenge on creating your build agent in Docker is having all the requirements in other docker images</strong> , for SQL Server I’ve rebuild the container on top of Windows Server Core 2019 image and it runs just fine, for MongoDb I’ve enabled experimental feature to mix Linux and Windows container so I’ve used a Linux based mongodb image with no problem.</p><p>My only remaining dependency was ElasticSearch, because I’m using an old version, 2.4 and I’d like to have that image running in Windows Container. <strong>It is not difficult to find some nice guy that published dockerfile for Elasticsearch, here</strong> <a href=https://github.com/StefanScherer/dockerfiles-windows title=https://github.com/StefanScherer/dockerfiles-windows><strong>https://github.com/StefanScherer/dockerfiles-windows</strong></a> you can find lots of interesting images for Windows. In my situation I only need Elasticsearch, so I’ve gotten the image, modified to install the version I need and the game is done.</p><p>Now I need to have some specific plugins installed in Elasticsearch for my integration tests to run; these situations are the ones where Docker shows its full powers. Since I’ve already an image with elasticsearch, I only need to create a DockerFile based on that image that install required plugin.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>FROM elasticsearch_custom:2.4.6.1

RUN <span style=color:#e6db74>&#34;C:\elasticsearch\bin\plugin.bat&#34;</span> install delete-by-query</code></pre></td></tr></table></div></div><p>Wow, just two lines of code launch docker build command and I have my ElasticSearch machine ready to be used.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image-14.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-14.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-14.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>All my images ready to be used in a Docker compose file</em></p><p>Now everything you need to do is create the docker compose file, here is an example</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>version: <span style=color:#e6db74>&#39;2.4&#39;</span>

services:
  agent:
    image: azdoagent:1.0
    environment:
      - AZP_TOKEN<span style=color:#f92672>=</span>****q
      - AZP_POOL<span style=color:#f92672>=</span>docker
      - AZP_AGENT_NAME<span style=color:#f92672>=</span>TestAlkampfer
      - AZP_URL<span style=color:#f92672>=</span>https://dev.azure.com/prxm
      - NSTORE_MONGODB<span style=color:#f92672>=</span>mongodb://mongo/nstoretest
      - NSTORE_MSSQL<span style=color:#f92672>=</span>Server<span style=color:#f92672>=</span>mssql;user id<span style=color:#f92672>=</span>sa;password<span style=color:#f92672>=</span>sqlPw3$secure
      - TEST_MONGODB<span style=color:#f92672>=</span>mongodb://mongo/
      - TEST_ES<span style=color:#f92672>=</span>http://es:9200

  mssql:
    image: mssqlon2019:latest
    environment:
      - sa_password<span style=color:#f92672>=</span>sqlPw3$secure
      - ACCEPT_EULA<span style=color:#f92672>=</span>Y
    ports:
      - <span style=color:#e6db74>&#34;1433:1433&#34;</span>

  mongo:
    platform: linux
    image: mongo
    ports:
      - <span style=color:#e6db74>&#34;27017:27017&#34;</span>

  es:
    image: elasticsearch_jarvis:1.0
    ports: 
      - <span style=color:#e6db74>&#34;9200:9200&#34;</span></code></pre></td></tr></table></div></div><p>Once the file is ready just start an agent with</p><p><em>docker-compose -f docker-compose.jarvis.yml  up –d</em></p><p>and your agent is up and running.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image-15.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-15.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-15.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>All docker images up and running</em></p><p><strong>Then I go to my C# project and included all the docker file needed to create images as well as docker compose file directly in source repository.</strong> This allows everyone to locally build docker image and spin out an agent with all the dependency needed to build the project.</p><p><strong>If your organization uses azure or any other container registry (you can also push to a public registry because all these images does not contains sensitive data) spinning the agent is only a matter of starting docker composer instance.</strong> After a couple of minutes (the time needed by azure devops agent to download everything and configure itself) my builds start running.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image-16.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-16.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2020/01/image_thumb-16.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>A build running a Full Framework solution with integration tests on MongoDB and Elasticsearch is running in my docker container.</em></p><p>From now on, every time I need to have another agent to build my project, I can simply spin out another docker-compose instance and in less than one minute I have another agent up and running.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/azure-devops/>Azure DevOps</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/devops/>DevOps</a>, <a class=tag href=/tags/docker/>Docker</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2020/01/why-i-love-devops-and-hate-devsecops/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Why I love DevOps and hate DevSecOps</a></div><div class="next-entry sep-before"><a href=/post/old/2020/01/do-not-trust-user-input-enforce-whitelists-narrow-allowable-input/><span class=screen-reader-text>Next post: </span>Do not trust user input<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>