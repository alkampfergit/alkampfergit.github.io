<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Previous post on the series
 Versioning assembly during TFS 2013 build with Powershell Scripts  Using powershell to cusotmize build is simple and easy, once you have versioning in place (previous article), if you are realizing some form of reusable library it is time to think on how to distribute it to people. One of the obvious choice is using Nuget. Luckily enough, setting up a nuget server in an azure website is just a matter of"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Automatically build and publish nuget packages during TFS Build • Codewrecks"><meta property="og:description" content="Previous post on the series
 Versioning assembly during TFS 2013 build with Powershell Scripts  Using powershell to cusotmize build is simple and easy, once you have versioning in place (previous article), if you are realizing some form of reusable library it is time to think on how to distribute it to people. One of the obvious choice is using Nuget. Luckily enough, setting up a nuget server in an azure website is just a matter of"><meta property="og:url" content="https://www.codewrecks.com/post/old/2014/02/automatically-build-and-publish-nuget-packages-during-tfs-build/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="TfsBuild"><meta property="article:published_time" content="2014-02-01T11:00:37+02:00"><meta property="article:modified_time" content="2014-02-01T11:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Automatically build and publish nuget packages during TFS Build • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2014/02/automatically-build-and-publish-nuget-packages-during-tfs-build/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Automatically build and publish nuget packages during TFS Build</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Automatically build and publish nuget packages during TFS Build</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2014-02-01T11:00:37+02:00>2014, Feb 01</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>8 mins read</span></div></div></header><div class="container entry-content"><p>Previous post on the series</p><ul><li><a href=http://www.codewrecks.com/blog/index.php/2014/01/11/customize-tfs-2013-build-with-powershell-scripts/>Versioning assembly during TFS 2013 build with Powershell Scripts</a></li></ul><p>Using powershell to cusotmize build is simple and easy, once you have versioning in place (previous article), if you are realizing some form of reusable library it is time to <strong>think on how to distribute it to people. One of the obvious choice is using Nuget.</strong> Luckily enough, setting up a nuget server in an azure website is just a matter of</p><ol><li>Create an empty asp.net MVC project</li><li>Reference standard Nuget Server package</li><li>Change web config and add a password for publishing</li><li>Publish on an azure web sites.</li></ol><p>Et voila, you have your Nuget server up and running in really no-time on an azure web site, it is simple and quick to setup.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image3.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb3.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb3.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Nuget server running on Windows Azure Web Site</em></p><p>Now you only need to create a <strong>simple powershell file to enable automatic publishing of your libraries during TFS Build</strong>. This is really easy, first of all I started including a standard nuspec file inside the library I want to publish. This.nuspec file will contains all the details of the package and the script will only need to change the number, create nuget package and finally publish the package into your nuget server.</p><p>Here is a simple.nuspect file for a test project of a log library.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span style=color:#f92672>&lt;package</span> <span style=color:#f92672>&gt;</span>
  <span style=color:#f92672>&lt;metadata&gt;</span>
    <span style=color:#f92672>&lt;id&gt;</span>LogLibrary<span style=color:#f92672>&lt;/id&gt;</span>
    <span style=color:#f92672>&lt;version&gt;</span>1.0.0.0<span style=color:#f92672>&lt;/version&gt;</span>
    <span style=color:#f92672>&lt;authors&gt;</span>Ricci Gian Maria<span style=color:#f92672>&lt;/authors&gt;</span>
    <span style=color:#f92672>&lt;owners&gt;</span>Ricci Gian Maria<span style=color:#f92672>&lt;/owners&gt;</span>
    <span style=color:#f92672>&lt;requireLicenseAcceptance&gt;</span>false<span style=color:#f92672>&lt;/requireLicenseAcceptance&gt;</span>
    <span style=color:#f92672>&lt;description&gt;</span>Simple log library project to verify build+nuget.<span style=color:#f92672>&lt;/description&gt;</span>
    <span style=color:#f92672>&lt;releaseNotes&gt;</span>ContinuousIntegration.<span style=color:#f92672>&lt;/releaseNotes&gt;</span>
    <span style=color:#f92672>&lt;copyright&gt;</span>Copyright 2014 - Ricci Gian Maria<span style=color:#f92672>&lt;/copyright&gt;</span>
    <span style=color:#f92672>&lt;tags&gt;</span>Example<span style=color:#f92672>&lt;/tags&gt;</span>
  <span style=color:#f92672>&lt;/metadata&gt;</span>

  <span style=color:#f92672>&lt;files&gt;</span>
    <span style=color:#f92672>&lt;file</span> <span style=color:#a6e22e>src=</span><span style=color:#e6db74>&#34;LogLibrary.dll&#34;</span> <span style=color:#a6e22e>target=</span><span style=color:#e6db74>&#34;lib\NET40&#34;</span> <span style=color:#f92672>/&gt;</span>
    <span style=color:#f92672>&lt;file</span> <span style=color:#a6e22e>src=</span><span style=color:#e6db74>&#34;LogLibrary.pdb&#34;</span> <span style=color:#a6e22e>target=</span><span style=color:#e6db74>&#34;lib\NET40&#34;</span> <span style=color:#f92672>/&gt;</span>
  <span style=color:#f92672>&lt;/files&gt;</span>
<span style=color:#f92672>&lt;/package&gt;</span></code></pre></td></tr></table></div></div><p>As you can verify it is a standard nuspec file and my goal is creating a powershell script that</p><ol><li><ul><li><strong>Change version including build number and day in format YYDDD where DDD is the number of day of the year</strong> *</li></ul></li><li><ul><li><strong>Execute nuget to create pack file and publish to my server</strong> *</li></ul></li></ol><p>The very first step is including nuget.exe inside my BuildScript folder and check-in everything. This will assure me that everything is needed for the build is contained in source control.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image4.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb4.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb4.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Content of the BuildScript folder</em></p><p>Now the interesting part, the powershell function that does the real work.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">97
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#66d9ef>function</span> Publish-NugetPackage
{
  <span style=color:#66d9ef>Param</span> 
  (
    <span style=color:#66d9ef>[string]</span>$SrcPath,
    <span style=color:#66d9ef>[string]</span>$NugetPath,
    <span style=color:#66d9ef>[string]</span>$PackageVersion, 
    <span style=color:#66d9ef>[string]</span>$NugetServer,
    <span style=color:#66d9ef>[string]</span>$NugetServerPassword
  )
    $buildNumber = $env:TF_BUILD_BUILDNUMBER
    <span style=color:#66d9ef>if</span> ($buildNumber <span style=color:#f92672>-eq</span> $null)
    {
        $buildIncrementalNumber = 0
    }
    <span style=color:#66d9ef>else</span>
    {
        $splitted = $buildNumber.Split(<span style=color:#e6db74>&#39;.&#39;</span>)
        $buildIncrementalNumber = $splitted[$splitted.Length - 1]
    }
    Write-Host <span style=color:#e6db74>&#34;Executing Publish-NugetPackage in path $SrcPath, PackageVersion is $PackageVersion&#34;</span>
    $jdate = Get-JulianDate
    $PackageVersion = $PackageVersion.Replace(<span style=color:#e6db74>&#34;J&#34;</span>, $jdate).Replace(<span style=color:#e6db74>&#34;B&#34;</span>, $buildIncrementalNumber)
    Write-Host <span style=color:#e6db74>&#34;Transformed PackageVersion is $PackageVersion &#34;</span>
    $AllNuspecFiles = Get-ChildItem $SrcPath\*.nuspec
    <span style=color:#75715e>#Remove all previous packed packages in the directory</span>
    $AllNugetPackageFiles = Get-ChildItem $SrcPath\*.nupkg
    <span style=color:#66d9ef>foreach</span> ($file <span style=color:#66d9ef>in</span> $AllNugetPackageFiles)
    { 
        Remove-Item $file
    }

    <span style=color:#66d9ef>foreach</span> ($file <span style=color:#66d9ef>in</span> $AllNuspecFiles)
    { 
        Write-Host <span style=color:#e6db74>&#34;Modifying file &#34;</span> + $file.FullName
        <span style=color:#75715e>#save the file for restore</span>
        $backFile = $file.FullName + <span style=color:#e6db74>&#34;._ORI&#34;</span>
        $tempFile = $file.FullName + <span style=color:#e6db74>&#34;.tmp&#34;</span>
        Copy-Item $file.FullName $backFile -Force
        <span style=color:#75715e>#now load all content of the original file and rewrite modified to the same file</span>
        Get-Content $file.FullName |
        %{$_ <span style=color:#f92672>-replace</span> <span style=color:#e6db74>&#39;&lt;version&gt;[0-9]+(\.([0-9]+|\*)){1,3}&lt;/version&gt;&#39;</span>, <span style=color:#e6db74>&#34;&lt;version&gt;$PackageVersion&lt;/version&gt;&#34;</span> } &gt; $tempFile
        Move-Item $tempFile $file.FullName -force

        <span style=color:#75715e>#Create the.nupkg from the nuspec file</span>
        $ps = new-object System.Diagnostics.<span style=color:#66d9ef>Process</span>
        $ps.StartInfo.Filename = <span style=color:#e6db74>&#34;$NugetPath\nuget.exe&#34;</span>
        $ps.StartInfo.Arguments = <span style=color:#e6db74>&#34;pack </span><span style=color:#ae81ff>`&#34;</span><span style=color:#e6db74>$file</span><span style=color:#ae81ff>`&#34;</span><span style=color:#e6db74>&#34;</span>
        $ps.StartInfo.WorkingDirectory = $file.Directory.FullName
        $ps.StartInfo.RedirectStandardOutput = $True
        $ps.StartInfo.RedirectStandardError = $True
        $ps.StartInfo.UseShellExecute = $false
        $ps.start()
        <span style=color:#66d9ef>if</span>(!$ps.WaitForExit(30000)) 
        {
            $ps.Kill()
        }
        <span style=color:#66d9ef>[string]</span> $Out = $ps.StandardOutput.ReadToEnd();
        <span style=color:#66d9ef>[string]</span> $ErrOut = $ps.StandardError.ReadToEnd();
        Write-Host <span style=color:#e6db74>&#34;Nuget pack Output of commandline &#34;</span> + $ps.StartInfo.Filename + <span style=color:#e6db74>&#34; &#34;</span> + $ps.StartInfo.Arguments
        Write-Host $Out
        <span style=color:#66d9ef>if</span> ($ErrOut <span style=color:#f92672>-ne</span> <span style=color:#e6db74>&#34;&#34;</span>) 
        {
            Write-Error <span style=color:#e6db74>&#34;Nuget pack Errors&#34;</span>
            Write-Error $ErrOut
        }
        <span style=color:#75715e>#Restore original file</span>
        <span style=color:#75715e>#Move-Item $backFile $file -Force</span>
    }
    $AllNugetPackageFiles = Get-ChildItem $SrcPath\*.nupkg
    <span style=color:#66d9ef>foreach</span> ($file <span style=color:#66d9ef>in</span> $AllNugetPackageFiles)
    { 
        <span style=color:#75715e>#Create the.nupkg from the nuspec file</span>
        $ps = new-object System.Diagnostics.<span style=color:#66d9ef>Process</span>
        $ps.StartInfo.Filename = <span style=color:#e6db74>&#34;$NugetPath\nuget.exe&#34;</span>
        $ps.StartInfo.Arguments = <span style=color:#e6db74>&#34;push </span><span style=color:#ae81ff>`&#34;</span><span style=color:#e6db74>$file</span><span style=color:#ae81ff>`&#34;</span><span style=color:#e6db74> -s $NugetServer $NugetServerPassword&#34;</span>
        $ps.StartInfo.WorkingDirectory = $file.Directory.FullName
        $ps.StartInfo.RedirectStandardOutput = $True
        $ps.StartInfo.RedirectStandardError = $True
        $ps.StartInfo.UseShellExecute = $false
        $ps.start()
        <span style=color:#66d9ef>if</span>(!$ps.WaitForExit(30000)) 
        {
            $ps.Kill()
        }
        <span style=color:#66d9ef>[string]</span> $Out = $ps.StandardOutput.ReadToEnd();
        <span style=color:#66d9ef>[string]</span> $ErrOut = $ps.StandardError.ReadToEnd();
        Write-Host <span style=color:#e6db74>&#34;Nuget push Output of commandline &#34;</span> + $ps.StartInfo.Filename + <span style=color:#e6db74>&#34; &#34;</span> + $ps.StartInfo.Arguments
        Write-Host $Out
        <span style=color:#66d9ef>if</span> ($ErrOut <span style=color:#f92672>-ne</span> <span style=color:#e6db74>&#34;&#34;</span>) 
        {
            Write-Error <span style=color:#e6db74>&#34;Nuget push Errors&#34;</span>
            Write-Error $ErrOut
        }

    }
}</code></pre></td></tr></table></div></div><p>My standard disclaimer is: I’m not a powershell expert, so I think that probably there are gazillions of way to do a better powershell script. The function is really simple, <strong>first of all it starts doing some standard transformation of the package number (as in previous article), then it starts enumerating all.nuspec files present in bin directory of the build</strong>. <strong>For each nuspec file, it simply do a backup, then change the version number using a simple regex, finally it invoke the nuget.exe process to create the pack file</strong>. To launch an external process and have full control on the output I decided to use (since I’m a.NET programmer) the System.Diagnostic.Process class, that permits me to intercept all standard output and standard error.</p><p>After the process ends I use write-host and write-error to dump all the output to the host (it would be a better approach parsing the output and generate a better error message). <strong>Finally I invoke again nuget.exe to publish the package to my server.</strong> Once this function is in place, you can invoke with a simple script that will be scheduled to be executed AfterBuild.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#66d9ef>Param</span>
(
<span style=color:#66d9ef>[string]</span> $PackageVersion = <span style=color:#e6db74>&#34;1.0.J.B&#34;</span>,
<span style=color:#66d9ef>[string]</span> $NugetServer = <span style=color:#e6db74>&#34;http://alkampfernuget.azurewebsites.net/&#34;</span>,
<span style=color:#66d9ef>[string]</span> $NugetServerPassword = <span style=color:#e6db74>&#34;This_is_my_password&#34;</span>
)

Write-Host <span style=color:#e6db74>&#34;Running Pre Build Scripts&#34;</span>

$scriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition
Import-Module $scriptRoot\BuildFunctions

Publish-NugetPackage $scriptRoot\..\..\bin $scriptRoot $PackageVersion $NugetServer $NugetServerPassword</code></pre></td></tr></table></div></div><p>It is based mainly by convention, the script root is the folder where the script is, and the build is configured with this workspace.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image5.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb5.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb5.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Workspace configuration</em></p><p>The above relative path maps all ScriptTest folder inside the $(SourceDir) of the agent, the script is in the BuildTools directory, so I need to get the parent folder to locate the root of the workspace and another .. to find the build base directory that contains the bin folder, where the build copy all the output. An even better situation would be using TF_BUILD_BINARIESDIRECTORY environment variable, that automatically locates that folder, but that variable is populated only during a build. If you plan to use the script only inside a TFS Build, you can safely use TF_BUILD_BINARIESDIRECTORY variable. Here is a modified example that does this</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#66d9ef>Param</span>
(
<span style=color:#66d9ef>[string]</span> $PackageVersion = <span style=color:#e6db74>&#34;1.0.J.B&#34;</span>,
<span style=color:#66d9ef>[string]</span> $NugetServer = <span style=color:#e6db74>&#34;http://alkampfernuget.azurewebsites.net/&#34;</span>,
<span style=color:#66d9ef>[string]</span> $NugetServerPassword = <span style=color:#e6db74>&#34;This_is_my_password&#34;</span>
)

Write-Host <span style=color:#e6db74>&#34;Running Pre Build Scripts&#34;</span>
$scriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition

<span style=color:#75715e>#Remove-Module BuildFunctions</span>
Import-Module $scriptRoot\BuildFunctions

$binPath = $env:TF_BUILD_BINARIESDIRECTORY
<span style=color:#66d9ef>if</span> ($binPath <span style=color:#f92672>-eq</span> $null)
{Write-Host <span style=color:#e6db74>&#34;Not running in build, using relative path to identify bin location.&#34;</span>
    $binPath = $scriptRoot + <span style=color:#e6db74>&#34;\..\..\bin&#34;</span>
}

Publish-NugetPackage $env:TF_BUILD_BINARIESDIRECTORY $scriptRoot $PackageVersion $NugetServer $NugetServerPassword</code></pre></td></tr></table></div></div><p>The above script does nothing except importing the module with the publishing function and invoke the Publish-NugetPackage function.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image6.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb6.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb6.png alt=image></a></a></p><p><em><strong>Figure 4</strong></em>: <em>Invoke the script after build</em></p><p>Now everything is setup correctly, just fire a build and verify that everything is done correctly looking at write-host messages that gets collected in the detailed log of the build. Thanks to log files, you can output as much information you want to diagnose problem that can arise during the build.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image7.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb7.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb7.png alt=image></a></a></p><p><strong>figure 5:</strong> <em>Verify output of powershell scriptin diagnostic build informations.</em></p><p>If the script contains some errors, powershell will write error with write-error and this information will make the build partially fails and also all the errors will be output in build details, but not in a real nice form. Since I’ve intercepted all nuget.exe error output and dump with Write-Error, a nuget.exe error message will make the build Partially Fails and you can looks at errors list to understand what happened.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image8.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb8.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb8.png alt=image></a></a></p><p><em><strong>Figure 6</strong></em>: <em>How errors in powershell are displayed in build output</em></p><p>This has <strong>not a nice formatting, because each error line is treated as a single and distinct error in the build</strong>. But at least we are able to identify the root cause of the error, even if they are not really well formatted. When the build is green you will find your packages in the feed of your nuget server.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image9.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb9.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb9.png alt=image></a></a></p><p><em><strong>Figure 7</strong></em>: <em>Feed of my packages pushed during the build.</em></p><p>Each good build will produce a unique version for your package, as you can verify from package console.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image10.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb10.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb10.png alt=image></a></a></p><p><em><strong>Figure 8</strong></em>: <em>Listing available packages in Package Manager Console.</em></p><p>With few lines of powershell you are able to automatically publish your packages to nuget server during TFS Build.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/team-foundation-server/>Team Foundation Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/tfsbuild/>TfsBuild</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2014/02/samsung-evo-840-500gb-vs-ocz-vertex-4-256gb/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Samsung EVO 840 500GB VS OCZ Vertex 4 256GB</a></div><div class="next-entry sep-before"><a href=/post/old/2014/02/moving-between-different-vcs-to-team-foundation-server/><span class=screen-reader-text>Next post: </span>Moving between different VCS to Team Foundation Server<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>