<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I’ve done some blog post on customizing TFS Build with PowerShell scripts and the very first question I got from this approach is
 How can I store some PowerShell modules “somewhere” and have them available for all Build Agents?
 This is a real good question, but sadly enough it has no out-of-the-box answer. Luckily enough you can solve this with a little bit of PowerShell knowledge. Please be aware that this solution is based on some assumption on how TFS build actually works and is not guaranteed to be stable in the future , but I’d like to share with you all if you want to try into your environment."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Automatically Deploy PowerShell modules to Build Agents in TFS • Codewrecks"><meta property="og:description" content="I’ve done some blog post on customizing TFS Build with PowerShell scripts and the very first question I got from this approach is
 How can I store some PowerShell modules “somewhere” and have them available for all Build Agents?
 This is a real good question, but sadly enough it has no out-of-the-box answer. Luckily enough you can solve this with a little bit of PowerShell knowledge. Please be aware that this solution is based on some assumption on how TFS build actually works and is not guaranteed to be stable in the future , but I’d like to share with you all if you want to try into your environment."><meta property="og:url" content="https://www.codewrecks.com/post/old/2014/02/automatically-deploy-powershell-modules-to-build-agents-in-tfs/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="TFS Build"><meta property="article:published_time" content="2014-02-21T08:00:37+02:00"><meta property="article:modified_time" content="2014-02-21T08:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Automatically Deploy PowerShell modules to Build Agents in TFS • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/old/2014/02/automatically-deploy-powershell-modules-to-build-agents-in-tfs/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Automatically Deploy PowerShell modules to Build Agents in TFS</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Automatically Deploy PowerShell modules to Build Agents in TFS</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2014-02-21T08:00:37+02:00>2014, Feb 21</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>4 mins read</span></div></div></header><div class="container entry-content"><p>I’ve done some blog post on customizing TFS Build with PowerShell scripts and the very first question I got from this approach is</p><blockquote><p>How can I store some PowerShell modules “somewhere” and have them available for all Build Agents?</p></blockquote><p>This is a real good question, but sadly enough it has no out-of-the-box answer. Luckily enough you can solve this with a little bit of PowerShell knowledge. Please be aware <strong>that this solution is based on some assumption on how TFS build actually works and is not guaranteed to be stable in the future</strong> , but I’d like to share with you all if you want to try into your environment.</p><p>TFS Build controllers have a special Source Control Folder you can specify to store assemblies that should be available for Agents during the build.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image24.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb24.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb24.png alt=image></a></a></p><p><em><strong>Figure 1</strong></em>: <em>Version control path to custom assemblies for Build Controllers</em></p><p>The very first step is creating a subfolder where you store all PowerShell modules you want to be available to Build Agents during a build.</p><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image25.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb25.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb25.png alt=image></a></a></p><p><em><strong>Figure 2</strong></em>: <em>Store your PowerShell Modules inside a specific folder of the Path to custom assemblies</em></p><p><em>This special folder is downloaded for every agent during a build and it is stored inside a specific subfolder of the temp folder of the user configured to run build agents</em>. Once all modules are committed, it is just a matter of writing a bunch of PowerShell lines of code to identify the directory where that modules are downloaded during the build, and then copy all modules inside one of the default location supported by the PowerShell engine.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>Write-Host <span style=color:#e6db74>&#34;TempDirectoryIs&#34;</span>$env:Temp

$scriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition

$scriptRoot <span style=color:#f92672>-Match</span> <span style=color:#e6db74>&#34;\d+&#34;</span>
$agentNumber = $Matches[0]
Write-Host <span style=color:#e6db74>&#34;Build Agent Number is&#34;</span>$agentNumber

Write-Host <span style=color:#e6db74>&#34;PSModulePath = &#34;</span>$env:PSModulePath
$userModuleLocation = $env:PSModulePath.Split(<span style=color:#e6db74>&#39;;&#39;</span>) | where {$_.Contains(<span style=color:#e6db74>&#39;Documents&#39;</span>)}
Write-Host <span style=color:#e6db74>&#34;User Powershell Module location is: &#34;</span>$userModuleLocation

$tempBuildDirectory = $env:Temp + <span style=color:#e6db74>&#34;\BuildAgent\&#34;</span> + $agentNumber + <span style=color:#e6db74>&#34;\Assemblies\&#34;</span>
Write-Host <span style=color:#e6db74>&#34;Location of custom assembly: &#34;</span>$tempBuildDirectory
Copy-Item -Path $tempBuildDirectory<span style=color:#e6db74>&#34;PowershellModules\&#34;</span> -Destination $userModuleLocation -Recurse</code></pre></td></tr></table></div></div><p>Let me explain how this works. First of all I need to know the location of the temp directory, stored in Environment variables $env:temp. When the build runs this variable is something like: * <strong>C:\Windows\SERVIC~2\LOCALS~1\AppData\Local\Temp</strong> *. This is not the real directory where the agent downloads the content of the custom assembly folder, because each agent creates a specific subdirectory, based on its id Es: *C:\Windows\ServiceProfiles\LocalService\AppData\Local\Temp\ <strong>BuildAgent&lt;font color=&rdquo;#ff0000">290\Assemblies</strong> *</p><p>Agent’s id is also used to create a separate local build folder for each agent, the first step is to store folder location where the executing script is located in variable $scriptRoot. The value is something like: <em>C:\Builds\ <strong>290</strong> \Experiments\Simple Powershell Versioning\src\BuildScripts</em>. As you can see, <strong>id of the Agent is the first number that appears in folder structure, and extracting it with a simple regex is really straightforward</strong>.</p><p>Final step is locating all the paths where PowerShell is actually searching for modules. All locations are stored inside the Environment variable $env:PSModulePath, containing a semicolon separated list of default folders for modules. The script cannot write to all of these folders because some of them are stored in path of disk that requires elevated permission (Es: C:\ProgramFiles). <strong>Usually one of them is located under Document folder of the current user:</strong> ??* **%UserProfile%\Documents\WindowsPowerShell\Modules** ,*and since it is in user folder build agent can write on it without problem. ** ** Thanks to this knowledge I’ve decided to split the path to find the one that contains the path Documents. I know that this can be a fragile assumption, but it usually works.</p><p>The last step is determine $tempBuildDirectory combining temp folder with agent id and finally use a Copy-Item cmdlets to copy all custom PowerShell modules inside the supported module location under agent user directory.</p><p>I did not use this strategy really often because it can be fragile. <strong>If you are using TFVC the best solution usually is</strong> - <em>Add the custom powershell modules directory to the workflow mapping of the build</em></p><ul><li><em>use the Import-Module PowerShell command to import modules from a fixed location</em></li></ul><p><a href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image26.png><a target=_blank href=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb26.png><img src=https://www.codewrecks.com/blog/wp-content/uploads/2014/02/image_thumb26.png alt=image></a></a></p><p><em><strong>Figure 3</strong></em>: <em>Download your custom PowerShell modules in a know location as part of the build workspace.</em></p><p>since I’ve stored build scripts inside $Experiments/trunk/Builds/ScriptTest/BuildScripts folder, I can use relative path to find location of PowershellModules on disk and import modules from specific locations. Sadly enough this solution does not works with Git repository and copying the modules with the above technique can be a viable solution.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/team-foundation-server/>Team Foundation Server</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/powershell/>PowerShell</a>, <a class=tag href=/tags/tfs-build/>TFS Build</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/old/2014/02/error-in-asyncprocessmessage-during-deploy-phase-of-a-tfs-lab-management-build/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Error in AsyncProcessMessage during deploy phase of a TFS Lab Management Build</a></div><div class="next-entry sep-before"><a href=/post/old/2014/02/tfs-build-fails-with-database-projects/><span class=screen-reader-text>Next post: </span>Tfs build fails with Database Projects<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>