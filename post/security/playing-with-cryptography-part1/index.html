<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some though about cryptography and .NET"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Playing with Cryptography, Part 1 • Codewrecks"><meta property="og:description" content="Some though about cryptography and .NET"><meta property="og:url" content="https://www.codewrecks.com/post/security/playing-with-cryptography-part1/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="security"><meta property="article:tag" content="programming"><meta property="article:published_time" content="2021-07-17T09:13:30+02:00"><meta property="article:modified_time" content="2021-07-17T09:13:30+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Playing with Cryptography, Part 1 • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/security/playing-with-cryptography-part1/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Playing with Cryptography, Part 1</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Playing with Cryptography, Part 1</h1><p class=desc>Some though about cryptography and .NET</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2021-07-17T09:13:30+02:00>2021, Jul 17</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>7 mins read</span></div></div></header><div class="container entry-content"><p>Cryptography is a fascinating subject, surely complex, but as a developer you probably have some <strong>predefined libraries in your language/environment of choice that you can use</strong>. DotNet is not an exception, so I&rsquo;ve decided to create a sample repository to play a little bit with all cryptography primitives to show how easy is to use them <a href=https://github.com/alkampfergit/DotNetCoreCryptography>https://github.com/alkampfergit/DotNetCoreCryptography</a>.</p><p>This is not a tutorial, it is more a repository where I played with API to gain more confidence with <strong>.Net Core version of the API</strong>. The purpose is also to understand if you can <strong>wrap Crypto API to make them simple to use for a developer, avoiding people to use them in different ways across a same software and to make them simpler to use</strong>.</p><blockquote><p>This is not a tutorial, is some experiments I&rsquo;ve done with Cryptography in .NET feel free to fork and made criticism, suggestions and point out any error you spot in the code.</p></blockquote><p>First of all I&rsquo;d like to abstract the real algorithm used to simplify migration to a different one if it will break in the future. I do not think that 256 bit AES will be broke in the near future, but 128 bit key could be made weak by <a href="https://www.amazon.com/Cryptography-Apocalypse-Preparing-Quantum-Computing/dp/1119618193/ref=sr_1_1?dchild=1&keywords=quantum+apocalypse+cryptography&qid=1626513865&sr=8-1">Quantum Computing</a> so I <strong>prefer an approach where I wrap the real key/algorithm in a custom class</strong>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EncryptionKey</span> : IDisposable
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> EncryptionKey CreateDefault()
    {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AesEncryptionKey();
    }
</code></pre></td></tr></table></div></div><p>Here we have a simple EncryptionKey class that wraps some symmetric key, and will create an AesEncryptionKey as default key (actually it is the only one in the code :) ). <strong>Base class allows me to specify a series of behavior that I&rsquo;m expecting for a symmetric key</strong>, this allows me to swap a real implementation with another one if I decide to change it.</p><p>When I have a key, one of the problem is <strong>where to securely store it</strong>, so I&rsquo;d like all my concrete keys implementations to be able to serialize the key to a simple byte array and deserialize it from there.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e>/// Serialize an AES key into a byte array
</span><span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e>/// &lt;param name=&#34;aes&#34;&gt;&lt;/param&gt;
</span><span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>byte</span>[] Serialize(<span style=color:#66d9ef>this</span> Aes aes)
{
    <span style=color:#66d9ef>var</span> array = <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span>[
        aes.KeySize / <span style=color:#ae81ff>8</span>     <span style=color:#75715e>//Key size
</span><span style=color:#75715e></span>        + <span style=color:#ae81ff>16</span>                <span style=color:#75715e>//IV size
</span><span style=color:#75715e></span>        + <span style=color:#ae81ff>1</span>                 <span style=color:#75715e>//mode of operation
</span><span style=color:#75715e></span>        + <span style=color:#ae81ff>1</span>                 <span style=color:#75715e>//first byte mark
</span><span style=color:#75715e></span>    ];
    array[<span style=color:#ae81ff>0</span>] = (<span style=color:#66d9ef>byte</span>) KeyType.Aes256;
    Array.Copy(aes.IV, <span style=color:#ae81ff>0</span>, array, <span style=color:#ae81ff>1</span>, aes.IV.Length);
    Array.Copy(aes.Key, <span style=color:#ae81ff>0</span>, array, <span style=color:#ae81ff>16</span> + <span style=color:#ae81ff>1</span>, aes.Key.Length);
    array[array.Length - <span style=color:#ae81ff>1</span>] = (<span style=color:#66d9ef>byte</span>) aes.Mode;
    <span style=color:#66d9ef>return</span> array;
}

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Aes DeserializeToAes(<span style=color:#66d9ef>this</span> <span style=color:#66d9ef>byte</span>[] serializedAes)
{
    <span style=color:#66d9ef>if</span> (serializedAes[<span style=color:#ae81ff>0</span>] != (<span style=color:#66d9ef>byte</span>) KeyType.Aes256) 
    {
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> CryptographicException(<span style=color:#e6db74>&#34;Serialized key is not AES&#34;</span>);
    }
    <span style=color:#66d9ef>var</span> aes = Aes.Create();
    <span style=color:#66d9ef>var</span> keyLength = serializedAes.Length - <span style=color:#ae81ff>16</span> - <span style=color:#ae81ff>1</span> - <span style=color:#ae81ff>1</span>;
    aes.IV = <span style=color:#66d9ef>new</span> ArraySegment&lt;<span style=color:#66d9ef>byte</span>&gt;(serializedAes, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>16</span>).ToArray();
    aes.Key = <span style=color:#66d9ef>new</span> ArraySegment&lt;<span style=color:#66d9ef>byte</span>&gt;(serializedAes, <span style=color:#ae81ff>17</span>, keyLength).ToArray();
    aes.Mode = (CipherMode)serializedAes[serializedAes.Length - <span style=color:#ae81ff>1</span>];
    <span style=color:#66d9ef>return</span> aes;
}
</code></pre></td></tr></table></div></div><p>I prefer to do this operation myself, because I use the first byte <strong>to mark the type of key I&rsquo;m using, thus providing me the ability to mix different algorithms without any risk of breaking the code</strong>. Thanks to this way of serializing stuff, it is simple to create a generic method in base class to retrieve the correct key from serialized version.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e>/// Create correct type of key based on serialied version.
</span><span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e>/// &lt;param name=&#34;serializedKey&#34;&gt;&lt;/param&gt;
</span><span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> EncryptionKey CreateFromSerializedVersion(<span style=color:#66d9ef>byte</span>[] serializedKey)
{
    <span style=color:#66d9ef>var</span> keyType = (KeyType)serializedKey[<span style=color:#ae81ff>0</span>];
    <span style=color:#66d9ef>switch</span> (keyType)
    {
        <span style=color:#66d9ef>case</span> KeyType.Aes256:
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AesEncryptionKey(serializedKey);
        <span style=color:#66d9ef>default</span>:
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#e6db74>$&#34;Type of key {keyType} is not supported&#34;</span>);
    }
}
</code></pre></td></tr></table></div></div><p>This gave me the ability to convert potentially different type of keys into a byte array and be able to deserialize them back into the correct class. EncryptionKey base class is able to read the first byte and restore the correct version of the key based on it. If <strong>I&rsquo;ll need to change the algorithm I can create another concrete implementation of EncryptionKey and use a different first byte to identify it</strong>.</p><p><strong>Once I have this ability my next question is how to store the key safely somewhere</strong>. To achieve this result I can create a simple interface called IKeyEncryptor. I&rsquo;m not pretty sure of the name, but the concept is that <strong>I can encrypt the key and decrypt with the help of another object that is supposed to be secure</strong>. I started with a concept of IKeyVault, a place where I can safely store keys, but actually I&rsquo;d like to explore a different strategy, once a key is encrypted it is supposed to be secure and you <strong>can store the encrypted version everywhere, because it cannot be decrypted with the original IKeyEncryptor used to encrypt it</strong>. This makes me think that I do not really need a Vault, a <strong>place where the key is stored</strong>, what I really need is some object that is capable to encrypt my key so I can store it anywhere.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> IKeyEncryptor
{
    <span style=color:#66d9ef>public</span> Task&lt;<span style=color:#66d9ef>byte</span>[]&gt; EncryptAsync(EncryptionKey key);

    <span style=color:#66d9ef>public</span> Task&lt;EncryptionKey&gt; DecriptAsync(<span style=color:#66d9ef>byte</span>[] encryptedKey);
}
</code></pre></td></tr></table></div></div><p>This approach gives me the ability to create a super simple <strong>helper class that to encrypt stream of bytes that is extremely simple to use.</strong>. It is called SecureEncryptor and has only two super simple methods.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecureEncryptor</span>
{
    <span style=color:#66d9ef>public</span> SecureEncryptor(IKeyEncryptor keyVaultStore)
    {
        _keyVaultStore = keyVaultStore;
    }

    ...
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Encrypt(Stream streamToEncrypt, Stream destinationStream)
    ...

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Decrypt(Stream sourceEncryptedStream, Stream destinationDecryptedStream)
    ...
}
</code></pre></td></tr></table></div></div><p>This interface is super simple to use, <strong>just specify source and destination Stream for encrypt and decrypt, you do not need anything else</strong>. This kind of approach leaves no decision to the user on what algorithm to use or how to manage keys, the user does not even know where the key are stored. <strong>This kind of interface is nice because leaves all complexity and risky code in just one place, the SecureEncryptor class</strong>.</p><p>If you look at SecureEncryptor class you can find that it <strong>relies on the IKeyEncryptor class to encrypt keys.</strong> This approach concentrates most of the risk into the concrete implementation of IKeyEncryptor, if you have an implementation that is super secure, you cannot decrypt keys encrypted with it and all the rest of the code is supposed to be more secure. <strong>The less decision you leave to the user of your class, the better</strong>.</p><p>This class internally encrypt stuff with a super simple approach: it generates a new key each time you encrypt a stream, <strong>then encrypt the encryption key with the help of IKeyEncryptor, and store the encrypted version of the key at the start of the encrypted stream</strong>, finally it uses the key to encrypt the original stream to the destination stream. This approach will produce a <strong>single destination encrypted stream</strong> that contains the encrypted version of the key used to encrypt the rest of the stream. To decrypt the stream you first retrieve the encrypted key from the stream, then decrypt with IKeyEncryptor, then use the decrypted key to decrypt the rest of the stream.</p><p>Here you have a simple test that shows how you can use the class.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#a6e22e>[Fact]</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Full_secure_encryption_test()
{
    <span style=color:#66d9ef>var</span> sut = CreateSut();
    <span style=color:#66d9ef>using</span> var streamToEncrypt = GenerateStreamToEncrypt();

    <span style=color:#75715e>//ok now we need to secure encrypt and decrypt the stream
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>using</span> var destinationStream = <span style=color:#66d9ef>new</span> MemoryStream();
    <span style=color:#66d9ef>await</span> sut.Encrypt(streamToEncrypt, destinationStream);

    <span style=color:#75715e>//now we want to read again and decrypt
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>using</span> var sourceEncryptedStream = <span style=color:#66d9ef>new</span> MemoryStream(destinationStream.ToArray());
    <span style=color:#66d9ef>using</span> var destinationDecryptedStream = <span style=color:#66d9ef>new</span> MemoryStream();
    <span style=color:#66d9ef>await</span> sut.Decrypt(sourceEncryptedStream, destinationDecryptedStream);
    <span style=color:#66d9ef>var</span> decryptedContent = Encoding.UTF8.GetString(destinationDecryptedStream.ToArray());
    Assert.Equal(decryptedContent, someContenttoBeEncrypted);
}
</code></pre></td></tr></table></div></div><p>I&rsquo;ll deal with the implementation of IKeyEncryptor in a subsequent post.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/security/>security</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/security/>security</a>, <a class=tag href=/tags/programming/>Programming</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/github/github-sonarcloud-codecoverage/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Code coverage in SonarCloud and GitHub Actions</a></div><div class="next-entry sep-before"><a href=/post/security/github-security-scanning/><span class=screen-reader-text>Next post: </span>GitHub security scan - an example<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>