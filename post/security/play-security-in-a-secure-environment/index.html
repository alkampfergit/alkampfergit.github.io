<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When you experiment with security, it is useful to have a safe environment isolated from your production machines."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Play security in a secure environment • Codewrecks"><meta property="og:description" content="When you experiment with security, it is useful to have a safe environment isolated from your production machines."><meta property="og:url" content="https://www.codewrecks.com/post/security/play-security-in-a-secure-environment/"><meta property="og:site_name" content="Codewrecks"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:tag" content="security"><meta property="article:published_time" content="2020-05-23T10:00:37+02:00"><meta property="article:modified_time" content="2020-05-23T10:00:37+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>Play security in a secure environment • Codewrecks</title><link rel=canonical href=https://www.codewrecks.com/post/security/play-security-in-a-secure-environment/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ffcd00}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1773115-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://www.codewrecks.com/js/jquery-eu-cookie-law-popup.js></script><link rel=stylesheet href=https://www.codewrecks.com/css/jquery-eu-cookie-law-popup.css></head><body class="page type-post"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/categories/>Categories</a></li><li class=item><a href=/about/>About</a></li><li class=item><a href=/privacy/>Privacy</a></li></ul></div></nav><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><span>Play security in a secure environment</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Codewrecks</p><p class="desc site-desc">Wrecks of code floating in the sea of internet</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Play security in a secure environment</h1><p class=desc>When you experiment with security, it is useful to have a safe environment isolated from your production machines.</p></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-05-23T10:00:37+02:00>2020, May 23</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>6 mins read</span></div></div></header><div class="container entry-content"><p><strong>Security is one of my long passions</strong>, I’ve spent lots of time on C++ and Assembly (both x86 and other architectures) and in that environment I&rsquo;ve started exploring buffer overflow and other vulnerabilities. Over the course of years security remained only a passion and not my primary skill, but I spent constantly a little amount of time on it through the years.</p><p>When it is time to study offensive security, it is quite common to <strong>download and install test vulnerable Virtual Machines to test some offensive strategies</strong> and I’m quite surprised that most of the online tutorial simply tells you to use Virtual Box (sometimes VmWare workstation), in a very basic way and completely avoid exploring more advanced scenarios.</p><p>While most of these machines are pretty secure (I’m trusting VulnHub machines as an example), <strong>when you do security testing, it is quite risky to use your production environment as front Gun. It could be risky also to use a Virtual Machine if it is on the very same Network of your primary machines.</strong> Sometimes people not accustomed with virtualization think that a VM is confined inside the host, never is far from reality if you simply share your network card. Your VM will be another machine in the very same network of your host.</p><blockquote><p>Using a Virtual Machine sharing the Host NIC is probably not the most secure option.</p></blockquote><p>Using client virtualization can expose you to some less frequent risk due to VM interfere with the host (spectre, meltdown, …) but this is a really less common problem. <strong>My golden rule is, whenever VM downloaded from the internet, or every VM made by me where I&rsquo;m going to install vulnerable products or some malware for analysis should be isolated by my primary network</strong>.</p><p>For this specific reason I&rsquo;ve setup an old server (bough on <a href=http://www.itsco.de>www.itsco.de</a>) and an old workstation as dedicated virtualization environments. I&rsquo;ve two distinct environments because one is running Hyper-V the other is running VmWare ESXi. Clearly <strong>both of them having multiple NIC interfaces</strong>, Hyper-V server has 2 NICs while VmWare has 4 Gigabits NICs.</p><blockquote><p>Having multiple NICs on your virtualization system is the key to have more security while playing around with vulnerable software.</p></blockquote><p>Actually I need to be super honest, if I&rsquo;m <a href="https://www.amazon.it/Practical-Malware-Analysis-Hands-Dissecting-ebook/dp/B007ED2XDS/ref=sr_1_fkmr0_1?__mk_it_IT=%C3%85M%C3%85%C5%BD%C3%95%C3%91&dchild=1&keywords=analyze+malware&qid=1590227303&sr=8-1-fkmr0">playing with something that I deemed to be dangerous</a> I prefer using an old laptop, running linux, connected to the internet through a completely different guest network from my office :).</p><p>Both of those virtualization system are connected to my primary network in two different way, one NIC is connected directly to the managed switch, other NICS are connected to a router then to managed switch. <strong>My Microtik router allows me to isolate that network from my real office and home networks</strong>, the subnet where potentially dangerous machines live is not even routed on my primary network, it can reach only my ISP router to go on the internet if needed.</p><p>The net result is that all machines that lives in that isolated network can communicate between them with no problem, <strong>they can communicate with the internet (updating my kali, communicating with test front gun server, etc)</strong>, but no traffic is allowed to my main network. <strong>Security is going other way around, no machine in my main network can access those machine in isolated network</strong>.</p><p>The only risk is for a VM to use some vulnerability of the CPU to compromise ESXi server (again spectre, meltdown), and from that server trying to compromise other machines. While this is a not so common situation, I’ve configured the router to drop TCP connections that originates from ESXi server to other machines in my work network.</p><p>Since I’m not a super network expert, <strong>this is probably not bulletproof, but it is really better than firing a vulnerable Virtual Machine in production hardware with vmware or VirtualBox</strong>. Also I do not really handle really dangerous material, but as an example, I use a Kali Machine on that network to play with Hack The Box.</p><p>Now only a question remains, if the Isolated Network is Isolated from my production machines, how can I really use those machines? <strong>After all I want to be able not only to run vulnerable machine, but I want also to use a Kali machine on that network segment to exploit that machine)</strong>. Thanks to ESXi I can connect to the cluster from any other computer because ESXi administration site is accessible on my office network, from cluster admin I can start/stop vm and I can use standard Web Interface to interact with the machine, I can even use remote console. That kind of connection is handled by ESXi server and it is like accessing the machine with virtual keyboard and mouse.</p><p><a target=_blank href=../images/kali-isolated-machine.png><img src=../images/kali-isolated-machine.png alt="Accessing VM in isolated network from vmWare Remote conosle"></a></p><p>Figure 1: Accessing VM in isolated network from vmWare Remote conosle</p><p>Thanks to the remote console I can fully interact with machines, it supports live resizing and it is really responsive.</p><p><a target=_blank href=../images/kali-isolated-network-address.png><img src=../images/kali-isolated-network-address.png alt="Isolated machines are deployed in a 10.254.0.0/24 network, isolated from other networks."></a></p><p>Figure 2: Isolated machines are deployed in a 10.254.0.0/24 network, isolated from other networks.</p><p>Issuing a Nmap against my domain controller returns no answer, that network segment is completely unreachable from that machine.</p><p><a target=_blank href=../images/cannot-ping-domain-controller-from-isolated-network.png><img src=../images/cannot-ping-domain-controller-from-isolated-network.png alt="Machines in isolated network cannot contact other machines in the network"></a></p><p>Figure 3: Machines in isolated network cannot contact other machines in the network.</p><p>Microtik router allows me to play with firewall rules and routing to temporary allow some network traffic to flow from some other network machine to the isolated network. As an example <strong>I have some dedicated IPs from the work network that can contact some of the machines in isolated networks if I temporary enable some rules in the router</strong>, actually I almost never used it, but it was an experiment to understand if that is possible.</p><p><a target=_blank href=../images/contact-isolated-machine.png><img src=../images/contact-isolated-machine.png alt="With a specific network rule I can open access from work network to Isolated network for specific IP/port/protocol"></a></p><p>Figure 4: With a specific network rule I can open access from work network to Isolated network for specific IP/port/protocol</p><p>This setup allows me to have a safer environment to experiment with everything that I deemed to be insecure. <strong>While this setup can be time consuming to create, it is really useful because it allows you to experiment with more real scenarios</strong>, especially because you really have different physical network, separated by physical routers, physical NIC, real firewall etc.</p><p>I strongly suggest everyone that really wants to experiment with security to have a similar setup. All I needed was recycle some old hardware, buy some used Intel NIC, a Microtik router and a couple of managed switch and <strong>a good amount of time :)</strong>. ESXi software is free (you have limitation such as you are not able to backup your vm) for Hyper-V I have MSDN license for test, if you do not have license, but <strong>in my opinion ESXi is your primary choice, especially because it is far way better than Hyper-V with virtualized UI running Linux machines</strong>.</p><p>Gian Maria.</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/security/>security</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/security/>security</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before">Leave comment in GitHub discussion page<a target=_blank href=https://github.com/alkampfergit/personal-blog/discussions> alkampfergit/personal-blog/discussions</a></div><div class="prev-entry sep-before"><a href=/post/visualstudio/dotnetcore-run-test-x86/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>How to run x86 Unit Test in a .NET core application</a></div><div class="next-entry sep-before"><a href=/post/azdo/pipeline/release-multiple-build/><span class=screen-reader-text>Next post: </span>Release a product composed by multiple projects and builds<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/alkampfergit target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://twitter.com/alkampfer target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=mailto:alkampfer@nablasoft.com target=_blank rel=noopener><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/gianmariaricci target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2020-2022 Ricci Gian Maria</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script>console.log("this is cookie law");$(document).euCookieLawPopup().init({cookiePolicyUrl:'/privacy/',popupPosition:'top',colorStyle:'default',compactStyle:false,popupTitle:'This website is using cookies',popupText:'By continuing I assume your permission to deploy cookies, as detailed in the Privacy &amp; Cookies Policy.',buttonContinueTitle:'Continue',buttonLearnmoreTitle:'Learn more about this site Privacy &amp; Cookies Policy',buttonLearnmoreOpenInNewWindow:true,agreementExpiresInDays:30,autoAcceptCookiePolicy:false,htmlMarkup:null});</script></body></html>